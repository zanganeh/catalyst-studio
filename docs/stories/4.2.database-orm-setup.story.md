# Story 4.2: Database and ORM Setup

## Status
Approved

## Story
**As a** developer,  
**I want** to set up the database infrastructure and ORM,  
**so that** I have the foundation for all data operations.

## Acceptance Criteria
1. Install and configure chosen ORM (Prisma/Drizzle)
2. Set up SQLite for development in project root
3. Create initial database schema based on audit findings
4. Configure database connection singleton in `/lib/db`
5. Add database initialization to development scripts
6. Verify ORM can connect and perform basic operations

## Tasks / Subtasks
- [ ] Git Setup (REQUIRED FIRST TASK)
  - [ ] Checkout and update develop: `git checkout develop && git pull origin develop`
  - [ ] Create feature branch: `git checkout -b feature/4-2-database-orm-setup`
- [ ] Install and Configure Prisma ORM (AC: 1)
  - [ ] Install Prisma dependencies: `npm install prisma @prisma/client`
  - [ ] Initialize Prisma: `npx prisma init --datasource-provider sqlite`
  - [ ] Configure `.env.local` with DATABASE_URL: `DATABASE_URL="file:./dev.db"`
  - [ ] Add `.env.local` and `dev.db*` to `.gitignore` if not already present
- [ ] Create Initial Database Schema (AC: 3)
  - [ ] Create `prisma/schema.prisma` with models based on architecture:
    - Website model (id, name, description, category, metadata, timestamps)
    - ContentType model (id, websiteId, name, fields, settings, timestamps)
    - ContentItem model (id, contentTypeId, websiteId, data, status, timestamps)
  - [ ] Add relationships between models (Website->ContentTypes, ContentType->ContentItems)
  - [ ] Configure model attributes (@id, @default, @updatedAt, etc.)
- [ ] Set Up Database Client Singleton (AC: 4)
  - [ ] Create `/lib/db/client.ts` with Prisma client singleton pattern
  - [ ] Implement `getClient()` function that returns singleton instance
  - [ ] Add `disconnect()` function for cleanup during hot reload
  - [ ] Handle development vs production connection differences
- [ ] Configure Development Scripts (AC: 5)
  - [ ] Add database scripts to `package.json`:
    - `"db:generate": "prisma generate"`
    - `"db:migrate": "prisma migrate dev"`
    - `"db:seed": "tsx prisma/seed.ts"`
    - `"db:studio": "prisma studio"`
  - [ ] Create basic `prisma/seed.ts` file with sample data structure
  - [ ] Run initial migration: `npm run db:migrate -- --name init`
- [ ] Verify Database Connection (AC: 6)
  - [ ] Create test script `/lib/db/test-connection.ts` to verify Prisma can:
    - Connect to SQLite database
    - Create a test record
    - Read the test record
    - Update the test record
    - Delete the test record
  - [ ] Run test script and verify all CRUD operations work
  - [ ] Ensure `npm run dev` still works without errors
- [ ] Documentation and Cleanup
  - [ ] Document database setup in project README (if needed)
  - [ ] Add comments to client.ts explaining singleton pattern
  - [ ] Verify all new files follow project conventions
- [ ] Submit PR (REQUIRED FINAL TASK)
  - [ ] Push branch: `git push -u origin feature/4-2-database-orm-setup`
  - [ ] Create PR from feature branch â†’ develop branch
  - [ ] PR Title: "Epic 4 Story 2: Database and ORM Setup"
  - [ ] Link PR to story in description

## Dev Notes

### GitFlow Workflow
Branch Name: feature/4-2-database-orm-setup
Base Branch: develop (NOT main)  
PR Target: develop (NOT main)

Git Commands:
1. Setup: `git checkout develop && git pull origin develop`
2. Create: `git checkout -b feature/4-2-database-orm-setup`
3. Commit: Use conventional commits (feat:, fix:, docs:, etc.)
4. Push: `git push -u origin feature/4-2-database-orm-setup`
5. PR: Create PR to develop branch with title "Epic 4 Story 2: Database and ORM Setup"

### Technical Implementation Details

#### ORM Choice: Prisma
[Source: architecture/epic4-architecture.md#new-technology-additions]

Use Prisma as the ORM for the following reasons:
- Type-safe queries with auto-generated TypeScript types
- Automatic migration management
- Reduces boilerplate code significantly
- Excellent developer experience with Prisma Studio

#### Database Configuration
[Source: architecture/epic4-architecture.md#appendix-quick-reference]

Environment variables setup:
```env
# .env.local (development)
DATABASE_URL="file:./dev.db"

# .env.production (future)
DATABASE_URL="postgresql://..."
```

#### Initial Schema Structure
[Source: architecture/epic4-architecture.md#data-models-and-schema-changes]

Create these models in `prisma/schema.prisma`:

```prisma
model Website {
  id          String   @id @default(cuid())
  name        String
  description String?
  category    String
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  contentTypes ContentType[]
  contentItems ContentItem[]
}

model ContentType {
  id        String   @id @default(cuid())
  websiteId String
  name      String
  fields    Json
  settings  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  website      Website       @relation(fields: [websiteId], references: [id])
  contentItems ContentItem[]
}

model ContentItem {
  id           String   @id @default(cuid())
  contentTypeId String
  websiteId    String
  data         Json
  status       String   @default("draft")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  contentType ContentType @relation(fields: [contentTypeId], references: [id])
  website     Website     @relation(fields: [websiteId], references: [id])
}
```

#### Database Client Singleton Pattern
[Source: architecture/epic4-architecture.md#database-client-component]

Create `/lib/db/client.ts` with singleton pattern to manage connections:

```typescript
import { PrismaClient } from '@prisma/client'

// Singleton pattern for Prisma client
declare global {
  var prisma: PrismaClient | undefined
}

export function getClient(): PrismaClient {
  if (!global.prisma) {
    global.prisma = new PrismaClient()
  }
  return global.prisma
}

export async function disconnect(): Promise<void> {
  if (global.prisma) {
    await global.prisma.$disconnect()
  }
}
```

#### Project Structure Integration
[Source: architecture/epic4-architecture.md#source-tree-integration]

New files to create:
- `/lib/db/client.ts` - Database client singleton
- `/lib/db/test-connection.ts` - Connection test script
- `/prisma/schema.prisma` - Database schema
- `/prisma/seed.ts` - Seed data script

These integrate with existing structure without disrupting current functionality.

### Integration Verification Requirements
[Source: epic4-prd.md#story-4.2]

Must verify:
- IV1: Existing app continues to run with `npm run dev`
- IV2: Database setup doesn't interfere with current build process
- IV3: No performance impact on application startup

### Testing Standards
[Source: docs/testing-guide.md]

For this infrastructure story:
- Create test script to verify all CRUD operations
- Manual verification that development server starts without issues
- Ensure no breaking changes to existing functionality
- Use Prisma Studio (`npm run db:studio`) to visually verify database structure

### Important Notes

1. **DO NOT** modify any existing application code in this story
2. This story only sets up infrastructure - no API routes yet
3. The database will be empty except for seed data
4. SQLite file (`dev.db`) should NOT be committed to git
5. All database operations will be implemented in future stories

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-12 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*To be populated during implementation*

### Agent Model Used
*To be populated*

### Debug Log References
*To be populated*

### Completion Notes List
*To be populated*

### File List
*To be populated*

## QA Results
*To be populated during QA review*