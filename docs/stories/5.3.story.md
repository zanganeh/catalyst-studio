# Story 5.3: Content Type Management Tools

## Status
Approved

## Story
**As a** content manager,  
**I want** to manage content types through natural language commands,  
**so that** I can quickly create and modify content structures.

## Acceptance Criteria
1. `list-content-types` retrieves all types with proper filtering
2. `get-content-type` returns detailed type information
3. `create-content-type` adds new types with automatic field inference
4. `update-content-type` modifies existing types safely
5. Category-specific fields added automatically (e.g., SEO for blogs)

## Tasks / Subtasks
- [ ] Git Setup (REQUIRED FIRST TASK)
  - [ ] Continue with existing branch: `git checkout feature/5-2-website-management-tools`
  - [ ] Pull latest changes: `git pull origin feature/5-2-website-management-tools`
- [ ] Create Content Type Tools Directory Structure (AC: 1, 2, 3, 4)
  - [ ] Create `/lib/ai-tools/tools/content-types/` directory
  - [ ] Create `index.ts` for barrel exports
- [ ] Implement list-content-types Tool (AC: 1)
  - [ ] Create `/lib/ai-tools/tools/content-types/list-content-types.ts`
  - [ ] Define tool using Vercel AI SDK pattern with Zod schema
  - [ ] Implement execute function using content-type-service.getContentTypes()
  - [ ] Add filtering support for websiteId parameter
  - [ ] Include parsed fields in response for each content type
  - [ ] Add performance monitoring for <2s requirement
  - [ ] Write unit tests in `__tests__/list-content-types.test.ts`
- [ ] Implement get-content-type Tool (AC: 2)
  - [ ] Create `/lib/ai-tools/tools/content-types/get-content-type.ts`
  - [ ] Define tool with Zod parameter validation (id: string required)
  - [ ] Implement execute function using content-type-service.getContentType()
  - [ ] Return detailed content type with parsed fields
  - [ ] Handle not found cases gracefully
  - [ ] Write unit tests in `__tests__/get-content-type.test.ts`
- [ ] Implement create-content-type Tool (AC: 3, 5)
  - [ ] Create `/lib/ai-tools/tools/content-types/create-content-type.ts`
  - [ ] Define tool with comprehensive Zod schema for content type creation
  - [ ] Implement field inference based on content type name and category
  - [ ] Use business rules engine from Story 5.2 for category-specific fields
  - [ ] Implement execute function using content-type-service.createContentType()
  - [ ] Wrap in Prisma transaction for atomic creation
  - [ ] Add automatic SEO fields for blog category
  - [ ] Add automatic product fields for e-commerce category
  - [ ] Write unit tests including field inference scenarios
- [ ] Implement update-content-type Tool (AC: 4, 5)
  - [ ] Create `/lib/ai-tools/tools/content-types/update-content-type.ts`
  - [ ] Define tool with Zod schema for safe updates
  - [ ] Implement execute function using content-type-service.updateContentType()
  - [ ] Ensure field modifications don't break existing content items
  - [ ] Apply category-specific validation for field updates
  - [ ] Wrap in Prisma transaction for atomic updates
  - [ ] Write unit tests including safety checks
- [ ] Update Tool Registry (AC: 1, 2, 3, 4)
  - [ ] Export all content type tools in `/lib/ai-tools/tools/content-types/index.ts`
  - [ ] Update `/lib/ai-tools/tools/index.ts` to include content type tools
  - [ ] Ensure tools are available in allTools export for chat route
- [ ] Testing and Validation
  - [ ] Write comprehensive unit tests for each tool
  - [ ] Test field inference logic for different categories
  - [ ] Test tool execution performance (<2s requirement)
  - [ ] Verify integration with existing content-type-service
  - [ ] Test transaction rollback on failures
  - [ ] Test category-specific field additions
- [ ] Integration Verification (IV)
  - [ ] IV1: Verify tools integrate with existing ContentTypeService
  - [ ] IV2: Verify no conflicts with manual content type management UI
  - [ ] IV3: Verify existing content types remain accessible and unmodified
- [ ] Submit PR (REQUIRED FINAL TASK)
  - [ ] Push branch: `git push origin feature/5-2-website-management-tools`
  - [ ] Update existing PR with Story 5.3 changes
  - [ ] PR Title remains: "Epic 5: AI-Powered Content Management Tools"
  - [ ] Update PR description to include Story 5.3 completion

## Dev Notes

### GitFlow Workflow
Branch Name: feature/5-2-website-management-tools (CONTINUING EXISTING BRANCH)
Base Branch: main (NOTE: Repository uses 'main' not 'develop')
PR Target: main

Git Commands:
1. Setup: `git checkout feature/5-2-website-management-tools`
2. Pull: `git pull origin feature/5-2-website-management-tools`
3. Commit: Use conventional commits (feat:, fix:, docs:, etc.)
4. Push: `git push origin feature/5-2-website-management-tools`
5. PR: Update existing PR with Story 5.3 implementation

### Technical Architecture Context

**Previous Story Insights** [From Story 5.2]:
- Tool infrastructure successfully implemented with Vercel AI SDK patterns
- Business rules engine created at `/lib/ai-tools/business-rules.ts` with category-specific validation
- Repository uses 'main' branch instead of 'develop'
- Tool executor handles Zod validation and Prisma transactions
- `/lib/ai-tools/tools/index.ts` already exists for tool exports
- Performance monitoring pattern established in website tools
- Transaction support pattern established for atomic operations

**Tool Implementation Pattern** [Source: Story 5.2 implementation]:
```typescript
import { tool } from 'ai';
import { z } from 'zod';

export const toolName = tool({
  description: 'Tool description',
  parameters: z.object({
    param: z.string().describe('Parameter description')
  }),
  execute: async ({ param }) => {
    // Implementation with service calls
  }
});
```

**Service Integration** [Source: architecture/epic-5-architecture.md]:
- Use existing content-type-service at `/lib/services/content-type-service.ts`
- Available methods:
  - `getContentTypes(websiteId?: string)` - Returns ContentTypeWithParsedFields[]
  - `getContentType(id: string)` - Returns single content type or null
  - `createContentType(data: CreateContentTypeRequest)` - Creates new content type
  - `updateContentType(id: string, data: UpdateContentTypeRequest)` - Updates existing
  - `deleteContentType(id: string)` - Deletes content type (not needed for this story)

**Content Type Data Structure** [Source: Prisma schema inferred from service]:
- ContentType model includes: id, websiteId, name, fields (JSON string), settings (JSON string)
- Fields are stored as JSON strings and need parsing
- ContentTypeWithParsedFields type includes parsed field arrays

**Business Rules Integration** [From Story 5.2]:
- Business rules engine at `/lib/ai-tools/business-rules.ts`
- Methods available:
  - `validateForCategory(data, category)` - Apply category rules
  - `getRequiredFields(category, contentType)` - Get mandatory fields
  - `suggestFields(category, purpose)` - Recommend fields based on category

**Category-Specific Field Requirements** [Source: epic-5-architecture.md]:
- **Blog Category**:
  - SEO fields: metaTitle, metaDescription, slug
  - Content fields: title, content, author, publishDate
  - Media fields: featuredImage, tags
- **E-commerce Category**:
  - Product fields: name, description, price, sku
  - Inventory fields: stock, availability
  - Media fields: images, gallery
- **Portfolio Category**:
  - Project fields: title, description, client
  - Media fields: images, showcase
  - Metadata fields: date, category, skills

**File Structure Requirements** [Source: epic-5-architecture.md]:
```
/lib/ai-tools/tools/content-types/
├── list-content-types.ts
├── get-content-type.ts
├── create-content-type.ts
├── update-content-type.ts
├── index.ts (barrel export)
└── __tests__/
    ├── list-content-types.test.ts
    ├── get-content-type.test.ts
    ├── create-content-type.test.ts
    └── update-content-type.test.ts
```

**Transaction Pattern** [From Story 5.2]:
```typescript
import { getClient } from '@/lib/db';

const prisma = getClient();
const result = await prisma.$transaction(async (tx) => {
  // Operations using tx instead of prisma
  return await tx.contentType.create({ ... });
});
```

**Performance Monitoring Pattern** [From Story 5.2]:
```typescript
const startTime = Date.now();
// ... tool execution ...
const executionTime = Date.now() - startTime;
if (executionTime > 2000) {
  console.warn(`Tool execution exceeded 2s: ${executionTime}ms`);
}
```

### Testing Standards

**Test Framework**: Jest with TypeScript
**Test Location**: Create `__tests__` folder within `/lib/ai-tools/tools/content-types/`
**Test Pattern**: Follow existing pattern from website tools tests
**Coverage Target**: 90% for tool functions

**Test Requirements**:
- Mock content-type-service calls
- Test parameter validation with invalid inputs
- Test successful execution paths
- Test error handling and rollback
- Test category-specific field additions
- Test performance monitoring

**Example Test Structure** [From Story 5.2]:
```typescript
import { toolName } from '../tool-name';

jest.mock('@/lib/services/content-type-service');

describe('Tool Name', () => {
  it('should validate parameters', async () => {
    // Test Zod validation
  });
  
  it('should execute successfully', async () => {
    // Test happy path
  });
  
  it('should handle errors gracefully', async () => {
    // Test error scenarios
  });
});
```

### Project Structure Notes
- No conflicts identified with existing structure
- Content type tools follow same pattern as website tools from Story 5.2
- All paths align with architecture document specifications

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-14 | 1.0 | Initial story draft created | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by development agent_

### Debug Log References
_To be populated during implementation_

### Completion Notes List
_To be populated during implementation_

### File List
_To be populated during implementation_

## QA Results
_To be populated by QA agent_