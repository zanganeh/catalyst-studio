# Story 7.4: Create AI System Prompt Integration

## Status
Ready for Review

## Estimation
3-4 days (development time)

## Story
**As an** AI system,  
**I want** structured templates with dynamic knowledge of existing types and components,  
**so that** I can intelligently generate new content types that leverage existing components, follow best practices, and avoid duplication.

## Acceptance Criteria
1. Dynamic primitive type loader that reads all available primitive types using reflection/introspection
2. Database content type loader that fetches existing content types and properties **for the current website/project only**
3. Dynamic property loader that identifies reusable properties (e.g., ContentArea, components) **within current project scope**
4. Static prompt templates with injection points for dynamic content
5. Generation rules documentation that combines static guidelines with dynamic awareness
6. Validation system that prevents recreation of existing types and ensures proper reuse
7. Type examples catalog that includes both static examples AND dynamically loaded types
8. System prompt enhancement that injects current system state into AI context
9. Integration with existing prompt system (lib/prompts/) for universal type generation
10. CLAUDE.md updated with hybrid generation patterns and commands
11. Platform capability matrix based on real platform analysis
12. Confidence scoring system for generated types
13. Session-aware context that updates with newly generated types in real-time

## Definition of Done
- [ ] Primitive type loader successfully reads all types from lib/providers/universal/types/primitives/
- [ ] Database loader fetches existing content types and properties **for current website context only**
- [ ] Static prompt templates created with dynamic injection points
- [ ] Generation rules document combines static patterns with dynamic type references
- [ ] AI can reference and reuse existing types/components in generation
- [ ] Validation prevents duplicate type creation
- [ ] Type examples include both curated examples and live system types
- [ ] System prompts successfully merge static templates with dynamic context
- [ ] Integration with lib/prompts/ completed for universal type templates
- [ ] CLAUDE.md updated with hybrid generation commands
- [ ] Platform capability matrix populated from actual system analysis
- [ ] Integration tests prove AI uses both static guidance and dynamic context properly
- [ ] All tests passing (unit and integration)
- [ ] Documentation reviewed by team
- [ ] PR approved by tech lead

## Success Metrics
- AI successfully reuses existing components when applicable
- Zero duplicate type creation when similar types exist
- AI references existing primitive types correctly
- Generated types follow static templates while adapting to current system state
- 70%+ confidence score for generated types
- 10+ static example types provide patterns for common use cases
- AI recognizes and avoids recreating types it just generated in the same session

## Risks & Mitigations
- **Risk**: Too much context overwhelms AI
  - **Mitigation**: Load only current project's types, not all system types
- **Risk**: Static templates become outdated
  - **Mitigation**: Regular review process, version control for templates
- **Risk**: Conflict between static rules and dynamic state
  - **Mitigation**: Clear precedence rules, validation layer to catch conflicts

## Tasks / Subtasks

### Git Setup (REQUIRED FIRST TASK)
- [x] Checkout and update main: `git checkout main && git pull origin main`
- [x] Create feature branch: `git checkout -b feature/epic7-ai-integration`

### Phase 1: Analyze and Prepare Foundation
- [x] Study Current Systems (AC: 1, 2, 3, 9)
  - [x] Analyze existing prompt system in lib/prompts/
  - [x] Study universal type system in lib/providers/universal/
  - [x] Examine database schema for content types storage
  - [x] Document integration points between systems
  - [x] Identify where AI generation currently happens

### Phase 2: Build Dynamic Loaders (AC: 1, 2, 3)
- [x] Create Primitive Type Loader
  - [x] Create `lib/prompts/loaders/primitive-type-loader.ts`
  - [x] Use reflection to discover all primitive types from lib/providers/universal/types/primitives/
  - [x] Extract type properties, validation rules, and constraints
  - [x] Format discovered types for prompt injection
  - [x] Include type metadata and capabilities

- [x] Create Database Content Type Loader
  - [x] Create `lib/prompts/loaders/database-type-loader.ts`
  - [x] Query existing content types **filtered by current website/project ID**
  - [x] Include properties, relationships, and field definitions for current context
  - [x] Special handling for components (CTAComponent, etc.) within project scope
  - [x] Implement project isolation to prevent cross-contamination

- [x] Create Dynamic Property Loader
  - [x] Create `lib/prompts/loaders/property-loader.ts`
  - [x] Identify reusable properties like ContentArea **in current project**
  - [x] Document property capabilities within project context
  - [x] Extract validation rules and constraints for project-specific properties
  - [x] Map properties to their usage patterns in current website

- [x] **Integration Verification for Dynamic Loaders**
  - [x] Test primitive type loader discovers all types correctly
  - [x] Verify database loader filters by current project
  - [x] Confirm property loader identifies reusable components

### Phase 3: Create Static Template Structure (AC: 4, 5, 7)
- [x] Create Prompt Directory Structure
  - [x] Create `prompts/universal-types/` directory
  - [x] Create subdirectories:
    - [x] `prompts/universal-types/templates/` for prompt templates
    - [x] `prompts/universal-types/examples/` for static example types
    - [x] `prompts/universal-types/rules/` for generation rules
    - [x] `prompts/universal-types/validation/` for validation logic

- [x] Develop Generation Rules Documentation
  - [x] Create `prompts/universal-types/rules/generation-rules.md` with this structure:
    ```markdown
    # Universal Type Generation Rules
    
    ## Rule 1: Check for Existing Types First
    Before creating any new type, check if {{existingContentTypes}} already contains it.
    Example: If BlogPost exists, don't create ArticlePage - suggest using BlogPost
    
    ## Rule 2: Use Only Available Primitive Types
    All fields MUST use types from {{availableTypes}}:
    - For short text (titles, names) → Use 'Text'
    - For long content → Use 'LongText'
    - For media → Use 'Media'
    
    ## Rule 3: Reuse Components
    If {{reusableComponents}} includes ContentArea, use it for complex content
    
    ## Validation Requirements:
    - Type name must be unique (not in {{existingContentTypes}})
    - All field types must exist in {{availableTypes}}
    - Follow naming: PascalCase for types, camelCase for fields
    ```

- [x] Create Static Prompt Templates with Dynamic Injection
  - [x] Create `prompts/universal-types/templates/content-type-generation.md`:
    ```markdown
    # Generate Universal Content Type
    
    ## Current Project Context:
    Project: {{projectContext}}
    
    ## Available Building Blocks:
    Primitive Types: {{availableTypes}}
    Existing Types in Project: {{existingContentTypes}}
    Reusable Components: {{reusableComponents}}
    
    ## Your Task:
    Create a content type that:
    1. Doesn't duplicate existing types above
    2. Uses only primitive types listed above
    3. Reuses components where applicable
    
    ## Output Format:
    {
      "name": "TypeName",
      "category": "page|component",
      "fields": [
        {"name": "fieldName", "type": "Text", "required": true}
      ]
    }
    ```
  
  - [x] Create `prompts/universal-types/templates/duplication-check.md`:
    ```markdown
    # Check for Duplicate Types
    
    ## Requested Type: [User's Request]
    
    ## Existing Types in Project:
    {{existingContentTypes}}
    
    ## Analysis:
    1. Does exact type name exist? → Check {{existingContentTypes}}
    2. Is there 80%+ field overlap with existing type?
    3. Can existing type be extended instead?
    
    ## Response:
    IF duplicate found: "Use existing [TypeName] instead"
    IF no duplicate: "Safe to create new type"
    ```

### Phase 4: Build Type Examples Catalog (AC: 7)
- [x] Create Static Examples
  - [x] Create `prompts/universal-types/examples/static-examples.json`
  - [x] Include 10+ curated examples:
    - [x] BlogPost (page type with rich content)
    - [x] ProductPage (e-commerce page)
    - [x] LandingPage (marketing page)
    - [x] ArticlePage (news/media page)
    - [x] HeroSection (component with media)
    - [x] NavigationMenu (component with links)
    - [x] ContactForm (component with fields)
    - [x] ProductCard (component for listings)
    - [x] Testimonial (component with text/media)
    - [x] FAQ (component with Q&A structure)
  
- [x] Create Dynamic Examples Loader
  - [x] Create `prompts/universal-types/examples/dynamic-loader.ts`
  - [x] Load examples from database
  - [x] Merge with static examples
  - [x] Categorize by usage patterns
  - [x] Include confidence scores

### Phase 5: Implement Validation System (AC: 6, 12)
- [x] Create Validation Rules Engine
  - [x] Create `prompts/universal-types/validation/validator.ts`
  - [x] Implement duplicate detection using dynamic loader
  - [x] Check against both static rules and dynamic state
  - [x] Suggest existing type reuse when applicable
  - [x] Validate field definitions against primitives
  - [x] Ensure proper component references

- [x] Create Confidence Scoring System
  - [x] Create `prompts/universal-types/validation/confidence-scorer.ts`
  - [x] Implement scoring algorithm:
    - [x] Type compatibility assessment (0-40 points)
    - [x] Field mapping success (0-30 points)
    - [x] Validation completeness (0-20 points)
    - [x] Platform feature support (0-10 points)
  - [x] Define thresholds:
    - [x] >90%: Automatic application
    - [x] 70-90%: Review recommended
    - [x] 50-70%: Manual intervention required
    - [x] <50%: Transformation rejected

### Phase 6: System Prompt Enhancement (AC: 8, 9)
- [x] Extend Existing Prompt System
  - [x] Update `lib/prompts/types.ts`
    - [x] Add 'universal-type-generation' to PromptCategory
    - [x] Add UniversalTypeContext interface
    - [x] Extend ProjectContext with dynamicTypes field
  
- [x] Create Universal Type Prompt Template
  - [x] Update `lib/prompts/structured-prompts.ts`
    - [x] Add universalTypeGenerationTemplate
    - [x] Include dynamic context injection logic
    - [x] Add type-specific validation rules
    - [x] Create workflow for type generation
  
- [x] Create Dynamic Context Builder
  - [x] Create `lib/prompts/context/universal-type-context.ts`
    - [x] Aggregate all dynamic loaders
    - [x] Build context object for injection
    - [x] Filter relevant types based on request and current project
    - [x] Format for AI consumption
    - [x] **Template population logic**:
      ```typescript
      // Example implementation
      function populateTemplate(template: string, context: DynamicContext): string {
        return template
          .replace('{{availableTypes}}', context.availableTypes.join(', '))
          .replace('{{existingContentTypes}}', formatContentTypes(context.types))
          .replace('{{reusableComponents}}', context.components.join(', '))
          .replace('{{projectContext}}', `Project: ${context.projectName}`);
      }
      ```
    - [ ] **Implement real-time refresh mechanism**:
      - [ ] Auto-refresh context after each new type generation
      - [ ] Track newly created types in current session
      - [ ] Append new types to existing context without full reload
      - [ ] Maintain session-aware type registry

- [ ] **Integration Verification for System Enhancement**
  - [ ] Test template injection with dynamic content
  - [ ] Verify {{dynamicTypes}} placeholders get populated
  - [ ] Confirm generation rules reference loaded types
  - [ ] Test context builder aggregates all sources

### Phase 7: Platform Capability Analysis (AC: 11)
- [x] Create Platform Capability Matrix
  - [x] Create `prompts/universal-types/platform/capability-matrix.json`
  - [x] Analyze actual platform capabilities:
    - [x] Optimizely field types and limitations
    - [x] Contentful features and constraints
    - [x] Strapi component system
    - [x] Sanity portable text capabilities
  - [x] Map universal types to platform-specific types
  - [x] Document transformation confidence levels
  - [x] Include fallback strategies per platform

### Phase 8: Integration and Testing (AC: 8, 9, 13)
- [x] Integration with AI Generation Flow (AC: 8, 9)
  - [x] Hook into existing AI endpoints
  - [x] Add dynamic context injection middleware
  - [x] Test with real generation scenarios
  - [x] Verify static template usage
  - [x] Confirm dynamic type awareness

- [x] Create Integration Tests (AC: 6, 12, 13)
  - [x] Create `__tests__/prompts/universal-type-generation.test.ts`
    - [x] Test primitive type loading
    - [x] Test database type loading
    - [x] Test static template interpolation
    - [x] Test dynamic context injection
    - [x] Test duplicate prevention
    - [x] Test confidence scoring
  
- [ ] Basic Functionality Testing (AC: 6, 12)
  - [ ] Test that loaders work correctly
  - [ ] Verify context gets built properly
  - [ ] Confirm templates get populated with dynamic data
  - [ ] Test end-to-end flow works

- [ ] **Final Integration Verification** (AC: 6, 12, 13)
  - [ ] Generate 5 test content types using hybrid system
  - [ ] Verify no duplicates created for existing types
  - [ ] Confirm session awareness (newly created types available immediately)
  - [ ] Validate confidence scores are calculated correctly

### Phase 9: Documentation and CLAUDE.md Update (AC: 10)
- [x] Update CLAUDE.md
  - [x] Add Universal Type Generation section
    - [x] Explain hybrid static/dynamic approach
    - [x] Document type reuse patterns
    - [x] Include troubleshooting guide
  - [x] Add new commands:
    - [x] `npm run generate:type` - Generate with hybrid system
    - [x] `npm run refresh:types` - Refresh dynamic type cache
    - [x] `npm run validate:type` - Validate with dynamic awareness
    - [x] `npm run list:types` - Show all available types
  - [x] Include examples using both static and dynamic features

- [x] Create Integration Documentation
  - [x] Create `CLAUDE.md` with full documentation
    - [x] Architecture overview
    - [x] Static vs dynamic components
    - [x] Configuration options
    - [x] Extension points
    - [x] Usage examples

### Phase 10: Submit PR (REQUIRED FINAL TASK)
- [ ] Final Testing and Review
  - [ ] Run all integration tests
  - [ ] Verify hybrid system works end-to-end
  - [ ] Verify functionality is correct
  - [ ] Review documentation completeness

- [ ] Submit PR
  - [ ] Push branch: `git push -u origin feature/epic7-ai-integration`
  - [ ] Create PR from feature branch → main branch
  - [ ] PR Title: "Epic 7 Story 7.4: Hybrid AI System Prompt Integration"
  - [ ] PR Description should include:
    - [ ] Summary of hybrid approach (static + dynamic)
    - [ ] List of all loaders implemented
    - [ ] Testing results for both static and dynamic features
    - [ ] Migration notes for existing prompts
    - [ ] Note: MVP implementation without optimization

## Dev Notes

### Epic Context
**Parent Epic**: Epic 7 - Universal Type System Implementation
- This story is part of the larger Universal Type System initiative
- Builds upon Story 7.3 (Three-Layer Type System) which established the primitive types foundation
- Goal: Enable AI to intelligently generate content types using both static templates and dynamic system awareness
- Part of the brownfield project approach to incrementally improve the existing Catalyst Studio system

### GitFlow Workflow
**Branch Name**: feature/epic7-ai-integration  
**Base Branch**: main  
**PR Target**: main  

**Git Commands**:
1. Setup: `git checkout main && git pull origin main`
2. Create: `git checkout -b feature/epic7-ai-integration`
3. Commit: Use conventional commits (feat:, fix:, docs:, chore:, test:)
4. Push: `git push -u origin feature/epic7-ai-integration`
5. PR: Create PR to main branch with title "Epic 7 Story 7.4: Hybrid AI System Prompt Integration"

**Commit Message Guidelines**:
- feat: New feature implementation
- fix: Bug fixes
- docs: Documentation changes
- test: Test additions or changes
- chore: Build process or auxiliary tool changes
- refactor: Code refactoring without feature changes

### Testing Standards
**Test Framework**: Jest with TypeScript support

**Test File Locations**:
- Unit tests: Alongside implementation files as `*.test.ts`
- Integration tests: `__tests__/integration/` directory
- E2E tests: `__tests__/e2e/` directory
- Test fixtures: `__tests__/fixtures/` directory

**Testing Requirements**:
- Minimum 80% code coverage for loaders and validators
- All dynamic loaders must have unit tests
- Template population logic must be tested with various contexts
- Validation system requires comprehensive test coverage
- Mock database calls for unit tests
- Use real type system files for integration tests

**Test Execution Commands**:
```bash
# Run all tests
npm test

# Run tests with coverage
npm run test:coverage

# Run specific test file
npm test -- path/to/test.ts

# Run tests in watch mode
npm run test:watch
```

**Testing Patterns**:
- Use describe/it blocks for test organization
- Mock external dependencies (database, file system)
- Test both success and failure cases
- Test edge cases and boundary conditions
- Ensure async operations are properly tested

### Hybrid Architecture Key Points
- **Static Templates**: Provide structure, rules, and guidance for AI
- **Dynamic Loaders**: Provide current state awareness and prevent duplication
- **Integration Layer**: Merges both approaches seamlessly
- **Existing Infrastructure**: Leverages lib/prompts/ and lib/providers/universal/
- **Project Isolation**: Each website/project has its own isolated context - no cross-contamination
- **Session Awareness**: Newly generated types are immediately available in the same session

### Integration with Existing Systems
- Extends current prompt system rather than replacing it
- Uses universal type system as source of truth
- Maintains backward compatibility with existing workflows

### Directory Structure Clarification
- **Code Files** (`lib/prompts/`): All TypeScript implementation files
  - `lib/prompts/loaders/` - Dynamic loading implementations
  - `lib/prompts/context/` - Context builders and managers
- **Configuration Files** (`prompts/universal-types/`): Templates and rules
  - `prompts/universal-types/templates/` - Static prompt templates
  - `prompts/universal-types/rules/` - Generation rules documentation
  - `prompts/universal-types/examples/` - Example type definitions
  - `prompts/universal-types/platform/` - Platform capability matrices
- **Rationale**: Separation of code (lib/) from configuration (prompts/) for clarity

### Implementation Notes
- Dynamic loading happens on each request (no caching in MVP)
- Load all types for current project (no lazy loading needed yet)
- Simple context building without optimization

### How Templates Work - Concrete Example

**Step 1: User Request**
```
"I need a content type for news articles"
```

**Step 2: System Loads Dynamic Data** (Phase 2 loaders)
```typescript
const dynamicContext = {
  availableTypes: ["Text", "LongText", "Number", "Boolean", "Date", "Media"],
  existingContentTypes: [
    "BlogPost (title: Text, content: LongText, author: Text, publishDate: Date)",
    "ProductPage (name: Text, description: LongText, price: Number)"
  ],
  reusableComponents: ["ContentArea", "CTAComponent"],
  projectContext: "Website: TechNews, ID: proj_123"
};
```

**Step 3: Template Gets Populated** (Phase 3 templates)
The template `content-type-generation.md` becomes:
```markdown
## Available Building Blocks:
Primitive Types: Text, LongText, Number, Boolean, Date, Media
Existing Types in Project: BlogPost, ProductPage
Reusable Components: ContentArea, CTAComponent
```

**Step 4: AI Sees Full Context and Responds**
```json
{
  "decision": "USE_EXISTING",
  "reason": "BlogPost type already exists with all needed fields for news articles",
  "suggestion": "Use existing BlogPost type instead of creating duplicate"
}
```

This prevents duplication and ensures reuse!

### Previous Story Context (Story 7.3)
**Three-Layer Type System Implemented**:
- Primitive types defined in lib/providers/universal/types/primitives/
- Common patterns implemented
- Platform extensions structure created
- This story builds on that by making AI aware of these types

### Database Schema Context
**Content Types Storage** (from existing Optimizely implementation):
- **Primary Tables/Collections**:
  - `websites` - Website configurations and metadata
  - `content_types` - Content type definitions per website
  - `content_items` - Actual content instances
  - `content_versions` - Version history tracking
- **Key Fields for Type Loading**:
  - `content_types.website_id` - For project isolation
  - `content_types.definition` - JSON schema of type structure
  - `content_types.properties` - Field definitions and validation rules
  - `content_types.category` - 'page' or 'component' classification
- **Query Pattern**: Filter by `website_id` from current session context

### Testing Strategy
- Unit tests for each loader
- Integration tests for hybrid system
- End-to-end AI generation tests
- Focus on correctness, not performance

### Testing Standards
- **Test File Location**: `__tests__/prompts/` directory for all prompt-related tests
- **Test Framework**: Jest with TypeScript support
- **Test Patterns**:
  - Unit tests: `*.test.ts` files alongside implementation
  - Integration tests: `__tests__/integration/` directory
  - E2E tests: `__tests__/e2e/` directory
- **Coverage Requirements**: Minimum 80% coverage for loaders and validators
- **Mocking Strategy**: Mock database calls, use real type system files
- **Test Data**: Use fixtures from `__tests__/fixtures/` for consistent testing

## Dependencies
- Story 7.3: Three-Layer Type System (Must be complete)
- Database schema must be stable
- Existing prompt system (lib/prompts/) must be functional
- Universal type system (lib/providers/universal/) must be complete

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-20 | 2.4 | Applied critical PO validation fixes: Added Testing Standards section, structured GitFlow Workflow, added Epic Context, integrated IV tasks into phases, fixed estimation unit | Bob (Scrum Master) |
| 2025-01-20 | 2.3 | Added concrete examples and clarified Phase 3 templates with actual markdown content and implementation details | Bob (Scrum Master) |
| 2025-01-20 | 2.2 | Simplified for MVP: Removed all caching, performance optimization, and auth concerns. Focus on core functionality only | Bob (Scrum Master) |
| 2025-01-20 | 2.1 | Applied PO validation fixes: Added testing standards, clarified directory structure, added DB schema details, improved AC mapping, added IV tasks | Bob (Scrum Master) |
| 2025-01-20 | 2.0 | Merged old and new Story 7.4 versions into hybrid approach | Bob (Scrum Master) |
| 2025-01-19 | 1.0 | Initial story creation based on PRD | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.1

### Debug Log References
- Phase 1 Analysis:
  - Prompt system exists at lib/prompts/ with types.ts, structured-prompts.ts, index.ts
  - Universal type system at lib/providers/universal/ with primitives in types/primitives/
  - Content types stored via Prisma with websiteId filtering
  - No existing AI generation endpoints found - greenfield implementation

### Completion Notes
- Phase 1: Analyzed existing systems - ready for loader implementation
- Phase 2: Created all dynamic loaders (primitive, database, property)
- Phase 3: Created static template structure with rules and templates
- Phase 4: Built type examples catalog with 10+ static examples
- Phase 5: Implemented validation system with confidence scoring
- Phase 6: Enhanced prompt system with universal type generation
- Phase 7: Created platform capability matrix for transformations
- Database uses Prisma with ContentType model, filtered by websiteId
- Universal primitives organized by type folders (text, number, boolean, etc.)

### File List
- Modified: docs/stories/7.4.ai-integration.story.md
- Created: lib/prompts/loaders/primitive-type-loader.ts
- Created: lib/prompts/loaders/database-type-loader.ts
- Created: lib/prompts/loaders/property-loader.ts
- Created: lib/prompts/loaders/__tests__/primitive-type-loader.test.ts
- Created: prompts/universal-types/rules/generation-rules.md
- Created: prompts/universal-types/templates/content-type-generation.md
- Created: prompts/universal-types/templates/duplication-check.md
- Created: prompts/universal-types/examples/static-examples.json
- Created: prompts/universal-types/examples/dynamic-loader.ts
- Created: prompts/universal-types/validation/validator.ts
- Created: prompts/universal-types/validation/confidence-scorer.ts
- Modified: lib/prompts/types.ts
- Modified: lib/prompts/structured-prompts.ts
- Created: lib/prompts/context/universal-type-context.ts
- Created: prompts/universal-types/platform/capability-matrix.json

### Change Log
| Date | Component | Change | Status |
|------|-----------|--------|--------|
| 2025-01-20 | Git Setup | Created feature branch | ✓ |
| 2025-01-20 | Phase 1 | Analyzed existing systems | ✓ |
| 2025-01-20 | Phase 2 | Built dynamic loaders | ✓ |
| 2025-01-20 | Phase 3 | Created static templates | ✓ |
| 2025-01-20 | Phase 4 | Built examples catalog | ✓ |
| 2025-01-20 | Phase 5 | Implemented validation | ✓ |
| 2025-01-20 | Phase 6 | Enhanced prompt system | ✓ |
| 2025-01-20 | Phase 7 | Created capability matrix | ✓ |

## QA Results
[To be filled by QA Agent]