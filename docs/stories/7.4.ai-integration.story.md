# Story 7.4: Create AI System Prompt Integration

## Status
Draft

## Estimation
2-3 days

## Story
**As an** AI system,  
**I want** clear guidelines and type definitions for content generation,  
**so that** I can create platform-agnostic content types.

## Acceptance Criteria
1. AI system prompt templates created with universal type rules
2. Content type generation examples documented in `prompts/universal-types/`
3. Validation system for AI-generated types with specific rules
4. Metadata structure includes AI generation tracking
5. CLAUDE.md updated with universal type generation patterns
6. System prompts stored in `prompts/universal-types/generation-rules.md`
7. Type examples catalog in `prompts/universal-types/type-examples.json`
8. Platform capability matrix in `prompts/universal-types/platform-mappings.json`

## Definition of Done
- [ ] All prompt templates created and tested
- [ ] 10+ example content types documented
- [ ] Validation rules implemented and functional
- [ ] CLAUDE.md updated with new commands and patterns
- [ ] Platform capability matrix complete for 4 platforms
- [ ] Integration tests passing with AI-generated types
- [ ] Documentation reviewed by team
- [ ] PR approved by tech lead

## Success Metrics
- AI can generate valid types with 70%+ confidence
- 10+ example types cover common use cases
- Validation catches 100% of invalid types
- Generated types successfully transform to Optimizely
- Zero manual intervention needed for high-confidence types

## Risks & Mitigations
- **Risk**: AI generates invalid or incompatible types
  - **Mitigation**: Strict validation rules and confidence scoring
- **Risk**: Prompt templates too restrictive
  - **Mitigation**: Flexible rules with extension points
- **Risk**: Examples don't cover edge cases
  - **Mitigation**: Continuous improvement process for adding examples

## Tasks / Subtasks
- [ ] Git Setup (REQUIRED FIRST TASK)
  - [ ] Checkout and update main: `git checkout main && git pull origin main`
  - [ ] Create feature branch: `git checkout -b feature/epic7-ai-integration`

- [ ] Create Prompt Directory Structure (AC: 2, 6, 7, 8)
  - [ ] Create `prompts/universal-types/` directory
  - [ ] Create subdirectories for organization:
    - [ ] `prompts/universal-types/templates/` for prompt templates
    - [ ] `prompts/universal-types/examples/` for example types
    - [ ] `prompts/universal-types/validation/` for validation rules
    - [ ] `prompts/universal-types/platform/` for platform-specific data
  - [ ] Create `.gitkeep` files in empty directories

- [ ] Develop AI Generation Rules (AC: 1, 6)
  - [ ] Create `prompts/universal-types/generation-rules.md`:
    - [ ] Document three-layer type system usage
    - [ ] Define content type structure requirements
    - [ ] Specify field definition rules
    - [ ] List platform assumption avoidance
    - [ ] Include validation requirements
  - [ ] Add specific sections for:
    - [ ] Primitive type selection guidelines
    - [ ] Common pattern usage criteria
    - [ ] Extension handling instructions
    - [ ] Naming conventions (PascalCase for types, camelCase for fields)
    - [ ] Required vs optional field decisions
    - [ ] Default value recommendations
  - [ ] Include decision trees for:
    - [ ] When to use primitives vs patterns
    - [ ] How to handle complex nested structures
    - [ ] Fallback strategy selection

- [ ] Create Prompt Templates (AC: 1)
  - [ ] Create `prompts/universal-types/templates/content-type-generation.md`:
    - [ ] Template for generating new content types
    - [ ] Include placeholders for requirements
    - [ ] Add validation checkpoints
  - [ ] Create `prompts/universal-types/templates/field-generation.md`:
    - [ ] Template for generating individual fields
    - [ ] Type selection logic
    - [ ] Validation rule generation
  - [ ] Create `prompts/universal-types/templates/migration-assessment.md`:
    - [ ] Template for assessing migration feasibility
    - [ ] Confidence score calculation
    - [ ] Risk identification
  - [ ] Create `prompts/universal-types/templates/validation-check.md`:
    - [ ] Template for validating generated types
    - [ ] Error identification
    - [ ] Correction suggestions

- [ ] Build Type Examples Catalog (AC: 2, 7)
  - [ ] Create `prompts/universal-types/type-examples.json`:
    - [ ] Include 10+ comprehensive examples:
      - [ ] BlogPost (page type with rich content)
      - [ ] ProductPage (e-commerce page)
      - [ ] LandingPage (marketing page)
      - [ ] ArticlePage (news/media page)
      - [ ] HeroSection (component with media)
      - [ ] NavigationMenu (component with links)
      - [ ] ContactForm (component with fields)
      - [ ] ProductCard (component for listings)
      - [ ] Testimonial (component with text/media)
      - [ ] FAQ (component with Q&A structure)
      - [ ] Gallery (component with media collection)
      - [ ] PricingTable (component with structured data)
    - [ ] Each example must include:
      - [ ] Complete type definition
      - [ ] Field specifications
      - [ ] Validation rules
      - [ ] Platform compatibility notes
      - [ ] Transformation confidence scores
  - [ ] Create `prompts/universal-types/examples/README.md`:
    - [ ] Explain example structure
    - [ ] Usage guidelines
    - [ ] How to add new examples

- [ ] Implement Validation Rules (AC: 3)
  - [ ] Create `prompts/universal-types/validation-rules.md`:
    - [ ] Define validation criteria for each type layer
    - [ ] Specify required fields per content type
    - [ ] List naming convention rules
    - [ ] Document structure validation
    - [ ] Include completeness checks
  - [ ] Create `prompts/universal-types/validation/type-validator.ts`:
    - [ ] Implement UniversalTypeValidator class
    - [ ] Add validation methods:
      - [ ] `validateStructure()`: Check type structure
      - [ ] `validateFields()`: Validate field definitions
      - [ ] `validateNaming()`: Check naming conventions
      - [ ] `validateCompleteness()`: Ensure all required elements
      - [ ] `calculateConfidence()`: Generate confidence score
    - [ ] Return detailed validation results
  - [ ] Create validation test cases:
    - [ ] Valid type scenarios
    - [ ] Invalid type scenarios
    - [ ] Edge cases
    - [ ] Platform-specific validations

- [ ] Create Platform Capability Matrix (AC: 8)
  - [ ] Create `prompts/universal-types/platform-mappings.json`:
    - [ ] Define capabilities for Optimizely:
      - [ ] Supported field types
      - [ ] Nesting limitations
      - [ ] Special features
      - [ ] Known restrictions
    - [ ] Define capabilities for Contentful:
      - [ ] Field type mappings
      - [ ] Reference handling
      - [ ] Localization support
      - [ ] API limitations
    - [ ] Define capabilities for Strapi:
      - [ ] Component system
      - [ ] Dynamic zones
      - [ ] Relations support
      - [ ] Plugin ecosystem
    - [ ] Define capabilities for Sanity:
      - [ ] Portable text features
      - [ ] Array handling
      - [ ] Reference system
      - [ ] GROQ query capabilities
  - [ ] Include transformation matrices:
    - [ ] Type conversion mappings
    - [ ] Confidence score calculations
    - [ ] Fallback strategies per platform
    - [ ] Data loss assessments

- [ ] Add AI Generation Metadata (AC: 4)
  - [ ] Create `lib/providers/universal/metadata/ai-tracking.ts`:
    - [ ] Define AIGenerationMetadata interface:
      - [ ] generatedAt: timestamp
      - [ ] generatedBy: AI model/version
      - [ ] prompt: original prompt used
      - [ ] confidence: generation confidence
      - [ ] validationResults: validation outcome
      - [ ] transformations: applied transformations
    - [ ] Implement metadata attachment methods
    - [ ] Create metadata serialization/deserialization
  - [ ] Update UniversalContentType to include AI metadata:
    - [ ] Add optional aiMetadata field
    - [ ] Ensure backward compatibility
    - [ ] Add metadata validation

- [ ] Update CLAUDE.md (AC: 5)
  - [ ] Add Universal Content Type System section:
    - [ ] Usage guidelines for AI
    - [ ] Type generation best practices
    - [ ] Validation requirements
    - [ ] Confidence thresholds
  - [ ] Add new commands section:
    - [ ] `npm run generate:type` - Generate new universal content type
    - [ ] `npm run validate:type` - Validate universal type definition
    - [ ] `npm run transform:type` - Transform between platforms
    - [ ] `npm run confidence:check` - Check transformation confidence score
  - [ ] Include prompt template references:
    - [ ] Link to generation rules
    - [ ] Reference example catalog
    - [ ] Point to validation rules
  - [ ] Add troubleshooting guide:
    - [ ] Common generation errors
    - [ ] Validation failure reasons
    - [ ] Transformation issues
    - [ ] Confidence score interpretation

- [ ] Create Prompt Injection Points (AC: 1)
  - [ ] Create `prompts/universal-types/injection-points.md`:
    - [ ] Define where provider-specific rules inject
    - [ ] Document override mechanisms
    - [ ] Specify priority ordering
  - [ ] Implement injection system in `lib/providers/universal/prompts/injector.ts`:
    - [ ] Load base prompts
    - [ ] Apply provider-specific modifications
    - [ ] Merge rule sets
    - [ ] Handle conflicts

- [ ] Build Confidence Scoring System (AC: 3)
  - [ ] Create `lib/providers/universal/confidence/scorer.ts`:
    - [ ] Implement confidence calculation:
      - [ ] Type compatibility assessment (0-40 points)
      - [ ] Field mapping success (0-30 points)
      - [ ] Validation completeness (0-20 points)
      - [ ] Platform feature support (0-10 points)
    - [ ] Define thresholds:
      - [ ] >90%: Automatic application
      - [ ] 70-90%: Review recommended
      - [ ] 50-70%: Manual intervention required
      - [ ] <50%: Transformation rejected
  - [ ] Create scoring documentation:
    - [ ] Explain scoring algorithm
    - [ ] Provide score interpretation
    - [ ] Include improvement suggestions

- [ ] Implement Continuous Improvement Process (AC: 2)
  - [ ] Create `prompts/universal-types/improvement/tracker.ts`:
    - [ ] Track AI generation attempts
    - [ ] Log success/failure patterns
    - [ ] Identify common issues
    - [ ] Generate improvement reports
  - [ ] Create `prompts/universal-types/improvement/README.md`:
    - [ ] Document improvement process
    - [ ] Explain metrics collection
    - [ ] Describe feedback loop
    - [ ] Include contribution guidelines

- [ ] Add Integration Tests (AC: 3)
  - [ ] Create `prompts/universal-types/__tests__/`:
    - [ ] Test prompt template usage
    - [ ] Test example type validation
    - [ ] Test platform transformations
    - [ ] Test confidence scoring
  - [ ] Create `prompts/universal-types/__tests__/ai-generation.test.ts`:
    - [ ] Simulate AI type generation
    - [ ] Validate generated types
    - [ ] Test transformation to Optimizely
    - [ ] Verify metadata tracking
  - [ ] Create `prompts/universal-types/__tests__/validation.test.ts`:
    - [ ] Test all validation rules
    - [ ] Test edge cases
    - [ ] Test error messages
    - [ ] Test confidence calculations

- [ ] Create Documentation (AC: 2)
  - [ ] Create `prompts/universal-types/README.md`:
    - [ ] Explain directory structure
    - [ ] Document all files and purposes
    - [ ] Provide usage examples
    - [ ] Include contribution guide
  - [ ] Create `docs/ai-integration-guide.md`:
    - [ ] Complete AI integration reference
    - [ ] Step-by-step usage guide
    - [ ] Best practices
    - [ ] Troubleshooting

- [ ] Integration Verification Testing (IV1, IV2, IV3)
  - [ ] Test AI can generate valid universal content types:
    - [ ] Use templates to generate 5 test types
    - [ ] Verify structure compliance
    - [ ] Check field definitions
  - [ ] Test generated types pass validation:
    - [ ] Run UniversalTypeValidator on generated types
    - [ ] Verify all pass with >70% confidence
    - [ ] Document any failures
  - [ ] Test types can be applied to Optimizely:
    - [ ] Transform generated types to Optimizely format
    - [ ] Verify no data loss above threshold
    - [ ] Confirm round-trip accuracy

- [ ] Submit PR (REQUIRED FINAL TASK)
  - [ ] Push branch: `git push -u origin feature/epic7-ai-integration`
  - [ ] Create PR from feature branch â†’ main branch
  - [ ] PR Title: "Epic 7 Story 7.4: Create AI System Prompt Integration"
  - [ ] Link PR to story in description

## Dev Notes

### GitFlow Workflow
Branch Name: feature/epic7-ai-integration
Base Branch: main
PR Target: main

Git Commands:
1. Setup: `git checkout main && git pull origin main`
2. Create: `git checkout -b feature/epic7-ai-integration`
3. Commit: Use conventional commits (feat:, fix:, docs:, etc.)
4. Push: `git push -u origin feature/epic7-ai-integration`
5. PR: Create PR to main branch with title "Epic 7 Story 7.4: Create AI System Prompt Integration"

### Previous Story Context (Story 7.3)
**Three-Layer Type System Implemented**:
- Primitive types defined
- Common patterns implemented
- Platform extensions structure created
- Compatibility matrix built
- Fallback strategies defined

**This story builds on that** by creating AI-specific integration for generating types using the three-layer system.

### AI Integration Architecture

**Prompt Structure** [Source: epic7-prd.md#6.1]:
```
prompts/
  universal-types/
    generation-rules.md      # Core rules
    type-examples.json       # Examples
    validation-rules.md      # Validation
    platform-mappings.json   # Capabilities
```

### Key AI Generation Rules

**Five Core Principles** [Source: epic7-prd.md#6.2]:
1. Default to Three-Layer Type System
2. Use proper Content Type Structure
3. Follow Field Definition Rules
4. Avoid Platform Assumptions
5. Apply Validation Rules

### Validation Requirements

**Confidence Thresholds** [Source: epic7-prd.md#6.2]:
- >70%: Automatic application
- 50-70%: Manual review required
- <50%: Reject transformation

### Example Types Required

Must include at least 10 example types covering:
- Page types (routable content)
- Component types (reusable blocks)
- Various field combinations
- Different complexity levels

### Integration Points

**With Story 7.3 (Type System)**:
- Uses three-layer type definitions
- Leverages compatibility matrix
- Applies fallback strategies

**With Story 7.2 (OptimizelyProvider)**:
- Tests transformation to Optimizely
- Validates platform compatibility

### Testing Requirements

**Validation Coverage**:
- All generation rules tested
- Each example type validated
- Platform transformations verified
- Confidence scoring accuracy confirmed

### Important Considerations

- **AI Model Agnostic**: Templates work with any AI system
- **Extensible**: Easy to add new examples and rules
- **Validated**: All generated types must pass validation
- **Tracked**: Metadata captures generation details

### Dependencies

**Required Before This Story**:
- Story 7.3: Three-Layer Type System (Must be complete)

**Enables Future Stories**:
- Story 7.5: Migration & Transformation Engine
- Story 7.6: Update Application Layer

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-19 | 1.0 | Initial story creation based on PRD | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
[To be filled by Dev Agent]

### Debug Log References
[To be filled by Dev Agent]

### Completion Notes List
[To be filled by Dev Agent]

### File List
[To be filled by Dev Agent]

## QA Results
[To be filled by QA Agent]