# Story 2.6: Database and Configuration Cleanup

## Status
Approved

## Story
**As a** developer,
**I want** to clean up database schema and configuration files,
**so that** we remove all traces of feature flag infrastructure.

## Acceptance Criteria
1. Remove feature flag related columns from database schema
2. Create and run Prisma migration for schema changes
3. Clean up any feature flag data from the database
4. Remove feature flag environment variables from all .env files
5. Update deployment configurations to remove flag references
6. Update any CI/CD scripts that reference feature flags

## Tasks / Subtasks

### Task 1: Verify Database Schema for Feature Flags (AC: 1)
**Note:** Audit found NO database involvement, but we should verify this
- [ ] Check Prisma schema file (`prisma/schema.prisma`)
  - [ ] Search for any feature flag related models
  - [ ] Look for columns that might store feature flags
  - [ ] Document findings (expected: none)
- [ ] Check database directly if accessible
  - [ ] Query for any tables with "feature" or "flag" in name
  - [ ] Verify no feature flag data exists

### Task 2: Database Migration (AC: 2, 3)
**Note:** This task may result in NO ACTION if no database changes needed
- [ ] If feature flag columns/tables found:
  - [ ] Create Prisma migration to remove them
  - [ ] Test migration locally
  - [ ] Document migration steps
- [ ] If NO database changes needed:
  - [ ] Document verification that database is clean
  - [ ] Skip to next task

### Task 3: Clean Up Environment Variables (AC: 4)
- [ ] Remove feature flag environment variables from `.env` files
  - [ ] Check `.env`
  - [ ] Check `.env.local`
  - [ ] Check `.env.development`
  - [ ] Check `.env.production`
  - [ ] Remove any `NEXT_PUBLIC_FEATURE_*` variables
  - [ ] Remove any other feature flag related variables
- [ ] Update `.env.example`
  - [ ] Remove feature flag variable templates
  - [ ] Remove comments about feature flags
  - [ ] Ensure example remains complete for other variables

### Task 4: Update Deployment Configurations (AC: 5)
- [ ] Check Vercel configuration (if using Vercel)
  - [ ] Review `vercel.json` for feature flag references
  - [ ] Check Vercel dashboard environment variables
  - [ ] Remove any feature flag configurations
- [ ] Check Docker configurations (if using Docker)
  - [ ] Review `Dockerfile` for feature flag ENV variables
  - [ ] Check `docker-compose.yml` files
- [ ] Check other deployment platforms
  - [ ] Railway, Netlify, AWS, etc. configurations
  - [ ] Remove feature flag environment variables from platform settings

### Task 5: Update CI/CD Scripts (AC: 6)
- [ ] Check GitHub Actions workflows
  - [ ] Review `.github/workflows/` directory
  - [ ] Remove feature flag environment variables from workflows
  - [ ] Remove any feature flag testing steps
- [ ] Check other CI/CD configurations
  - [ ] GitLab CI, Jenkins, CircleCI configs if present
  - [ ] Remove feature flag references
- [ ] Update build scripts
  - [ ] Check `package.json` scripts for feature flag references
  - [ ] Update any custom build scripts

### Task 6: Remove Stub Files (Cleanup from Story 2.2)
- [ ] Delete `/config/features-stub.ts`
  - [ ] This was temporary for gradual migration
  - [ ] No longer needed after Stories 2.3-2.5
- [ ] Delete `/contexts/feature-flag-context-stub.tsx` if it exists
  - [ ] Also temporary stub file
- [ ] Verify no remaining imports to stub files
  - [ ] Use grep to search for stub file imports
  - [ ] Clean up any found references

### Task 7: Final Configuration Verification (IV1, IV2, IV3)
- [ ] Verify application builds successfully
  - [ ] Run `npm run build`
  - [ ] Ensure no feature flag related warnings
- [ ] Test application startup
  - [ ] Start development server
  - [ ] Verify no missing environment variables
  - [ ] Check console for errors
- [ ] Document all changes made
  - [ ] List all files modified
  - [ ] Note any platform-specific configurations updated

## Dev Notes

### Previous Story Insights
[Source: Stories 2.1-2.5 Completion Notes]
- Story 2.1 audit found **NO database involvement** with feature flags
- Story 2.2 removed core infrastructure and created temporary stub files
- Story 2.3 removed feature flags from all UI components
- Story 2.4 verified no server-side feature flags
- Story 2.5 updated all tests to work without feature flags

### Critical Finding from Audit
[Source: docs/feature-flag-audit.md#Executive Summary]

**Database Impact: NONE** - The feature flag system has:
- No Prisma schema involvement
- No database tables or columns for feature flags
- localStorage-based implementation only (client-side)

This means database-related tasks (AC 1-3) will likely result in verification only, with no actual changes needed.

### Environment Variables to Remove
[Source: Story 2.2 findings]

Look for and remove variables like:
- `NEXT_PUBLIC_FEATURE_*` (any variable starting with this prefix)
- `FEATURE_FLAGS_ENABLED`
- `FF_*` or `FLAG_*` prefixes
- Any variable with "feature" or "flag" in the name

### Configuration File Locations
[Source: architecture.md#Tech Stack]

**Common configuration files to check:**
- **Environment:** `.env`, `.env.local`, `.env.development`, `.env.production`, `.env.example`
- **Deployment:** `vercel.json`, `netlify.toml`, `railway.json`
- **CI/CD:** `.github/workflows/*.yml`, `.gitlab-ci.yml`
- **Docker:** `Dockerfile`, `docker-compose.yml`
- **Build:** `package.json`, `next.config.js`

### Stub Files to Remove
[Source: Story 2.2 Dev Agent Record]

The following stub files were created temporarily and should now be removed:
- `/config/features-stub.ts` - Temporary stub for gradual migration
- `/contexts/feature-flag-context-stub.tsx` - Context stub (if exists)

These were created in Story 2.2 to maintain build stability during migration. With Stories 2.3-2.5 complete, they're no longer needed.

### Testing
[Source: architecture.md#Tech Stack Alignment]

**Verification Commands:**
- Build: `npm run build`
- Dev server: `npm run dev`
- Type checking: `npm run typecheck`
- Linting: `npm run lint`

**Testing Standards for this Story:**
- Ensure no build warnings about missing variables
- Verify application starts without errors
- Check all environments can deploy successfully
- Document any configuration changes for ops team

### Important Notes
1. **Database work likely minimal:** Audit confirmed no database feature flags
2. **Focus on configuration:** Main work is removing environment variables
3. **Platform-specific:** Check deployment platform documentation for env var management
4. **Stub cleanup:** Remove temporary files from Story 2.2

## Integration Verification
- **IV1**: Configuration cleanup completed without breaking application
- **IV2**: Application connects and operates normally with updated configuration
- **IV3**: All environments (dev, staging, prod) work with new configuration

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-11 | 1.0 | Initial story creation based on Epic 2 requirements | Bob (SM) |
| 2025-08-11 | 1.1 | Applied PO feedback: updated IV1 to reflect no database involvement | Bob (SM) |
| 2025-08-11 | 1.2 | Story approved after PO validation (9/10 score) | Sarah (PO) |