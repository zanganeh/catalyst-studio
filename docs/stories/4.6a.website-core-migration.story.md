# Story 4.6a: Website Core Data Migration

## Status
Draft

## Story
**As a** developer,  
**I want** to migrate basic website project data from browser storage to database,  
**so that** website metadata and configuration can be stored persistently on the server.

## Acceptance Criteria
1. Extend Website model in database schema for core website data
2. Implement `/app/api/websites` CRUD endpoints (following Story 4.3 patterns)
3. Create service layer for website operations
4. Replace localStorage website metadata calls with API calls
5. Add React Query hooks for data fetching
6. Verify all website operations work correctly with fresh database

## Tasks / Subtasks
- [ ] Git Setup (REQUIRED FIRST TASK)
  - [ ] Checkout and update develop: `git checkout develop && git pull origin develop`
  - [ ] Create feature branch: `git checkout -b feature/4-6a-website-core-migration`
- [ ] Extend Database Schema (AC: 1)
  - [ ] Update Website model in `prisma/schema.prisma`:
    - Verify existing fields: id, name, description, category, metadata
    - Add `icon` field (String?) for website icon
    - Add `settings` field (JSON?) for website-specific settings
    - Add `isActive` field (Boolean) with default true
  - [ ] Run migration: `npm run db:migrate -- --name extend-website-model`
  - [ ] Update seed data to include sample website
- [ ] Update TypeScript Types (AC: 2)
  - [ ] Extend `/types/api.ts`:
    - Update Website interface with new fields
    - Add WebsiteSettings interface
    - Ensure consistency with Prisma generated types
- [ ] Implement Website API Routes (AC: 2)
  - [ ] Verify `/app/api/websites/route.ts` exists (from Story 4.3):
    - If not, create with GET (list all) and POST (create new)
    - Follow patterns from Story 4.3
  - [ ] Verify `/app/api/websites/[id]/route.ts` exists:
    - If not, create with GET (single), PUT (update), DELETE (soft delete)
    - Add soft delete by setting isActive to false
  - [ ] Use existing error handling from `/lib/api/errors.ts`
  - [ ] Use existing response formatting from `/lib/api/responses.ts`
- [ ] Add Validation Schemas (AC: 2)
  - [ ] Update `/lib/api/validation/website.ts` (from Story 4.3):
    - Add validation for icon field
    - Add validation for settings JSON structure
    - Add validation for isActive boolean
  - [ ] Ensure schema matches TypeScript types
- [ ] Create Website Service Layer (AC: 3)
  - [ ] Create `/lib/services/website-service.ts`:
    - `getWebsites()` - list all active websites
    - `getWebsite(id)` - get single website
    - `createWebsite(data)` - create new website
    - `updateWebsite(id, data)` - update website
    - `deleteWebsite(id)` - soft delete website
    - `getWebsiteSettings(id)` - get website settings
  - [ ] Use Prisma client from `/lib/db/client.ts`
  - [ ] Add proper error handling and logging
- [ ] Create React Query Hooks (AC: 5)
  - [ ] Create `/lib/api/hooks/use-websites.ts`:
    - `useWebsites()` - fetch all websites
    - `useWebsite(id)` - fetch single website  
    - `useCreateWebsite()` - mutation for create
    - `useUpdateWebsite()` - mutation for update
    - `useDeleteWebsite()` - mutation for delete
  - [ ] Set up proper cache invalidation
  - [ ] Add optimistic updates for better UX
- [ ] Update Frontend Integration (AC: 4)
  - [ ] Find website metadata usage in codebase:
    - Search for localStorage.getItem/setItem with website keys
    - Identify components using website data
  - [ ] Update identified components:
    - Replace localStorage calls with React Query hooks
    - Add loading and error states
    - Maintain same UI behavior
  - [ ] Update website context if exists:
    - Check for `/lib/context/website-context.tsx`
    - Update to use API instead of localStorage
- [ ] Testing and Validation (AC: 2, 3, 4, 5, 6)
  - [ ] Create API tests in `/app/api/websites/__tests__/`:
    - Test all CRUD operations
    - Test validation rules
    - Test soft delete behavior
  - [ ] Create service tests in `/lib/services/__tests__/`:
    - Test service methods
    - Mock Prisma client
  - [ ] Manual testing checklist:
    - Clear localStorage test data before testing (no migration needed)
    - Create new website
    - Edit website metadata
    - Delete website (verify soft delete)
    - List all websites
    - Verify UI updates properly
- [ ] Documentation Updates
  - [ ] Update API documentation with website endpoints
  - [ ] Document website service methods
- [ ] Submit PR (REQUIRED FINAL TASK)
  - [ ] Push branch: `git push -u origin feature/4-6a-website-core-migration`
  - [ ] Create PR from feature branch → develop branch
  - [ ] PR Title: "Epic 4 Story 6a: Website Core Data Migration"
  - [ ] Link PR to story in description

## Dev Notes

### GitFlow Workflow
Branch Name: feature/4-6a-website-core-migration
Base Branch: develop (NOT main)  
PR Target: develop (NOT main)

Git Commands:
1. Setup: `git checkout develop && git pull origin develop`
2. Create: `git checkout -b feature/4-6a-website-core-migration`
3. Commit: Use conventional commits (feat:, fix:, docs:, etc.)
4. Push: `git push -u origin feature/4-6a-website-core-migration`
5. PR: Create PR to develop branch with title "Epic 4 Story 6a: Website Core Data Migration"

### Current Implementation Context
[Source: storage-audit-report.md]

Website metadata is currently stored in localStorage with various keys. The WebsiteStorageService uses IndexedDB for larger data, but basic metadata often uses localStorage for quick access.

### Database Schema Extension
[Source: architecture/epic4-architecture.md#website-model, Story 4.2 implementation]

The Website model already exists from Story 4.2:

```prisma
model Website {
  id          String   @id @default(cuid())
  name        String
  description String?
  category    String
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Add these new fields:
  icon        String?
  settings    Json?
  isActive    Boolean  @default(true)
  
  // Existing relations
  contentTypes ContentType[]
  contentItems ContentItem[]
}
```

### API Pattern Reference
[Source: Story 4.3 implementation]

Follow the established patterns:
- Error handling: `/lib/api/errors.ts`
- Response format: `{ data: T } | { error: ErrorType }`
- Validation: Zod schemas in `/lib/api/validation/`
- Routes: `/app/api/[resource]/route.ts` and `/app/api/[resource]/[id]/route.ts`

### React Query Integration
[Source: Stories 4.4 and 4.5 patterns]

Use the same React Query patterns established in previous stories:

```typescript
// Example from Story 4.5
export function useWebsites() {
  return useQuery({
    queryKey: ['websites'],
    queryFn: async () => {
      const response = await fetch('/api/websites');
      if (!response.ok) throw new Error('Failed to fetch websites');
      return response.json();
    }
  });
}
```

### Integration Verification Requirements
[Source: epic4-prd.md#story-4.6]

Must verify:
- IV1: Module functionality unchanged from user perspective
- IV2: No conflicts with previously migrated modules
- IV3: Consistent patterns with other migrated modules

### Dependencies
This story depends on:
- Story 4.2: Database setup (Website model exists)
- Story 4.3: API patterns (established error handling and response formats)
- Story 4.4: React Query setup (may reuse provider setup)
- Story 4.5: May share similar migration patterns

### Testing Standards
[Source: Stories 4.2-4.5 patterns]

**Test Configuration:**
- Test framework: Jest + React Testing Library
- Test file location: `__tests__` folders with `.test.ts` suffix
- Coverage requirement: Maintain existing coverage levels

**Module-Specific Testing Requirements:**
- Test all CRUD operations
- Verify soft delete functionality
- Clear localStorage before testing (no migration needed)
- Mock Prisma client for unit tests
- Use test database for integration tests

### Important Notes

1. **Keep it Simple**: This story focuses only on basic website metadata
2. **Soft Delete Pattern**: Use isActive flag, don't hard delete
3. **No Migration Required**: Clear localStorage test data, start fresh with database
4. **Direct Replacement**: No backward compatibility needed - replace localStorage calls directly
5. **Follow Patterns**: Use established patterns from Stories 4.3-4.5
6. **Asset Handling**: This story only stores asset METADATA (URLs, names, sizes) in JSON fields, NOT actual files. Actual file storage will be handled in a future story (local filesystem or cloud storage)

### Relevant Source Tree
[Source: Current project structure]

```
lib/
├── api/
│   ├── validation/
│   │   └── website.ts          (update from Story 4.3)
│   └── hooks/
│       └── use-websites.ts     (create)
├── services/
│   └── website-service.ts      (create)
app/
└── api/
    └── websites/
        ├── route.ts             (verify/create from Story 4.3)
        └── [id]/
            └── route.ts         (verify/create from Story 4.3)
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-12 | 1.0 | Initial story creation as 4.6 | Bob (Scrum Master) |
| 2025-08-12 | 2.0 | Split into 4.6a for simpler scope | Bob (Scrum Master) |
| 2025-08-12 | 2.1 | Removed migration requirements - no production data to preserve | User Request |

## Dev Agent Record
*To be populated during implementation*

### Agent Model Used
*To be populated*

### Debug Log References
*To be populated*

### Completion Notes List
*To be populated*

### File List
*To be populated*

## QA Results
*To be populated during QA review*