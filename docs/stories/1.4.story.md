# Story 1.4: Create Preview System with Device Switching

## Status
Approved

## Story
**As a** user,
**I want** to preview my website on different devices,
**so that** I can ensure responsive design before deployment.

## Acceptance Criteria
1. Device switcher for desktop, tablet, and mobile views
2. Accurate device frames with proper dimensions
3. Live preview updates within 2 seconds of changes
4. Responsive content rendering within device frames
5. Preview navigation between generated pages

## Integration Verification
- IV1: Preview frames match mockup's visual design
- IV2: Device switching maintains smooth transitions
- IV3: Generated content renders correctly in all device views

## Tasks / Subtasks

### Task 0: Git Setup and Branch Creation
- [x] Create feature branch: `git checkout -b feature/story-1.4-preview-system`
- [x] Push branch to remote: `git push -u origin feature/story-1.4-preview-system`
- [ ] Create draft PR with story link in description
- [ ] Set PR title: "Story 1.4: Create Preview System with Device Switching"

### Task 1: Create Preview System Data Models and Context (AC: 1, 3, 5)
- [x] Create `lib/preview/types.ts` with TypeScript interfaces for device configurations
  - [x] Define DeviceType enum (desktop, tablet, mobile)
  - [x] Create Device interface with dimensions, name, and frame styling
  - [x] Add PreviewState interface for active device, content, and navigation
- [x] Create `lib/context/preview-context.tsx` for managing preview state
  - [x] Implement device switching functionality
  - [x] Add content update methods with change detection
  - [x] Create navigation state management for multi-page previews
  - [x] Integrate with existing ProjectContext from Stories 1.2 and 1.3

### Task 2: Build Preview Frame Component (AC: 2, 4)
- [x] Create `components/preview/preview-frame.tsx` main component
  - [x] Implement iframe-based isolated rendering with sandboxing
  - [x] Add PostMessage API for parent-iframe communication
  - [x] Create device frame wrapper with proper styling
  - [x] Implement responsive scaling for different device sizes
- [x] Create loading skeleton for initial render
- [x] Add error boundary for preview isolation
- [x] Test iframe security and content isolation

### Task 3: Implement Device Selector Component (AC: 1, 2)
- [x] Create `components/preview/device-selector.tsx`
  - [x] Design device button group matching mockup style
  - [x] Add device icons (desktop, tablet, mobile)
  - [x] Implement active state styling
  - [x] Add tooltips with device dimensions
- [x] Create smooth transition animations between devices
- [x] Ensure proper z-index management with other UI elements

### Task 4: Build Preview Content Renderer (AC: 3, 4)
- [x] Create `components/preview/preview-content.tsx`
  - [x] Implement content injection into iframe
  - [x] Add CSS injection for responsive styles
  - [x] Create message handler for parent communication
  - [x] Implement hot reload for content changes
- [x] Add performance optimization with debouncing
- [x] Ensure 2-second update requirement is met
- [x] Test with various content types from Story 1.3

### Task 5: Add Multi-Page Navigation Support (AC: 5)
- [x] Create `components/preview/preview-navigation.tsx`
  - [x] Implement page switcher UI
  - [x] Add breadcrumb navigation
  - [x] Create URL bar display
  - [x] Handle navigation state changes
- [x] Integrate with preview router for isolated routing
- [x] Test navigation between different generated pages
- [x] Ensure navigation state persists during device switches

### Task 6: Implement Device Frame Styling (IV1)
- [ ] Create realistic device frames using CSS
  - [ ] Desktop frame with browser chrome
  - [ ] Tablet frame with bezel and home button
  - [ ] Mobile frame with notch and bezels
- [ ] Match visual design from approved mockup
- [ ] Add subtle shadows and highlights for realism
- [ ] Ensure frames scale properly at different zoom levels

### Task 7: Add Preview Controls and Settings (AC: 3)
- [ ] Create `components/preview/preview-controls.tsx`
  - [ ] Add refresh button for manual reload
  - [ ] Implement zoom controls (50%, 75%, 100%, 125%)
  - [ ] Add fullscreen toggle option
  - [ ] Create copy URL functionality
- [ ] Add keyboard shortcuts for common actions
- [ ] Implement settings persistence in localStorage

### Task 8: Optimize Performance and Animations (IV2, AC: 3)
- [ ] Implement smooth device switching transitions
  - [ ] Use CSS transforms for frame animations
  - [ ] Add opacity transitions for content changes
  - [ ] Ensure 60fps during animations
- [ ] Optimize iframe rendering performance
  - [ ] Implement lazy loading for off-screen content
  - [ ] Add content caching strategy
  - [ ] Use React.memo for preview components
- [ ] Profile and optimize update cycle to stay under 2 seconds

### Task 9: Integration with Main Layout (IV3)
- [ ] Add preview view to main content area in `app/preview/page.tsx`
- [ ] Create route handling for `/preview` path
- [ ] Integrate with navigation sidebar from Story 1.1
- [ ] Ensure proper layout with three-column structure
- [ ] Add feature flag `previewSystem` for gradual rollout
- [ ] Test with existing content from content type builder (Story 1.3)

### Task 10: Testing and Validation
- [ ] Write E2E tests for device switching functionality
- [ ] Test preview updates with various content changes
- [ ] Validate responsive rendering in all device frames
- [ ] Test navigation between pages
- [ ] Performance test with complex content
- [ ] Cross-browser testing (Chrome, Firefox, Safari, Edge)
- [ ] Mobile touch gesture testing for preview interactions

## Dev Notes

### Previous Story Insights
From Story 1.3 completion:
- Drag-and-drop implemented using native HTML5 API instead of external library
- E2E tests with Playwright provide comprehensive coverage
- Feature flag system established and working well
- React Context pattern proven for state management
- Performance optimizations with React.memo effective

### Architecture Context
[Source: architecture.md]

#### Component Architecture
[Source: architecture.md#Component Architecture]

**PreviewFrame Component**
- **Responsibility:** Real-time website preview with device switching
- **Integration Points:** Renders generated React components in isolation
- **Key Interfaces:**
  - `usePreviewState()` - Preview data and device management
  - `DeviceFrame` - Responsive iframe containers
  - `PreviewRouter` - Isolated routing for preview
- **Technology Stack:** iframe with sandboxing, PostMessage API for communication

**New Components Required:**
- DeviceSelector
- PreviewControls
- LoadingSkeleton

#### Data Models
[Source: architecture.md#Data Models - Inferred from requirements]

**Device Configuration Model**
- `type`: DeviceType - desktop, tablet, mobile
- `name`: string - Display name (e.g., "iPhone 14 Pro")
- `width`: number - Device viewport width
- `height`: number - Device viewport height
- `scale`: number - Zoom factor for display
- `frame`: FrameStyle - Visual frame styling

**Common Device Presets**
- Desktop: 1920x1080 (Full HD), 1440x900 (MacBook)
- Tablet: 820x1180 (iPad Air), 768x1024 (iPad Mini)
- Mobile: 393x852 (iPhone 14 Pro), 390x844 (iPhone 12/13), 375x667 (iPhone SE)

**Preview State Model**
- `activeDevice`: DeviceType - Currently selected device
- `content`: string - HTML/React content to render
- `pages`: Page[] - Multiple pages for navigation
- `currentPage`: number - Active page index
- `zoom`: number - Current zoom level
- `settings`: PreviewSettings - User preferences

**PostMessage Protocol**
Messages between parent and iframe:
```typescript
// Parent → iframe
interface PreviewMessage {
  type: 'UPDATE_CONTENT' | 'CHANGE_DEVICE' | 'NAVIGATE' | 'REFRESH';
  payload: {
    content?: string;
    device?: DeviceType;
    page?: number;
    styles?: string;
  };
  timestamp: number;
}

// iframe → Parent
interface PreviewResponse {
  type: 'READY' | 'ERROR' | 'NAVIGATION' | 'LOADED';
  payload: {
    status?: string;
    error?: string;
    currentPage?: number;
  };
  timestamp: number;
}
```

#### Feature Flag Integration
[Source: architecture.md#Feature Flag Architecture]
```typescript
// Feature flag for preview system
previewSystem: boolean;  // Story 1.4
```

The preview system should be wrapped with the feature flag check:
```typescript
function withFeature<P>(
  Component: React.ComponentType<P>,
  featureName: 'previewSystem',
  Fallback?: React.ComponentType<P>
)
```

#### Performance Requirements
[Source: architecture.md#Performance Requirements]
- Preview updates must complete within 2 seconds (NFR3 from PRD)
- Animations should maintain 60fps
- Use CSS transforms for device switching, not JavaScript animations
- Implement debouncing for content updates to prevent excessive renders
- Target render time: <100ms for device switches

#### File Structure
[Source: architecture.md#Project Structure]
Based on established patterns:
```
app/
├── preview/
│   └── page.tsx
components/
├── preview/
│   ├── preview-frame.tsx
│   ├── device-selector.tsx
│   ├── preview-content.tsx
│   ├── preview-navigation.tsx
│   ├── preview-controls.tsx
│   └── device-frames/
│       ├── desktop-frame.tsx
│       ├── tablet-frame.tsx
│       └── mobile-frame.tsx
lib/
├── preview/
│   └── types.ts
└── context/
    └── preview-context.tsx
```

### Testing Standards
[Source: architecture.md#Testing Strategy]

- Test files location: Create tests in `tests/preview-system.spec.ts`
- Use Playwright for E2E testing of device switching and preview updates
- Performance requirement: All preview updates must complete within 2 seconds
- Test with feature flag both enabled and disabled
- Specific test scenarios:
  - Device switching transitions
  - Content update speed
  - Multi-page navigation
  - Iframe isolation and security
  - Responsive rendering accuracy

### Integration Points
- Must integrate with ContentTypeContext from Story 1.3 to preview generated content
- Must work with ProjectContext from Story 1.2 for project state
- Navigation sidebar from Story 1.1 needs preview menu item
- Feature flag system already established - use same pattern
- Error boundary hierarchy must be maintained for preview isolation

### Security Considerations
[Source: architecture.md#Security]
- iframe must use proper sandboxing attributes
- Content injection must be sanitized to prevent XSS
- PostMessage communication must validate origin
- No sensitive data should be passed to preview iframe
- Content Security Policy headers should be configured

### UI/UX Requirements
[Source: PRD and architecture.md]
- Must maintain Catalyst X visual identity from mockup
- Glass morphism effects on device frames (from Story 1.1c)
- Smooth animations with cubic-bezier transitions
- Color palette: #FF5500, #212121, #0077CC, #00AA55
- Inter font family with appropriate weights
- 45-degree geometric patterns where applicable

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-10 | 1.0 | Initial story draft created | Bob (SM) |
| 2025-01-10 | 1.1 | Added device presets and PostMessage protocol per PO feedback | Bob (SM) |

## Dev Agent Record
*To be populated during implementation*

### Agent Model Used
*To be populated during implementation*

### Debug Log References
*To be populated during implementation*

### Completion Notes List
*To be populated during implementation*

### File List
*To be populated during implementation*

## QA Results
*To be populated after QA review*