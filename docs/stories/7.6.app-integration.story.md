# Story 7.6: Update Application Layer & Testing

## Status
Apprved

## Estimation
3 days

## Story
**As a** developer,  
**I want** the application layer to use only the provider interface,  
**so that** the system is truly platform-agnostic.

## Acceptance Criteria
1. All direct Optimizely calls replaced with provider calls
2. Provider injection configured at application bootstrap
3. Mock provider created for testing
4. Integration tests updated for provider pattern
5. Environment configuration for provider selection

## Definition of Done
- [ ] All direct Optimizely API calls removed from application layer
- [ ] Provider interface is the only CMS interaction point
- [ ] Mock provider enables testing without real CMS
- [ ] All existing functionality works identically
- [ ] Provider can be switched via environment variable
- [ ] Integration tests pass with both real and mock providers
- [ ] No performance degradation measured
- [ ] Documentation updated with provider usage
- [ ] PR approved by tech lead

## Success Metrics
- Zero direct CMS references outside provider module
- 100% test coverage with mock provider
- All existing features work unchanged
- Provider switch takes < 5 seconds
- No increase in API response times

## Risks & Mitigations
- **Risk**: Hidden Optimizely dependencies difficult to find
  - **Mitigation**: Systematic search for all Optimizely imports and API calls
- **Risk**: Mock provider behavior differs from real provider
  - **Mitigation**: Comprehensive integration test suite validates both
- **Risk**: Performance overhead from abstraction layer
  - **Mitigation**: Profile critical paths, optimize hot code paths

## Tasks / Subtasks
- [ ] Git Setup (REQUIRED FIRST TASK)
  - [ ] Checkout and update main: `git checkout main && git pull origin main`
  - [ ] Create feature branch: `git checkout -b feature/epic7-6-app-integration`
- [ ] Audit Application Layer for Direct CMS Calls (AC: 1)
  - [ ] Search codebase for all Optimizely imports outside provider
  - [ ] Identify all direct API calls to Optimizely services
  - [ ] Document locations in refactoring checklist
  - [ ] Prioritize by impact and complexity
- [ ] Implement Provider Injection System (AC: 2)
  - [ ] Create `lib/providers/registry/provider-registry.ts`
  - [ ] Implement provider factory pattern
  - [ ] Add provider configuration to app bootstrap
  - [ ] Create provider context for React components
  - [ ] Update `app/layout.tsx` with provider initialization
- [ ] Create Mock Provider (AC: 3)
  - [ ] Implement `lib/providers/mock/mock-provider.ts`
  - [ ] Implement ICMSProvider interface with mock data
  - [ ] Add configurable test data fixtures
  - [ ] Support all provider methods with deterministic responses
  - [ ] Add delay simulation for realistic testing
- [ ] Replace Direct CMS Calls (AC: 1)
  - [ ] Update content type services to use provider interface
  - [ ] Replace API route handlers with provider calls
  - [ ] Update React components to use provider context
  - [ ] Remove all direct Optimizely imports from app layer
  - [ ] Verify no hardcoded CMS references remain
- [ ] Configure Environment-Based Provider Selection (AC: 5)
  - [ ] Add CMS_PROVIDER environment variable
  - [ ] Update `.env.example` with provider options
  - [ ] Implement provider selection logic in registry
  - [ ] Add fallback to mock provider for development
  - [ ] Document configuration in README
- [ ] Update Integration Tests (AC: 4)
  - [ ] Create test harness with provider injection
  - [ ] Update existing tests to use mock provider
  - [ ] Add provider-specific test suites
  - [ ] Test provider switching functionality
  - [ ] Verify identical behavior with both providers
- [ ] Performance Validation
  - [ ] Profile application with provider abstraction
  - [ ] Compare response times before/after refactor
  - [ ] Optimize any performance bottlenecks
  - [ ] Document performance characteristics
- [ ] Submit PR (REQUIRED FINAL TASK)
  - [ ] Push branch: `git push -u origin feature/epic7-app-integration`
  - [ ] Create PR from feature branch → main branch
  - [ ] PR Title: "Epic 7 Story 6: Update Application Layer & Testing"
  - [ ] Link PR to story in description

## Dev Notes

### GitFlow Workflow
Branch Name: feature/epic7-app-integration
Base Branch: main
PR Target: main

Git Commands:
1. Setup: `git checkout main && git pull origin main`
2. Create: `git checkout -b feature/epic7-app-integration`
3. Commit: Use conventional commits (feat:, fix:, docs:, etc.)
4. Push: `git push -u origin feature/epic7-app-integration`
5. PR: Create PR to main branch with title "Epic 7 Story 6: Update Application Layer & Testing"

### Previous Story Insights
[Source: Story 7.4 Dev Agent Record]

Story 7.4 successfully implemented the AI integration layer with:
- Dynamic type loading system in `lib/services/universal-types/`
- Universal type context builder with session awareness
- Integration tests in `__tests__/prompts/universal-type-generation.test.ts`
- Platform capability matrix for type transformations

The provider interface from earlier stories (7.1-7.3) is now stable and ready for application layer integration.

### Architecture Context
[Source: docs/epic7-architecture.md]

#### Provider Registry Pattern
The provider registry manages provider instances and selection:
```typescript
interface IProviderRegistry {
  register(provider: ICMSProvider): void;
  getProvider(id?: string): ICMSProvider;
  setDefault(id: string): void;
}
```

#### ICMSProvider Interface
[Source: Story 7.1 implementation]
All providers must implement this interface:
```typescript
interface ICMSProvider {
  id: string;
  getContentTypes(): Promise<UniversalContentType[]>;
  createContentType(type: UniversalContentType): Promise<void>;
  updateContentType(id: string, type: UniversalContentType): Promise<void>;
  deleteContentType(id: string): Promise<void>;
  // ... additional methods
}
```

#### Application Layer Integration Points
[Source: Current codebase analysis]

Key files requiring refactoring:
- `lib/services/content-type-service.ts` - Direct Optimizely calls
- `app/api/content-types/route.ts` - API handlers with CMS logic
- `components/content-builder/*.tsx` - Components with CMS dependencies
- `lib/stores/content-store.ts` - State management with CMS data

#### Mock Provider Requirements
The mock provider should:
- Return consistent test data for all methods
- Support configurable responses for different test scenarios
- Simulate network delays (optional)
- Track method calls for test assertions
- Provide reset functionality between tests

### Testing Standards
[Source: docs/epic7-architecture.md#testing-strategy]

- **Framework:** Jest 30.0.5 for unit tests, Playwright for E2E
- **Location:** Tests co-located in `__tests__` folders
- **Coverage Target:** 90% for provider-related code
- **Mock Strategy:** Use mock provider for all unit tests
- **Integration Tests:** Test with both real and mock providers
- **Pattern:** Follow existing test patterns from codebase

Example test structure:
```typescript
describe('Application with Provider', () => {
  beforeEach(() => {
    registry.register(new MockProvider());
    registry.setDefault('mock');
  });

  it('should work with mock provider', async () => {
    // Test implementation
  });
});
```

### Important Implementation Notes

1. **Provider Injection Strategy:**
   - Use React Context for component-level access
   - Dependency injection for service-level access
   - Environment variable for provider selection
   - Fallback chain: ENV → Config → Mock

2. **Refactoring Approach:**
   - Start with least critical components
   - Maintain parallel old/new code paths initially
   - Use feature flags if needed for gradual rollout
   - Remove old code only after validation

3. **Common Pitfalls to Avoid:**
   - Don't leak provider-specific types to app layer
   - Ensure mock provider matches real provider behavior exactly
   - Avoid tight coupling between providers and app logic
   - Keep provider interface minimal and focused

4. **Performance Considerations:**
   - Cache provider instances (singleton pattern)
   - Lazy load providers to reduce startup time
   - Use connection pooling for API calls
   - Profile before and after to ensure no regression

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-21 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
[To be filled by Dev Agent]

### Debug Log References
[To be filled by Dev Agent]

### Completion Notes List
[To be filled by Dev Agent]

### File List
[To be filled by Dev Agent]

## QA Results
[To be filled by QA Agent]