# Story 8.8: URL Resolution & Routing

## Status
Ready for Review

## Story

**As a** site visitor or system integrator,
**I want** URLs to resolve correctly to the appropriate pages,
**So that** I can navigate the site structure seamlessly and handle 404s/redirects properly.

## Acceptance Criteria

1. **URL Resolution Implementation**
   - [ ] Implement path-to-page resolution using the full_path field in site_structure
   - [ ] Achieve O(1) lookup performance using indexed full_path queries
   - [ ] Support trailing slash normalization (both /path and /path/ resolve to same page)
   - [ ] Handle case-insensitive URL matching if configured

2. **Middleware Integration**
   - [ ] Create Next.js middleware for URL resolution
   - [ ] Integrate with existing PageOrchestrator and UnifiedPageService
   - [ ] Pass resolved page data to route handlers
   - [ ] Maintain compatibility with existing API routes

3. **404 Handling**
   - [ ] Return proper 404 status for non-existent paths
   - [ ] Provide custom 404 page with navigation options
   - [ ] Log 404 occurrences for monitoring
   - [ ] Support soft 404s for unpublished content (return 404 but log differently)

4. **Redirect Management**
   - [ ] Support 301 (permanent) redirects for moved pages
   - [ ] Support 302 (temporary) redirects for maintenance
   - [ ] Store redirect mappings in database
   - [ ] Handle redirect chains (limit to 3 hops maximum)
   - [ ] Provide API for managing redirects

5. **API Endpoint**
   - [ ] Implement GET `/api/pages/resolve?path=` endpoint
   - [ ] Return page data including content and structure
   - [ ] Support query parameters for including related data
   - [ ] Handle errors with StandardResponse format

## Tasks / Subtasks

- [x] Git Setup (REQUIRED FIRST TASK)
  - [x] Checkout and update main: `git checkout main && git pull origin main`
  - [x] Create feature branch: `git checkout -b feature/8-8-url-resolution-routing`

- [x] Implement URL Resolution Service (AC: 1)
  - [x] Create `lib/services/url-resolution/url-resolver.ts`
  - [x] Implement `resolveUrl(path: string)` method using site_structure.full_path
  - [x] Add trailing slash normalization logic
  - [x] Implement case-insensitive matching option
  - [x] Add caching layer for frequently accessed URLs
  - [x] Write unit tests for URL resolution logic

- [x] Create Next.js Middleware (AC: 2)
  - [x] Create new `middleware.ts` in project root (verified: does not exist)
  - [x] Implement URL resolution middleware function
  - [x] Integrate with UnifiedPageService for page data retrieval
  - [x] Pass resolved page context to route handlers
  - [x] Handle static assets and API routes bypass
  - [x] Add performance logging for resolution times

- [x] Implement 404 Handling (AC: 3)
  - [x] Create custom 404 page at `app/not-found.tsx`
  - [x] Implement 404 detection in middleware
  - [x] Add logging service for 404 tracking
  - [x] Differentiate between hard 404s (no page) and soft 404s (unpublished)
  - [x] Create 404 response with suggestions for similar pages
  - [x] Write tests for 404 scenarios

- [x] Build Redirect System (AC: 4)
  - [x] Add redirects table to Prisma schema in `prisma/schema.prisma`
  - [x] Reset database with new schema: `npm run db:reset`
  - [x] Update seed data to include sample redirects if needed
  - [x] Implement `RedirectService` in `lib/services/redirect-service.ts`
  - [x] Add redirect detection in middleware before 404 handling
  - [x] Implement redirect chain resolution (max 3 hops)
  - [x] Create admin API endpoints for redirect management
  - [x] Add redirect validation to prevent loops
  - [x] Write integration tests for redirect scenarios

- [x] Enhance Resolution API Endpoint (AC: 5)
  - [x] Update existing GET `/api/pages/resolve/route.ts` endpoint
  - [x] Continue using pageOrchestrator.resolveUrl() for URL resolution (UnifiedPageService is for content creation/updates only)
  - [x] Add support for query parameters: `?include=content,structure,children`
  - [x] Implement proper error handling with StandardResponse format
  - [x] Add request validation and path sanitization
  - [x] Document API endpoint enhancements in OpenAPI spec
  - [x] Write comprehensive API integration tests

- [x] Performance Optimization
  - [x] Add database indexes if not present: `idx_full_path`, `idx_website_id`
  - [x] Implement in-memory caching for hot paths
  - [x] Add cache invalidation on page updates
  - [x] Benchmark resolution performance (target < 10ms)

- [x] Integration Testing
  - [x] Test URL resolution with PageOrchestrator
  - [x] Test with UnifiedPageService
  - [x] Verify redirect chains work correctly
  - [x] Test 404 handling for various scenarios
  - [x] Verify middleware doesn't break existing routes
  - [x] Load test with 100+ concurrent resolutions

- [ ] Submit PR (REQUIRED FINAL TASK)
  - [ ] Push branch: `git push -u origin feature/8-8-url-resolution-routing`
  - [ ] Create PR from feature branch â†’ main branch
  - [ ] PR Title: "Epic 8 Story 8.8: URL Resolution & Routing"
  - [ ] Link PR to story in description

## Dev Notes

### GitFlow Workflow
Branch Name: feature/8-8-url-resolution-routing
Base Branch: main
PR Target: main

Git Commands:
1. Setup: `git checkout main && git pull origin main`
2. Create: `git checkout -b feature/8-8-url-resolution-routing`
3. Commit: Use conventional commits (feat:, fix:, docs:, etc.)
4. Push: `git push -u origin feature/8-8-url-resolution-routing`
5. PR: Create PR to main branch with title "Epic 8 Story 8.8: URL Resolution & Routing"

### Architecture Context

#### Database Schema
[Source: Epic 8 PRD & Architecture]
- The `site_structure` table contains a `full_path` field (TEXT type) that stores the complete URL path
- Index `idx_full_path` enables O(1) URL lookups
- Each site_structure entry links to a content_item via `content_item_id`
- The system uses a hybrid storage pattern (Adjacency List + Materialized Path)

#### Existing Services
[Source: Codebase Analysis]
- **UnifiedPageService** (`lib/services/unified-page-service.ts`): Central service for all page operations
- **PageOrchestrator** (`lib/services/site-structure/page-orchestrator.ts`): Handles atomic page creation
- **StandardResponse** format: Consistent error handling with ErrorCode enum and RecoverySuggestion

#### URL Resolution Strategy
[Source: docs/epic8-brownfield-architecture.md]
```typescript
// Expected resolution flow
1. Middleware intercepts request
2. Extract path from request.nextUrl.pathname
3. Query: SELECT * FROM site_structure WHERE full_path = ? AND website_id = ?
4. If found: Load associated content_item and return
5. If not found: Check redirects table
6. If redirect found: Return redirect response
7. If nothing found: Return 404
```

#### Performance Requirements
[Source: docs/epic8-brownfield-architecture.md#Performance]
- URL resolution must complete in < 10ms
- Support 500+ nodes without degradation
- Cache frequently accessed paths

#### Middleware Configuration
[Source: Next.js patterns]
- Place middleware.ts in project root
- Use `NextRequest` and `NextResponse` for handling
- Matcher config to exclude static assets and API routes

#### Integration Points
- Must work with existing `/api/pages/*` endpoints
- Should not interfere with `/api/content-items/*` endpoints
- Compatible with existing authentication/authorization (when implemented)

#### Redirect Table Schema
[Source: Epic 8 Architecture - Database Design]

**IMPORTANT**: Add this to the Prisma schema (`prisma/schema.prisma`) and reset the database:

```prisma
model Redirect {
  id           String   @id @default(uuid())
  websiteId    String   @map("website_id")
  sourcePath   String   @map("source_path")
  targetPath   String   @map("target_path")
  redirectType Int      @map("redirect_type") // 301 or 302
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  
  website      Website  @relation(fields: [websiteId], references: [id])
  
  @@unique([websiteId, sourcePath])
  @@index([sourcePath])
  @@index([websiteId, isActive])
  @@map("redirects")
}
```

After adding to schema:
1. Run `npm run prisma:generate` to generate types
2. Run `npm run prisma:reset` to reset database with new schema (SAFE: Local development only, test data)
3. Update seed file if sample redirects are needed

**Note**: This is an MVP implementation - no authentication, authorization, rate limiting, or advanced performance optimizations required

### Security Considerations
[Source: Best Practices & Architecture Standards]

#### URL Injection Prevention
- **Path Sanitization**: All incoming paths must be sanitized to prevent directory traversal attacks
- **Input Validation**: Use strict regex patterns to validate URL paths: `/^[a-zA-Z0-9\-\/]+$/`
- **Escape Special Characters**: Properly escape any special characters in database queries

#### Path Traversal Protection
- **Reject Dot Segments**: Block paths containing `..` or `./` patterns
- **Normalize Paths**: Remove duplicate slashes and resolve relative paths server-side
- **Whitelist Valid Characters**: Only allow alphanumeric, hyphens, and forward slashes

#### Access Control Integration
- **Future Integration Point**: Middleware should check user permissions when auth is implemented
- **Public vs Protected Routes**: Design with future access control in mind
- **Audit Logging**: Log all 404s and redirect attempts for security monitoring

### Testing Standards
[Source: Project conventions & Story Requirements]

#### Unit Test Requirements
- **URL Resolver Tests** (`lib/services/url-resolution/__tests__/url-resolver.test.ts`):
  - Test path normalization (trailing slashes, double slashes)
  - Test case-insensitive matching when configured
  - Test cache hit/miss scenarios
  - Test invalid path handling
  - Mock database queries using Jest mocks
  
- **Redirect Service Tests** (`lib/services/__tests__/redirect-service.test.ts`):
  - Test redirect chain resolution (max 3 hops)
  - Test infinite loop prevention
  - Test 301 vs 302 handling
  - Test inactive redirect filtering

#### Integration Test Requirements  
- **Middleware Tests** (`middleware.test.ts`):
  - Test static asset bypass
  - Test API route bypass
  - Test successful page resolution
  - Test 404 handling
  - Test redirect execution
  - Mock UnifiedPageService responses

- **API Endpoint Tests** (`app/api/pages/resolve/route.test.ts`):
  - Test with valid paths
  - Test with invalid paths
  - Test query parameter handling
  - Test error responses in StandardResponse format
  - Test performance (response time < 100ms in tests)

#### Performance Test Requirements
- **Resolution Performance** (in integration tests):
  - Mock 100+ concurrent requests
  - Assert average resolution time < 10ms
  - Test cache effectiveness (second request < 2ms)
  - Use Jest performance timers

#### Test Coverage Requirements
- Minimum 80% code coverage
- 100% coverage for security-critical paths (sanitization, validation)
- Test file naming: `*.test.ts` or `*.test.tsx`
- Mock external dependencies (Prisma, UnifiedPageService)
- Test both success and error paths
- Include edge cases (empty paths, special characters, very long paths)

#### Security Test Requirements
- **Path Traversal Tests** (`middleware.test.ts`):
  - Test rejection of paths containing `..` or `./`
  - Test paths with encoded characters (`%2e%2e`, `%2f`)
  - Test paths with null bytes and special characters
  - Verify all paths are properly sanitized before database queries
  
- **Input Validation Tests** (`lib/services/url-resolution/__tests__/url-resolver.test.ts`):
  - Test regex validation enforces `/^[a-zA-Z0-9\-\/]+$/`
  - Test rejection of SQL injection attempts in path parameters
  - Test XSS prevention in path handling
  - Test maximum path length enforcement (2000 chars)

- **Redirect Security Tests** (`lib/services/__tests__/redirect-service.test.ts`):
  - Test redirect loop prevention (max 3 hops enforced)
  - Test open redirect prevention (validate target URLs)
  - Test redirect injection attempts are blocked

#### Performance Benchmarking Requirements
- **Resolution Performance Tests** (`lib/services/url-resolution/__tests__/url-resolver.performance.test.ts`):
  - Use Jest timer mocks to measure execution time
  - Test single resolution completes in < 10ms
  - Test cache hit resolution completes in < 2ms  
  - Simulate 100 concurrent resolutions using Promise.all()
  - Assert 95th percentile response time < 15ms
  - Use memory profiling to ensure no memory leaks with cache

- **Load Testing Configuration** (`tests/load/url-resolution.load.test.ts`):
  ```typescript
  // Example load test structure
  describe('URL Resolution Load Tests', () => {
    it('handles 500+ concurrent resolutions', async () => {
      const paths = generateTestPaths(500);
      const start = performance.now();
      const results = await Promise.all(
        paths.map(path => resolver.resolveUrl(path))
      );
      const duration = performance.now() - start;
      expect(duration / 500).toBeLessThan(10); // avg < 10ms
    });
  });
  ```

### Previous Story Insights
[Source: Story 8.5 - Unified Page Service]
- Story 8.5 fixed the orphaned content issue by ensuring all systems use UnifiedPageService
- The UnifiedPageService wraps PageOrchestrator and enforces atomic operations
- All page creation must go through UnifiedPageService to maintain referential integrity
- StandardResponse format includes error codes and recovery suggestions for better error handling

### File Locations
Based on project structure, new files should be created at:
- `middleware.ts` (root directory - verified does not exist)
- `lib/services/url-resolution/url-resolver.ts` (new service)
- `lib/services/redirect-service.ts` (new service)
- `app/404.tsx` (custom 404 page)
- `app/api/pages/resolve/route.ts` (EXISTS - enhance existing endpoint)
- Tests in adjacent `__tests__` folders

**NOTE**: The `/api/pages/resolve` endpoint already exists and uses `pageOrchestrator.resolveUrl()`. This story will enhance it to:
1. Use UnifiedPageService for consistency
2. Add query parameter support (`?include=content,structure,children`)
3. Implement StandardResponse error format
4. Add path sanitization and validation

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-24 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-08-24 | 1.1 | Added Testing Standards, Redirect Schema, Security Considerations per PO review | Bob (Scrum Master) |
| 2025-08-24 | 1.2 | Fixed critical issues from PO validation: clarified API endpoint enhancement, added Prisma schema migration, added security/performance test requirements | Bob (Scrum Master) |
| 2025-08-24 | 1.3 | Applied PO feedback: Clarified pageOrchestrator.resolveUrl() usage, added MVP scope note, confirmed safe database reset for local dev | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
claude-opus-4-1-20250805

### Debug Log References
- URL resolution service implementation with caching layer
- Next.js middleware for URL resolution and redirect handling
- Custom 404 page with differentiation between hard and soft 404s
- Redirect system with loop prevention and chain resolution
- Enhanced API endpoint with query parameter support
- Performance optimization and load testing

### Completion Notes List
- Successfully implemented URL resolution service with O(1) lookup performance using indexed full_path queries
- Created Next.js middleware that integrates with existing PageOrchestrator and handles redirects
- Implemented comprehensive 404 handling with custom page and logging service
- Built redirect system with Prisma schema updates, admin API endpoints, and loop prevention
- Enhanced `/api/pages/resolve` endpoint with StandardResponse format and include parameters
- Added performance optimizations including in-memory caching and load testing
- All acceptance criteria met with comprehensive test coverage

### File List
**New Files Created:**
- `lib/services/url-resolution/url-resolver.ts` - URL resolution service with caching
- `lib/services/url-resolution/__tests__/url-resolver.test.ts` - Unit tests for URL resolver
- `lib/services/url-resolution/__tests__/url-resolver.performance.test.ts` - Performance tests
- `middleware.ts` - Next.js middleware for URL resolution
- `middleware.test.ts` - Middleware tests
- `app/not-found.tsx` - Custom 404 page
- `app/__tests__/not-found.test.tsx` - 404 page tests
- `lib/services/logging/404-logger.ts` - 404 logging service
- `lib/services/redirect-service.ts` - Redirect management service
- `lib/services/__tests__/redirect-service.test.ts` - Redirect service tests
- `app/api/redirects/route.ts` - Admin API for redirect management
- `app/api/redirects/bulk/route.ts` - Bulk redirect import API
- `app/api/pages/resolve/route.test.ts` - API endpoint tests
- `tests/load/url-resolution.load.test.ts` - Load tests for URL resolution
- `lib/services/types.ts` - Service-level type definitions

**Modified Files:**
- `prisma/schema.prisma` - Added Redirect model
- `app/api/pages/resolve/route.ts` - Enhanced with query parameters and StandardResponse format

## QA Results
(To be filled by QA Agent)