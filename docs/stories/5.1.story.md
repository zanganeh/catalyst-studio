# Story 5.1: Foundation - Tool Infrastructure and Context Provider

## Status
Approved

## Story
**As a** developer,  
**I want** to establish the core AI tool execution infrastructure,  
**so that** subsequent stories can build on a solid foundation.

## Acceptance Criteria
1. `/lib/ai-tools/` directory structure created with proper organization (NOTE: Architecture confirms `/lib/ai-tools/` not `/app/api/ai-tools/` as these are server functions, not API endpoints)
2. Base tool executor implemented with Zod validation and error handling
3. Context provider loads website metadata and content structures in <500ms
4. Vercel AI SDK integrated with OpenRouter API configuration
5. Streaming response handler implemented for real-time updates

## Tasks / Subtasks
- [ ] Git Setup (REQUIRED FIRST TASK)
  - [ ] Checkout and update develop: `git checkout develop && git pull origin develop`
  - [ ] Create feature branch: `git checkout -b feature/5-1-ai-tool-infrastructure`
- [ ] Create AI Tools Directory Structure (AC: 1)
  - [ ] Create `/lib/ai-tools/` directory
  - [ ] Create `/lib/ai-tools/tools/` subdirectory for tool definitions
  - [ ] Create `/lib/ai-tools/context/` subdirectory for context providers
  - [ ] Create `/lib/ai-tools/executor/` subdirectory for execution logic
  - [ ] Create `/lib/ai-tools/index.ts` for exporting all tools
- [ ] Implement Base Tool Executor (AC: 2)
  - [ ] Create `/lib/ai-tools/executor/tool-executor.ts` with TypeScript interfaces
  - [ ] Implement `executeTool(name, params)` method with Zod validation
  - [ ] Implement `executeMultipleTools(tools)` for chaining operations
  - [ ] Add error handling with proper error types and rollback support
  - [ ] Implement transaction wrapper using Prisma.$transaction API
- [ ] Implement Context Provider (AC: 3)
  - [ ] Create `/lib/ai-tools/context/context-provider.ts`
  - [ ] Implement `loadWebsiteContext(websiteId)` using WebsiteService
  - [ ] Implement `loadContentStructure(websiteId)` using ContentTypeService
  - [ ] Implement `getBusinessRules(websiteType)` stub method (actual rules will be defined in Story 5.2+)
  - [ ] Add performance monitoring to ensure <500ms load time
  - [ ] Implement context pruning helper for token management
- [ ] Enhance Chat Route with Tools (AC: 4, 5)
  - [ ] Import tool definitions in `/app/api/chat/route.ts`
  - [ ] Add `tools` parameter to existing streamText call
  - [ ] Add `toolChoice: 'auto'` to let AI decide when to use tools
  - [ ] Add `maxSteps: 5` to enable multi-step operations
  - [ ] Add optional `onStepFinish` callback for logging tool executions
  - [ ] Test streaming response continues to work with tools
- [ ] Create Foundation Tools (AC: 1, 2)
  - [ ] Create `/lib/ai-tools/tools/index.ts` to export all tools
  - [ ] Define tool interfaces following Vercel AI SDK pattern
  - [ ] Create placeholder tools for testing (will be implemented in later stories)
- [ ] Testing and Validation
  - [ ] Write unit tests for tool executor with mock Prisma client
  - [ ] Write unit tests for context provider with mock services
  - [ ] Write integration test for enhanced chat route
  - [ ] Verify streaming responses work with tool execution
  - [ ] Ensure existing chat functionality remains unaffected
- [ ] Integration Verification (IV)
  - [ ] IV1: Verify existing chat endpoint continues to function without modifications
  - [ ] IV2: Verify context provider successfully reads from existing Prisma models
  - [ ] IV3: Verify no performance impact on current chat response times
- [ ] Submit PR (REQUIRED FINAL TASK)
  - [ ] Push branch: `git push -u origin feature/5-1-ai-tool-infrastructure`
  - [ ] Create PR from feature branch â†’ develop branch
  - [ ] PR Title: "Epic 5 Story 5.1: Foundation - Tool Infrastructure and Context Provider"
  - [ ] Link PR to story in description

## Dev Notes

### GitFlow Workflow
Branch Name: feature/5-1-ai-tool-infrastructure
Base Branch: develop (NOT main)
PR Target: develop (NOT main)

Git Commands:
1. Setup: `git checkout develop && git pull origin develop`
2. Create: `git checkout -b feature/5-1-ai-tool-infrastructure`
3. Commit: Use conventional commits (feat:, fix:, docs:, etc.)
4. Push: `git push -u origin feature/5-1-ai-tool-infrastructure`
5. PR: Create PR to develop branch with title "Epic 5 Story 5.1: Foundation - Tool Infrastructure and Context Provider"

### Technical Architecture Context

**Previous Story Insights**: This is the first story of Epic 5, no previous story context.

**Critical Architecture Decision** [Source: docs/epic-5-architecture.md#10-11]:
- Tools are NOT API endpoints - they are server-side functions
- Tools are JavaScript/TypeScript objects passed directly to the AI model
- Tools execute on the server with direct database access via Prisma
- The ONLY public endpoint is the enhanced `/api/chat` route
- Client never sees or calls tools directly - only sends chat messages

**Existing Infrastructure** [Source: docs/epic-5-architecture.md#19-24]:
- OpenRouter integration is ALREADY IN PLACE and working
- The chat route already uses `streamText` which supports the tools parameter
- The POC proves the exact same stack (OpenRouter + Vercel AI SDK) works with tools
- Main work is defining business domain tools, not building infrastructure

**Tech Stack Alignment** [Source: docs/epic-5-architecture.md#102-119]:
- Next.js 15.4.5 with App Router pattern
- TypeScript in strict mode
- Prisma 6.13.0 for all database operations with transaction support
- Vercel AI SDK 4.3.19 with native tool support
- OpenRouter 0.0.5 for AI model access with tool-capable models
- Zod 3.25.76 for tool parameter validation
- All functionality achievable with existing stack - no new dependencies needed

**File Locations Based on Project Structure**:
- New tool infrastructure: `/lib/ai-tools/` (new directory)
- Enhanced chat route: `/app/api/chat/route.ts` (existing file)
- Service layer pattern: `/lib/services/` (existing pattern to follow)
- Prisma client access: Use `getClient()` from `/lib/db/client.ts`

**API Integration Pattern** [Source: docs/epic-5-architecture.md#278-300]:
```typescript
// Minimal changes to existing chat route - just add tools parameter
import { allTools } from '@/lib/ai-tools';  // NEW
import { loadWebsiteContext } from '@/lib/ai-tools/context-provider';  // NEW

// In POST handler, add:
const context = websiteId ? await loadWebsiteContext(websiteId) : null;

// Enhance existing streamText call:
const result = streamText({
  model,  // EXISTING
  messages,  // EXISTING
  system: context ? generateSystemPrompt(context) : undefined,  // NEW
  tools: allTools,  // NEW
  toolChoice: 'auto',  // NEW
  maxSteps: 5,  // NEW
  onStepFinish: logToolExecution  // NEW: Optional
});
```

**Tool Pattern from POC** [Source: proof-of-concept/test-ai-tools.js#20-34]:
```javascript
// Tools follow this pattern (proven to work):
const exampleTool = tool({
  description: 'Tool description',
  parameters: z.object({
    param: z.string().describe('Parameter description')
  }),
  execute: async ({ param }) => {
    // Implementation with try/catch
    return { success: true/false, data/error };
  }
});
```

**Service Layer Pattern** [Source: lib/services/website-service.ts#10-19]:
- Use lazy initialization for Prisma client
- Access via `getClient()` from `/lib/db/client.ts`
- Follow existing error handling with ApiError class
- Use existing service classes without modification

**Database Integration** [Source: docs/epic-5-architecture.md#74-79]:
- All operations through existing Prisma client instance
- No schema modifications - work with existing models
- JSON string storage for complex tool parameters following existing pattern
- Atomic transactions using Prisma's transaction API

### Testing Standards

**Test File Locations**:
- Unit tests: `/lib/ai-tools/__tests__/` (following existing pattern)
- Integration tests: `/__tests__/api/chat-tools.test.ts`
- Use existing test patterns from `/lib/services/__tests__/`

**Testing Frameworks**:
- Jest for unit tests (existing setup)
- Mock Prisma client pattern from existing tests
- Follow existing test patterns in the codebase

**Specific Testing Requirements**:
- Mock all database operations for unit tests
- Test tool executor with various validation scenarios
- Test context provider performance (<500ms requirement)
- Verify streaming responses continue to work
- Ensure backward compatibility with existing chat

### Integration Verification Points
- IV1: Existing chat endpoint continues to function without modifications
- IV2: Context provider successfully reads from existing Prisma models
- IV3: No performance impact on current chat response times

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-14 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-01-14 | 1.1 | Applied PO feedback: clarified path, added IV tasks, noted business rules stub | Bob (Scrum Master) |

## Dev Agent Record
*To be populated during development*

### Agent Model Used
*To be recorded*

### Debug Log References
*To be recorded*

### Completion Notes List
*To be recorded*

### File List
*To be recorded*

## QA Results
*To be populated during QA*