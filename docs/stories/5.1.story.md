# Story 5.1: Foundation - Tool Infrastructure and Context Provider

## Status
Draft

## Story
**As a** developer,  
**I want** to establish the core AI tool execution infrastructure,  
**so that** subsequent stories can build on a solid foundation.

## Acceptance Criteria
1. `/lib/ai-tools/` directory structure created with proper organization for tools and helpers (tools are server-side functions, not API endpoints)
2. Base tool executor implemented with Zod validation and error handling using Vercel AI SDK patterns
3. Context provider loads website metadata and content structures in <500ms
4. Vercel AI SDK integrated with OpenRouter API configuration for tool calling
5. Streaming response handler implemented for real-time updates in chat interface

## Tasks / Subtasks
- [ ] Git Setup (REQUIRED FIRST TASK)
  - [ ] Checkout and update develop: `git checkout develop && git pull origin develop`
  - [ ] Create feature branch: `git checkout -b feature/5-1-ai-tool-infrastructure`

- [ ] Create AI Tools Directory Structure (AC: 1)
  - [ ] Create `/lib/ai-tools/` directory
  - [ ] Create subdirectories: `/lib/ai-tools/website/`, `/lib/ai-tools/content-types/`, `/lib/ai-tools/content-items/`
  - [ ] Create `/lib/ai-tools/helpers/` for utility functions
  - [ ] Create `/lib/ai-tools/index.ts` to export all tools

- [ ] Implement Base Tool Executor (AC: 2)
  - [ ] Create `/lib/ai-tools/tool-executor.ts` with transaction wrapper
  - [ ] Implement Zod validation schemas for tool parameters
  - [ ] Add error handling with proper error messages
  - [ ] Implement logging for tool execution start/end
  - [ ] Create rollback mechanism using Prisma transactions

- [ ] Implement Context Provider (AC: 3)
  - [ ] Create `/lib/ai-tools/context-provider.ts`
  - [ ] Implement `loadWebsiteContext(websiteId)` function to load website metadata
  - [ ] Implement `loadContentStructure(websiteId)` to get content types and items
  - [ ] Implement context pruning helper for large contexts

- [ ] Enhance Existing OpenRouter Integration for Tool Support (AC: 4)
  - [ ] ✅ EXISTING: Environment variables already configured (OPENROUTER_API_KEY, OPENROUTER_MODEL)
  - [ ] ✅ EXISTING: OpenRouter SDK already installed and working (@openrouter/ai-sdk-provider: 0.0.5)
  - [ ] ✅ EXISTING: Model already configured (claude-3.5-sonnet) and proven to work with tools in POC
  - [ ] Create `/lib/ai-tools/ai-config.ts` to centralize AI configuration (organizational improvement)
  - [ ] Add retry logic with exponential backoff (reliability enhancement)
  - [ ] Add fallback to advisory mode on API failures (resilience feature)

- [ ] Enhance Chat Route with Tool Support (AC: 5)
  - [ ] ✅ EXISTING: Chat route already uses streamText for streaming responses
  - [ ] ✅ VERIFIED: streamText supports tools parameter (same as generateText in POC)
  - [ ] Add tools parameter to existing streamText call with tool definitions
  - [ ] Add context loading before AI invocation
  - [ ] Add maxSteps parameter for multi-step tool operations (proven in POC)
  - [ ] Implement onStepFinish callback for tool execution logging

- [ ] Add Type Definitions
  - [ ] Create `/lib/ai-tools/types.ts` for tool-related types
  - [ ] Define ToolExecutionLog interface
  - [ ] Define BusinessContext interface
  - [ ] Define ToolResult interface

- [ ] Write Unit Tests
  - [ ] Create `__tests__/ai-tools/tool-executor.test.ts`
  - [ ] Create `__tests__/ai-tools/context-provider.test.ts`
  - [ ] Test validation schemas
  - [ ] Test error handling and rollback
  - [ ] Test performance (<500ms context loading)

- [ ] Integration Verification Tests
  - [ ] Verify existing chat endpoint continues to function without modifications (IV1)
  - [ ] Verify context provider successfully reads from existing Prisma models (IV2)
  - [ ] Verify no performance impact on current chat response times (IV3)
  - [ ] Create integration test to ensure backward compatibility

- [ ] Submit PR (REQUIRED FINAL TASK)
  - [ ] Push branch: `git push -u origin feature/5-1-ai-tool-infrastructure`
  - [ ] Create PR from feature branch → develop branch
  - [ ] PR Title: "Epic 5 Story 1: Foundation - Tool Infrastructure and Context Provider"
  - [ ] Link PR to story in description

## Dev Notes

### GitFlow Workflow
Branch Name: feature/5-1-ai-tool-infrastructure  
Base Branch: develop (NOT main)  
PR Target: develop (NOT main)  

Git Commands:
1. Setup: `git checkout develop && git pull origin develop`
2. Create: `git checkout -b feature/5-1-ai-tool-infrastructure`
3. Commit: Use conventional commits (feat:, fix:, docs:, etc.)
4. Push: `git push -u origin feature/5-1-ai-tool-infrastructure`
5. PR: Create PR to develop branch with title "Epic 5 Story 1: Foundation - Tool Infrastructure and Context Provider"

### Technical Context

**CRITICAL Architecture Decision:**
- Tools are NOT API endpoints - they are server-side functions [Source: docs/epic-5-architecture.md#16-18]
- Tools execute on the server with direct database access via Prisma
- The ONLY public endpoint is the enhanced `/api/chat` route
- Client never sees or calls tools directly - only sends chat messages
- This follows the proven POC pattern from `proof-of-concept/ai-tools-demo.js`

**Note on Business Rule Engine:**
- The Business Rule Engine component mentioned in the architecture will be implemented in Story 5.2 (Website Management Tools)
- This foundation story focuses on core infrastructure only

**Existing Services to Leverage:**
- `lib/services/website-service.ts` - WebsiteService class for website operations
- `lib/services/content-type-service.ts` - ContentTypeService for content type operations  
- `lib/services/ai-prompt-processor.ts` - Existing AI processing patterns
- `lib/db/prisma.ts` - Prisma client instance

**Project Structure:**
```
lib/
├── ai-tools/                     # New directory for tool infrastructure
│   ├── index.ts                  # Export all tools
│   ├── tool-executor.ts          # Core execution engine
│   ├── context-provider.ts       # Context loading
│   ├── ai-config.ts             # OpenRouter configuration
│   ├── types.ts                 # Type definitions
│   ├── website/                 # Website management tools
│   ├── content-types/           # Content type tools
│   ├── content-items/           # Content item tools
│   └── helpers/                 # Utility functions
│       ├── context-pruning.ts
│       └── rollback-helper.ts
```

**Dependencies and Versions:**
- Vercel AI SDK: 4.3.19 (already installed)
- OpenRouter SDK: 0.0.5 (already installed)
- Zod: 3.25.76 (already installed for validation)
- Prisma: 6.13.0 (already configured)

**Key Implementation Patterns from POC:**
The POC at `proof-of-concept/test-ai-tools.js` demonstrates the WORKING tool calling pattern:
- Tools are defined using the `tool()` function from Vercel AI SDK with Zod schemas
- Tools work with both `generateText` (POC) and `streamText` (needed for chat)
- The same OpenRouter setup and claude-3.5-sonnet model already support tools
- Multi-step operations work with `maxSteps` parameter
- Tool execution can be tracked with `onStepFinish` callback

**CRITICAL INSIGHT:** The infrastructure is mostly in place. The main work is:
1. Adapting the POC pattern from file operations to website/content operations
2. Adding the tools parameter to the existing streamText call in chat route
3. Defining business-specific tools instead of file manipulation tools

**Performance Requirements:**
- Context loading must complete in <500ms [Source: docs/epic-5-brownfield-prd.md#100]
- Tool execution should complete within 2 seconds [Source: docs/epic-5-brownfield-prd.md#99]

### Testing Standards
- Test files location: `__tests__/` directories at the same level as source files
- Testing framework: Jest with existing configuration
- Mock Prisma client for database operations
- Test coverage requirements: All public functions must have tests
- Performance tests: Context loading must be verified to complete in <500ms
  - Use Jest's timer utilities to measure context loading performance
  - Create test case: `it('should load context in under 500ms', async () => { ... })`
  - Use `performance.now()` or `console.time()` for precise measurement
  - Test with varying data sizes (empty, small, large website contexts)
  - Fail test if loading exceeds 500ms threshold

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-14 | 1.0 | Initial story creation | Scrum Master Bob |
| 2025-01-14 | 1.1 | Updated per PO validation feedback - clarified directory path, added integration verification tests, noted Business Rule Engine deferral | Scrum Master Bob |

## Dev Agent Record
*This section to be populated by the development agent during implementation*

### Agent Model Used
*To be filled*

### Debug Log References
*To be filled*

### Completion Notes List
*To be filled*

### File List
*To be filled*

## QA Results
*This section to be populated by QA agent after story completion*