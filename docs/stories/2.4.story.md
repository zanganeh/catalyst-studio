# Story 2.4: Remove Feature Flags from API and Server Actions

## Status
Draft

## Story
**As a** developer,
**I want** to remove feature flag logic from all API routes and server actions,
**so that** the backend permanently enables all Epic 1 features.

## Acceptance Criteria
1. Remove feature flag checks from API route handlers
2. Update server actions to remove flag-based conditionals
3. Remove flag parameters from API interfaces
4. Update API documentation to reflect permanent features
5. Clean up any flag-based middleware or interceptors

## Tasks / Subtasks

### Task 1: Audit Server-Side Code for Feature Flag Usage (AC: 1, 2, 3)
- [ ] Search all API routes in `/app/api/` for feature flag imports or checks
  - [ ] Use grep to find any imports from feature flag utilities
  - [ ] Check for localStorage access in server code (should be none)
  - [ ] Document any findings
- [ ] Search server actions for feature flag logic
  - [ ] Check inline server actions in React Server Components
  - [ ] Check dedicated server action files in `/app/actions/` (if exists)
  - [ ] Look for any feature flag parameters in function signatures
- [ ] Check middleware files for feature flag logic
  - [ ] Review `middleware.ts` or `middleware.js` in root
  - [ ] Check any API middleware in `/lib/middleware/` (if exists)

### Task 2: Remove Feature Flag Logic from API Routes (AC: 1, 4)
- [ ] Update any API route handlers that check feature flags
  - [ ] Remove conditional logic based on flags
  - [ ] Ensure all features are permanently enabled
  - [ ] Remove any feature flag imports
- [ ] Verify API routes continue to function correctly
  - [ ] Test each modified endpoint
  - [ ] Ensure responses remain consistent

### Task 3: Clean Up Server Actions (AC: 2, 3)
- [ ] Remove feature flag parameters from server action signatures
  - [ ] Update function parameters to remove flag arguments
  - [ ] Update calling code to remove flag parameters
- [ ] Remove any conditional logic based on feature flags
  - [ ] Permanently enable all Epic 1 features
  - [ ] Simplify code paths

### Task 4: Update Middleware and Interceptors (AC: 5)
- [ ] Remove any feature flag checks from middleware
  - [ ] Clean up conditional request handling
  - [ ] Remove feature flag imports
- [ ] Update any request/response interceptors
  - [ ] Remove flag-based header checks
  - [ ] Simplify request processing

### Task 5: Update API Documentation (AC: 4)
- [ ] Update inline API documentation/comments
  - [ ] Remove references to feature flags in JSDoc comments
  - [ ] Update function descriptions to reflect permanent features
- [ ] Update any OpenAPI/Swagger specifications (if exists)
  - [ ] Remove feature flag parameters from API specs
  - [ ] Update endpoint descriptions

### Task 6: Verify Backend Functionality (AC: 1, 2, IV1, IV2, IV3)
- [ ] Test all API endpoints manually
  - [ ] Verify responses are correct
  - [ ] Check that all Epic 1 features work
  - [ ] Ensure no regressions
- [ ] Run API tests if they exist
  - [ ] Execute any API integration tests
  - [ ] Verify all tests pass
- [ ] Check performance metrics
  - [ ] Ensure no degradation in response times
  - [ ] Monitor for any memory issues

## Dev Notes

### Previous Story Insights
[Source: Story 2.3 Completion Notes (when available)]
- Story 2.2 removed core infrastructure and created stub files
- Story 2.3 removed feature flags from all UI components
- All components now render features permanently

### Architecture Context
[Source: docs/feature-flag-audit.md#Executive Summary]

**IMPORTANT:** The feature flag system is **entirely client-side**:
- No server-side feature flag checks exist
- No database involvement (no Prisma changes)
- localStorage-based implementation only
- All feature flag logic is in React components/context

This means Story 2.4 may find **NO server-side code to modify**. This is expected and correct.

### Expected Findings
[Source: docs/feature-flag-audit.md#Key Findings]

Based on the comprehensive audit from Story 2.1:
- **Server-Side Impact:** NONE - entirely client-side implementation
- **Database Impact:** NONE - no Prisma schema involvement
- **API Routes:** Likely no feature flag usage
- **Server Actions:** Likely no feature flag usage
- **Middleware:** Likely no feature flag usage

If no server-side feature flag code is found, this story becomes a verification task to confirm the backend is clean.

### API Structure
[Source: architecture.md#Tech Stack Alignment]

The application uses:
- **Framework:** Next.js 14+ with App Router
- **API Pattern:** Server actions preferred over API routes
- **Server Actions Location:** Inline in React Server Components or `/app/actions/`
- **API Routes Location:** `/app/api/` directory
- **Middleware Location:** Root `middleware.ts` file

### Potential Areas to Check
Even though audit found no server-side flags, verify these areas:
1. **Server Actions** - Check for any conditional logic that might have been missed
2. **API Route Handlers** - Verify no feature flag parameters in requests
3. **Middleware** - Ensure no feature flag headers or cookies are checked
4. **Environment Variables** - Confirm no `NEXT_PUBLIC_FEATURE_*` vars are read server-side

### Testing
[Source: architecture.md#Tech Stack Alignment]

**Testing Framework:** Jest for unit tests, Playwright for E2E tests

**Test Locations:**
- API tests: `__tests__/api/` or `*.test.ts` files
- Integration tests: `/tests/` directory

**Testing Standards for this Story:**
- Manually test all API endpoints if any are modified
- Verify server actions work correctly
- Check that no feature flag parameters are expected
- Run existing API tests to ensure no regressions
- Confirm backward compatibility

### Important Note
**This story may result in NO code changes** if the audit's finding of "no server-side feature flags" is confirmed. In this case:
1. Document the verification process
2. Confirm no server-side changes needed
3. Mark story as complete with notes
4. This is a valid and expected outcome

## Integration Verification
- **IV1**: All API endpoints continue to function correctly
- **IV2**: API responses remain backward compatible
- **IV3**: No performance degradation in API response times

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-11 | 1.0 | Initial story creation based on Epic 2 requirements | Bob (SM) |