# Story 4.5: Content Items Module Migration

## Status
Approved

## Story
**As a** developer,  
**I want** to migrate content items from local storage to database,  
**so that** user-created content is persistently stored.

## Acceptance Criteria
1. Create content_items table with foreign key to content_types
2. Implement `/app/api/content-items/route.ts` with full CRUD
3. Handle relationships between items and types
4. Replace localStorage calls with API calls
5. Implement pagination for large datasets
6. Add optimistic updates for better UX

## Tasks / Subtasks
- [ ] Git Setup (REQUIRED FIRST TASK)
  - [ ] Checkout and update develop: `git checkout develop && git pull origin develop`
  - [ ] Create feature branch: `git checkout -b feature/4-5-content-items-migration`
- [ ] Update Database Schema (AC: 1)
  - [ ] Add ContentItem model to `prisma/schema.prisma`:
    - id, contentTypeId, websiteId fields
    - data field as JSON for flexible content
    - status field (draft/published/archived)
    - slug field for URL-friendly identifiers
    - metadata field for SEO and custom properties
    - publishedAt DateTime field
    - Proper relations to ContentType and Website
  - [ ] Add indexes for performance:
    - Index on websiteId + contentTypeId
    - Index on slug for quick lookups
    - Index on status + publishedAt for published content queries
  - [ ] Run migration: `npm run db:migrate -- --name add-content-items`
- [ ] Create TypeScript Types (AC: 3)
  - [ ] Add to `/types/api.ts`:
    - ContentItem interface
    - CreateContentItemRequest interface
    - UpdateContentItemRequest interface
    - ContentItemsResponse with pagination
  - [ ] Add content status enum: `draft | published | archived`
- [ ] Implement Content Items API Routes (AC: 2, 5)
  - [ ] Create `/app/api/content-items/route.ts`:
    - GET method with pagination, filtering by websiteId and contentTypeId
    - POST method to create new content item
    - Include query parameters: page, limit, status, contentTypeId, websiteId
  - [ ] Create `/app/api/content-items/[id]/route.ts`:
    - GET method to retrieve single item with expanded relations
    - PUT method to update item
    - DELETE method to soft delete (set status to archived)
  - [ ] Add bulk operations endpoint `/app/api/content-items/bulk/route.ts`:
    - POST method for bulk create/update
    - DELETE method for bulk archive
- [ ] Add Validation Schemas (AC: 3)
  - [ ] Create `/lib/api/validation/content-item.ts`:
    - CreateContentItemSchema with required fields validation
    - UpdateContentItemSchema with partial fields
    - Validate data field matches content type field definitions
    - Query parameter validation schemas
- [ ] Create API Client Service (AC: 4)
  - [ ] Create `/lib/api/content-items.ts`:
    - `getContentItems()` with pagination and filters
    - `getContentItem(id)` for single item
    - `createContentItem()` with optimistic update
    - `updateContentItem()` with optimistic update
    - `deleteContentItem()` with optimistic update
    - `bulkOperations()` for batch operations
  - [ ] Include React Query hooks:
    - `useContentItems()` hook with caching
    - `useContentItem()` hook for single item
    - `useCreateContentItem()` mutation
    - `useUpdateContentItem()` mutation
    - `useDeleteContentItem()` mutation
- [ ] Implement Frontend Integration (AC: 4, 6)
  - [ ] Update content context/store to use API client:
    - `/lib/context/content-item-context.tsx` (if exists)
    - `/lib/stores/content-store.ts` (if using Zustand)
  - [ ] Replace localStorage calls in content components:
    - `/app/(dashboard)/content/page.tsx`
    - `/components/content/content-list.tsx` (if exists)
    - `/components/content/content-editor.tsx` (if exists)
  - [ ] Add React Query provider if not already present in `/app/layout.tsx`
  - [ ] Implement optimistic updates for all mutations:
    - Update cache immediately on mutation
    - Rollback on error
    - Show loading states appropriately
  - [ ] Handle pagination in content lists
  - [ ] Add error boundaries for failed requests
- [ ] Create Migration Script (AC: 4)
  - [ ] Create `/scripts/migrate-content-items.ts`:
    - Read existing content from localStorage
    - Transform to new database format
    - Batch insert into database
    - Verify migration success
    - Option to rollback if needed
  - [ ] Add migration command to package.json
  - [ ] Document migration process
- [ ] Testing and Validation (AC: 2, 3, 5, 6)
  - [ ] Create test script `/scripts/test-content-items-api.ts`:
    - Test all CRUD operations
    - Test pagination with large datasets
    - Test filtering and sorting
    - Test relationship loading
    - Test optimistic updates
  - [ ] Manual testing checklist:
    - Create content items of different types
    - Edit existing items
    - Delete items (verify soft delete)
    - Test pagination with 50+ items
    - Test filtering by type and status
    - Verify optimistic updates feel instant
  - [ ] Verify relationships work correctly:
    - Content items properly linked to types
    - Cascade behaviors work as expected
- [ ] Documentation Updates
  - [ ] Update API documentation with content items endpoints
  - [ ] Document pagination pattern for other modules
  - [ ] Add examples of optimistic update implementation
  - [ ] Document migration script usage
- [ ] Submit PR (REQUIRED FINAL TASK)
  - [ ] Push branch: `git push -u origin feature/4-5-content-items-migration`
  - [ ] Create PR from feature branch â†’ develop branch
  - [ ] PR Title: "Epic 4 Story 5: Content Items Module Migration"
  - [ ] Link PR to story in description

## Dev Notes

### GitFlow Workflow
Branch Name: feature/4-5-content-items-migration
Base Branch: develop (NOT main)  
PR Target: develop (NOT main)

Git Commands:
1. Setup: `git checkout develop && git pull origin develop`
2. Create: `git checkout -b feature/4-5-content-items-migration`
3. Commit: Use conventional commits (feat:, fix:, docs:, etc.)
4. Push: `git push -u origin feature/4-5-content-items-migration`
5. PR: Create PR to develop branch with title "Epic 4 Story 5: Content Items Module Migration"

### Technical Implementation Details

#### Database Schema Updates
[Source: architecture/epic4-architecture.md#contentitem-model]

Add to `prisma/schema.prisma`:

```prisma
model ContentItem {
  id            String    @id @default(cuid())
  contentTypeId String
  websiteId     String
  slug          String?
  data          Json
  metadata      Json?
  status        String    @default("draft")
  publishedAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  contentType ContentType @relation(fields: [contentTypeId], references: [id])
  website     Website     @relation(fields: [websiteId], references: [id])
  
  @@index([websiteId, contentTypeId])
  @@index([slug])
  @@index([status, publishedAt])
}
```

#### Pagination Implementation
[Source: architecture/epic4-architecture.md#api-design-and-integration]

Implement cursor-based pagination for scalability:

```typescript
// Response format
interface PaginatedResponse<T> {
  data: T[];
  pagination: {
    total: number;
    page: number;
    limit: number;
    totalPages: number;
    hasNext: boolean;
    hasPrev: boolean;
  };
}

// Query parameters
interface PaginationQuery {
  page?: number;  // Default: 1
  limit?: number; // Default: 20, Max: 100
  status?: string;
  contentTypeId?: string;
  websiteId?: string;
  sortBy?: string;
  sortOrder?: 'asc' | 'desc';
}
```

#### React Query Integration
[Source: architecture/epic4-architecture.md#new-technology-additions]

Example React Query hook with optimistic updates:

```typescript
// /lib/api/content-items.ts
import { useMutation, useQueryClient } from '@tanstack/react-query';

export function useUpdateContentItem() {
  const queryClient = useQueryClient();
  
  return useMutation({
    mutationFn: async ({ id, data }: UpdateContentItemParams) => {
      const response = await fetch(`/api/content-items/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      if (!response.ok) throw new Error('Update failed');
      return response.json();
    },
    onMutate: async ({ id, data }) => {
      // Cancel outgoing refetches
      await queryClient.cancelQueries({ queryKey: ['content-items'] });
      
      // Snapshot previous value
      const previousItem = queryClient.getQueryData(['content-items', id]);
      
      // Optimistically update
      queryClient.setQueryData(['content-items', id], old => ({
        ...old,
        ...data
      }));
      
      return { previousItem };
    },
    onError: (err, variables, context) => {
      // Rollback on error
      if (context?.previousItem) {
        queryClient.setQueryData(
          ['content-items', variables.id],
          context.previousItem
        );
      }
    },
    onSettled: () => {
      // Refetch after error or success
      queryClient.invalidateQueries({ queryKey: ['content-items'] });
    }
  });
}
```

#### Migration Script Pattern
[Source: architecture/epic4-architecture.md#migration-strategy]

Migration approach for existing localStorage data:

```typescript
// /scripts/migrate-content-items.ts
async function migrateContentItems() {
  // 1. Read from localStorage
  const stored = localStorage.getItem('content-items');
  if (!stored) return;
  
  const items = JSON.parse(stored);
  
  // 2. Transform to database format
  const transformed = items.map(item => ({
    websiteId: getCurrentWebsiteId(),
    contentTypeId: item.typeId,
    data: item.fields,
    status: item.published ? 'published' : 'draft',
    publishedAt: item.published ? new Date() : null,
    metadata: item.meta || {}
  }));
  
  // 3. Batch insert
  const response = await fetch('/api/content-items/bulk', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ items: transformed })
  });
  
  // 4. Verify and cleanup
  if (response.ok) {
    localStorage.removeItem('content-items');
    console.log('Migration successful');
  }
}
```

### Integration Verification Requirements
[Source: epic4-prd.md#story-4.5]

Must verify:
- IV1: All existing content items functionality preserved
- IV2: Relationships between types and items maintained
- IV3: Performance acceptable for typical data volumes (test with 100+ items)

### Dependencies
This story depends on:
- Story 4.2: Database setup (ContentItem model requires Prisma)
- Story 4.3: API patterns (follows established patterns)
- Story 4.4: Content Types migration (items reference types)

### Testing Standards
[Source: docs/testing-guide.md]

**Test Configuration:**
- Test framework: Jest + React Testing Library
- Test file location: `__tests__` folders with `.test.ts` suffix
- Coverage requirement: Maintain existing coverage levels

**Module-Specific Testing Requirements:**
- Test with realistic data volumes (100+ items)
- Verify pagination performance
- Test optimistic updates feel instant (<100ms perceived delay)
- Ensure soft delete preserves data integrity
- Test bulk operations with 20+ items
- Mock Prisma client for unit tests
- Use test database for integration tests

### Important Notes

1. **Soft Delete Pattern**: Items are never hard deleted, only archived
2. **Pagination is Critical**: Must handle large datasets efficiently
3. **Optimistic Updates**: Essential for maintaining responsive UI
4. **Backward Compatibility**: Migration script must preserve all existing data
5. **Performance**: Index strategy is crucial for query performance
6. **Relationships**: Must properly load related content types when needed

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-12 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-08-12 | 1.1 | Updated based on PO validation feedback | Bob (Scrum Master) |

## Dev Agent Record
*To be populated during implementation*

### Agent Model Used
*To be populated*

### Debug Log References
*To be populated*

### Completion Notes List
*To be populated*

### File List
*To be populated*

## QA Results
*To be populated during QA review*