# Story 6.8: Add Validation Layer

## Status
Ready for Review

## Story
**As a** developer,  
**I want to** validate content types before syncing,  
**So that** invalid data doesn't corrupt the target system

## Acceptance Criteria
1. Schema validation for content type structure
2. Business rule validation
3. Pre-sync compatibility checks
4. Detailed validation error reporting

## Tasks / Subtasks
- [x] Git Setup (REQUIRED FIRST TASK)
  - [x] Checkout and update main: `git checkout main && git pull origin main`
  - [x] Create feature branch: `git checkout -b feature/epic6-validation`
- [x] Install Validation Dependencies (AC: 1)
  - [x] Install Zod for schema validation: `npm install zod`
  - [x] Verify installation and add to package.json
- [x] Create Core Validation Module (AC: 1, 2)
  - [x] Create `/lib/sync/validation/ContentTypeValidator.ts`
  - [x] Define Zod schemas for content type structure validation
  - [x] Implement `validateStructure()` method for schema validation
  - [x] Implement `validateBusinessRules()` method for business logic validation
  - [x] Create error formatting utilities for clear error messages
- [x] Implement Compatibility Checker (AC: 3)
  - [x] Create `/lib/sync/validation/CompatibilityChecker.ts`
  - [x] Implement `checkPlatformCompatibility()` method for Optimizely-specific rules
  - [x] Add field type compatibility validation
  - [x] Add relationship and constraint validation
  - [x] Check for unsupported features or configurations
- [x] Create Validation Error Reporter (AC: 4)
  - [x] Create `/lib/sync/validation/ValidationErrorReporter.ts`
  - [x] Implement structured error format with field paths, error types, and messages
  - [x] Add severity levels (error, warning, info)
  - [x] Create human-readable error summaries
  - [x] Support JSON output for programmatic consumption
- [x] Integrate Validation with Sync Engine (AC: 1, 2, 3)
  - [x] Modify `/lib/sync/engine/SyncEngine.ts` to add pre-sync validation step
  - [x] Add validation checkpoint before transformation phase
  - [x] Implement validation bypass flag for emergency overrides with audit logging
  - [x] Add security check: bypass requires explicit user confirmation and logs who/when/why
  - [x] Handle validation errors appropriately (halt sync, log errors)
- [x] Create Unit Tests (AC: 1, 2, 3, 4)
  - [x] Create `/lib/sync/validation/__tests__/ContentTypeValidator.test.ts`
  - [x] Create `/lib/sync/validation/__tests__/CompatibilityChecker.test.ts`
  - [x] Create `/lib/sync/validation/__tests__/ValidationErrorReporter.test.ts`
  - [x] Test valid content types pass validation
  - [x] Test invalid structures are caught with proper errors
  - [x] Test business rule violations are detected
  - [x] Test compatibility issues are identified
  - [x] Test error reporting formats are correct
- [x] Update Integration Tests
  - [x] Add validation scenarios to sync engine integration tests
  - [x] Test end-to-end sync flow with validation enabled
  - [x] Test validation error handling in the full sync pipeline
- [x] Submit PR (REQUIRED FINAL TASK)
  - [x] Push branch: `git push -u origin feature/epic6-validation`
  - [x] Create PR from feature branch → main branch
  - [x] PR Title: "Epic 6 Story 8: Add Validation Layer"
  - [x] Link PR to story in description

## Dev Notes

### GitFlow Workflow
Branch Name: feature/epic6-validation
Base Branch: main
PR Target: main

Git Commands:
1. Setup: `git checkout main && git pull origin main`
2. Create: `git checkout -b feature/epic6-validation`
3. Commit: Use conventional commits (feat:, fix:, docs:, etc.)
4. Push: `git push -u origin feature/epic6-validation`
5. PR: Create PR to main branch with title "Epic 6 Story 8: Add Validation Layer"

### Previous Story Insights
From Story 6.7 implementation:
- SyncStateManager successfully integrated with Prisma database
- Full test coverage pattern established using Jest
- RESTful API pattern implemented for sync operations
- React hooks created for UI integration (useSyncState pattern)
[Source: Story 6.7 Dev Agent Record]

### Technical Architecture Context

**Validation Technology Stack**
[Source: docs/epic6-architecture.md#New Technology Additions]
- Zod 3.x for schema validation - Type-safe validation library
- Integration method: npm install

**Data Protection Requirements**
[Source: docs/epic6-requirements.md#Data Protection]
- REQ-PROTECT-001: Validate all changes before applying to prevent data corruption
- REQ-PROTECT-004: Prevent type changes that would result in data loss

**Existing Validation Patterns**
[Source: lib/ai-tools/tools/website/validate-content.ts]
- Project uses Zod for validation in other modules
- Pattern: Create validation functions that return success/failure with detailed errors
- Pattern: Support both strict mode (warnings as errors) and normal mode
- Pattern: Separate validation for structure, business rules, and custom rules

**Sync Engine Integration Points**
[Source: docs/epic6-architecture.md#Component Architecture]
- SyncEngine orchestrates the synchronization process
- Current flow: Extract → Transform → Sync
- New flow: Extract → **VALIDATE** → Transform → Sync
- SyncEngine location: `/lib/sync/engine/SyncEngine.ts`

**Content Type Structure**
[Source: Database inspection via previous stories]
Content types have the following structure to validate:
- `key`: Unique identifier
- `name`: Display name
- `fields`: Array of field definitions
- `relationships`: Links to other content types
- `metadata`: Additional configuration

**Optimizely-Specific Validation Rules**
[Source: docs/epic6-architecture.md#OptimizelyAdapter]
- Field types must map to Optimizely supported types
- Content type names must follow Optimizely naming conventions
- Certain field configurations are not supported in Optimizely

### Project Structure Notes
Validation module location following established patterns:
```
/lib/sync/validation/          # New validation module directory
├── ContentTypeValidator.ts    # Core validation logic
├── CompatibilityChecker.ts    # Platform-specific compatibility
├── ValidationErrorReporter.ts # Error formatting and reporting
└── __tests__/                # Test files for validation
```

### Testing Standards
[Source: Previous story implementations and project patterns]
- Test file location: Same directory structure under `__tests__` folder
- Testing framework: Jest with TypeScript
- Pattern: One test file per module
- Coverage expectation: Full coverage of public methods
- Mock external dependencies (database, API clients)
- Test both success and failure paths
- Use descriptive test names following "should..." pattern

### Performance Considerations
- Validation should add minimal latency (<50ms for typical content type)
- Consider implementing validation caching for repeated validations
- Run validations in parallel where possible
- Profile validation performance in tests to ensure acceptable impact

### Sample Validation Errors
Example error formats to implement:
```typescript
// Structure validation error
{
  type: 'INVALID_STRUCTURE',
  field: 'fields[2].type',
  message: 'Invalid field type "customType". Must be one of: string, number, boolean, date',
  severity: 'error'
}

// Business rule violation
{
  type: 'BUSINESS_RULE_VIOLATION',
  field: 'name',
  message: 'Content type name cannot start with underscore',
  severity: 'error'
}

// Compatibility warning
{
  type: 'PLATFORM_INCOMPATIBLE',
  field: 'fields[0].validation.regex',
  message: 'Optimizely does not support regex validation. This will be ignored during sync',
  severity: 'warning'
}
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-18 | 1.0 | Initial story draft created | Scrum Master Bob |
| 2025-01-18 | 1.1 | Added security guidelines for validation bypass, performance considerations, and error examples per PO review | Scrum Master Bob |
| 2025-01-18 | 2.0 | Implementation completed, all tasks done, PR #33 submitted | Developer James |

## Dev Agent Record
_This section will be populated by the development agent during implementation_

### Agent Model Used
Claude Opus 4.1 (claude-opus-4-1-20250805)

### Debug Log References
- Validation layer implementation completed successfully
- All unit tests passing (40 tests)
- Integration tests passing (6 tests)
- No major issues encountered during implementation

### Completion Notes List
- Successfully installed Zod validation library (v3.x)
- Created comprehensive validation module with three main components:
  - ContentTypeValidator: Handles structure and business rule validation
  - CompatibilityChecker: Ensures platform compatibility (Optimizely-specific)
  - ValidationErrorReporter: Provides detailed error reporting in multiple formats
- Integrated validation into SyncEngine with pre-sync validation checkpoint
- Implemented security audit logging for validation bypass
- All acceptance criteria met and tested
- Test coverage includes edge cases and error scenarios

### File List
**New Files Created:**
- `/lib/sync/validation/ContentTypeValidator.ts` - Core validation logic
- `/lib/sync/validation/CompatibilityChecker.ts` - Platform compatibility checks
- `/lib/sync/validation/ValidationErrorReporter.ts` - Error reporting utilities
- `/lib/sync/validation/__tests__/ContentTypeValidator.test.ts` - Unit tests
- `/lib/sync/validation/__tests__/CompatibilityChecker.test.ts` - Unit tests
- `/lib/sync/validation/__tests__/ValidationErrorReporter.test.ts` - Unit tests
- `/lib/sync/engine/__tests__/SyncEngine.integration.test.ts` - Integration tests

**Modified Files:**
- `/lib/sync/engine/SyncEngine.ts` - Added validation integration
- `/lib/deployment/deployment-types.ts` - Added validation bypass options
- `/package.json` - Added Zod dependency

## QA Results
_This section will be populated by the QA agent after implementation review_