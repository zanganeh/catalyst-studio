# Story 9.6: Add Bulk Operations Support

## Status
Draft

## Story
**As a** sitemap builder user,
**I want** to select multiple nodes and perform bulk operations on them,
**so that** I can efficiently manage large sitemaps without repetitive individual actions.

## Acceptance Criteria
1. Multi-select works via Shift+Click on nodes in the canvas
2. Multi-select works via drag-to-select area selection (lasso/box selection)
3. Selected nodes have clear visual indication (highlight or border)
4. Bulk delete operation available with confirmation dialog
5. Bulk status change operations available (draft/published/archived)
6. Best-effort processing - operations continue even if some items fail
7. Clear feedback shows which operations succeeded and which failed
8. Selection clears after successful bulk operation
9. Keyboard shortcut Ctrl+A/Cmd+A selects all nodes
10. Escape key clears current selection
11. Selected count displays in UI when multiple nodes selected
12. Undo operation reverts entire bulk operation as single action

## Tasks / Subtasks
- [ ] Git Setup (REQUIRED FIRST TASK)
  - [ ] Checkout and update main: `git checkout main && git pull premium main`
  - [ ] Create story branch from main: `git checkout -b story/EPIC9-006-bulk-operations`
- [ ] Implement Multi-Select in Zustand Store (AC: 1, 2, 8, 9, 10)
  - [ ] Add `selectedNodes` array to store state (already exists)
  - [ ] Create `toggleNodeSelection(nodeId, isShiftKey)` action
  - [ ] Create `selectNodesInArea(area)` action for box selection
  - [ ] Create `selectAllNodes()` action for Ctrl+A
  - [ ] Create `clearSelection()` action (already exists)
  - [ ] Update selection logic to handle Shift+Click multi-select
  - [ ] Test multi-select state management
- [ ] Add Visual Selection Feedback (AC: 3, 11)
  - [ ] Update node component in `/lib/premium/components/sitemap/` to show selection state
  - [ ] Add selected styling (border, background, or outline)
  - [ ] Create selection count display component
  - [ ] Position selection count in toolbar or status bar
  - [ ] Test visual feedback with various node counts
- [ ] Implement Area Selection (Lasso) (AC: 2)
  - [ ] Add mouse event handlers:
    - [ ] Detect mousedown on canvas background (not on nodes)
    - [ ] Track mousemove with drag state
    - [ ] Handle mouseup to complete selection
    - [ ] Handle mouse leave canvas edge case
  - [ ] Draw selection rectangle:
    - [ ] Create SelectionBox component with absolute positioning
    - [ ] Calculate rectangle dimensions from start/current mouse positions
    - [ ] Apply visual styling (dashed border, semi-transparent fill)
    - [ ] Clean up rectangle on selection complete
  - [ ] Calculate node intersection:
    - [ ] Get all node positions from React Flow instance
    - [ ] Implement rectangle-rectangle intersection algorithm
    - [ ] Handle partially overlapping nodes (include if center is within)
  - [ ] Update store with selection:
    - [ ] Call store.selectNodesInArea() with node IDs
    - [ ] Clear previous selection if not holding Shift
    - [ ] Add to selection if Shift is held
  - [ ] Test edge cases:
    - [ ] Selection from right-to-left
    - [ ] Selection from bottom-to-top
    - [ ] Very small selection areas
    - [ ] Selection during zoom/pan
- [ ] Create Bulk Operations API Endpoint (AC: 4, 5, 6, 7)
  - [ ] Create `/app/api/premium/sitemap/bulk/route.ts`
  - [ ] Implement security layer:
    - [ ] Verify user authentication
    - [ ] Check CSRF token
    - [ ] Validate batch size (max 100 items)
    - [ ] Implement rate limiting check
  - [ ] Implement POST handler:
    - [ ] Parse and validate request body with Zod
    - [ ] Support operation types (DELETE, UPDATE_STATUS)
    - [ ] Verify permissions for each item individually
  - [ ] Use best-effort processing:
    - [ ] Process each item in try-catch block
    - [ ] Continue on individual failures
    - [ ] Track success/failure for each item
  - [ ] Return detailed results: `{ succeeded: [], failed: [] }`
  - [ ] Add comprehensive logging:
    - [ ] Log operation start with user ID and item count
    - [ ] Log individual failures with reasons
    - [ ] Log final summary
  - [ ] Test with various failure scenarios:
    - [ ] Mixed permissions (some allowed, some denied)
    - [ ] Invalid node IDs in batch
    - [ ] Database connection failures mid-operation
- [ ] Add Bulk Operations UI Components (AC: 4, 5, 7)
  - [ ] Create BulkOperationsToolbar component in `/lib/premium/components/sitemap/`
  - [ ] Show toolbar only when multiple nodes selected
  - [ ] Add "Delete Selected" button with confirmation dialog
  - [ ] Add "Change Status" dropdown for bulk status updates
  - [ ] Display operation results (success/failure counts)
  - [ ] Test UI with various selection sizes
- [ ] Integrate Bulk Delete Operation (AC: 4, 6, 7, 8)
  - [ ] Connect delete button to bulk API endpoint
  - [ ] Show confirmation dialog with selected count
  - [ ] Call `/api/premium/sitemap/bulk` with DELETE operation
  - [ ] Update store to remove succeeded nodes
  - [ ] Show error for failed deletions
  - [ ] Clear selection after operation
  - [ ] Test with mixed success/failure scenarios
- [ ] Integrate Bulk Status Change (AC: 5, 6, 7, 8)
  - [ ] Add status dropdown (draft/published/archived)
  - [ ] Call `/api/premium/sitemap/bulk` with UPDATE_STATUS operation
  - [ ] Update store for succeeded status changes
  - [ ] Show summary of results
  - [ ] Clear selection after operation
  - [ ] Test status changes with permissions
- [ ] Add Keyboard Shortcuts (AC: 9, 10)
  - [ ] Create `useKeyboardShortcuts` hook in `/lib/premium/hooks/`
  - [ ] Implement Ctrl+A/Cmd+A for select all
  - [ ] Implement Escape for clear selection
  - [ ] Integrate with existing keyboard handlers
  - [ ] Test on Windows/Mac/Linux
- [ ] Integrate with Undo System (AC: 12)
  - [ ] Capture state before bulk operations
  - [ ] Store entire bulk operation as single undo action
  - [ ] Ensure undo reverts all changes from bulk operation
  - [ ] Test undo/redo with bulk operations
- [ ] Testing & Error Handling
  - [ ] Test multi-select with 10, 50, 100 nodes
  - [ ] Test bulk operations with partial failures
  - [ ] Test selection persistence during operations
  - [ ] Test keyboard shortcuts across browsers
  - [ ] Add error boundaries for bulk operation failures
  - [ ] Verify no memory leaks with large selections
- [ ] Submit PR (REQUIRED FINAL TASK)
  - [ ] Run linting: `npm run lint`
  - [ ] Run type checking: `npm run typecheck`
  - [ ] Run tests if available
  - [ ] Push branch: `git push -u premium story/EPIC9-006-bulk-operations`
  - [ ] Create PR from story branch â†’ main branch
  - [ ] PR Title: "feat(EPIC9-006): Add bulk operations support for sitemap builder"
  - [ ] Link PR to this story in description
  - [ ] Include screenshots of multi-select and bulk operations

## Dev Notes

### GitFlow Workflow
Branch Name: story/EPIC9-006-bulk-operations
Base Branch: main
PR Target: main

Git Commands:
1. Setup: `git checkout main && git pull premium main`
2. Create: `git checkout -b story/EPIC9-006-bulk-operations`
3. Commit: Use conventional commits (feat:, fix:, docs:, etc.)
4. Push: `git push -u premium story/EPIC9-006-bulk-operations`
5. PR: Create PR to main branch with title "feat(EPIC9-006): Add bulk operations support for sitemap builder"

### Testing Standards
While no specific testing framework is configured for this project, testing approach should follow:
- **Manual Testing Priority**: Focus on user acceptance testing through the UI
- **Test Coverage Areas**:
  - Multi-select functionality with various selection methods
  - Bulk operations with partial success/failure scenarios
  - Performance with 10, 50, and 100 nodes
  - Keyboard shortcuts across Windows, Mac, Linux browsers
  - Undo/redo integration with bulk operations
- **Browser Testing**: Chrome 90+, Firefox 88+, Safari 14+, Edge 90+
- **Performance Targets**:
  - Selection operations: < 100ms response time for up to 100 nodes
  - Bulk operations: < 3 seconds for 100 nodes
  - UI should maintain 60 FPS during drag selection
- **Validation Approach**: 
  - Verify all acceptance criteria manually
  - Document any edge cases discovered
  - Test with realistic data volumes

### Previous Story Context
From Story 9.5 (Undo/Redo):
- UndoManager is fully integrated with Zustand store at `/lib/premium/components/sitemap/undo-manager.ts`
- Store already has `captureState()` method that pushes snapshots to undoManager
- All mutations (addNode, updateNode, deleteNodes, moveNode) already capture state
- SaveManager prevents saves during undo/redo operations

From Story 9.4 (Sitemap Connection):
- Zustand store exists at `/lib/premium/stores/sitemap-store.ts`
- Store has `selectedNodes: string[]` array already defined
- Store has `clearSelection()` method already implemented
- Basic node operations (add, update, delete, move) are working

### Technical Implementation Details

#### Store State Structure [Source: lib/premium/stores/sitemap-store.ts]
```typescript
interface SitemapState {
  nodes: SitemapNode[];
  edges: SitemapEdge[];
  selectedNodes: string[];  // Already exists for multi-select
  // ... other state
}
```

#### API Endpoint Location [Source: epic9-implementation-guide.md#Part2]
- Bulk operations endpoint: `/app/api/premium/sitemap/bulk/route.ts`
- URL endpoint: `/api/premium/sitemap/bulk`
- Must be under `/app/api/premium/` for premium isolation

#### Bulk Operations Request Format [Source: epic9-brownfield-prd.md#BulkOperations]
```json
{
  "operation": "DELETE|UPDATE_STATUS|MOVE",
  "ids": ["id1", "id2", "id3"],
  "data": { /* operation-specific data */ }
}
```

#### Bulk Operations Response Format [Source: epic9-brownfield-prd.md#BulkOperations]
```json
{
  "succeeded": ["id1", "id2"],
  "failed": [
    {
      "id": "id3",
      "error": "error message"
    }
  ]
}
```

#### Security Considerations [CRITICAL]
- **Authorization Checks**: All bulk operations MUST verify user permissions for EACH item
- **Rate Limiting**: Implement client-side throttling (max 1 bulk operation per second)
- **Batch Size Limits**: Maximum 100 items per bulk operation to prevent DoS
- **Input Validation**: Validate all node IDs before processing
- **Audit Logging**: Log all bulk operations with user ID, timestamp, and affected items
- **Error Information**: Never expose internal system details in error messages
- **CSRF Protection**: Ensure all API calls include proper CSRF tokens
- **Permission Cascade**: Verify parent-child permission inheritance for moves

#### Best-Effort Processing Approach [Source: epic9-brownfield-prd.md#FR-007]
- Process items individually, not in transaction
- Continue processing even if some fail
- Track success/failure per item
- Return detailed results for each operation
- Allow partial success scenarios

#### Visual Selection Requirements [Source: epic9-brownfield-prd.md#NFR-011]
- Clear visual feedback for all operations
- Selected nodes need distinct styling
- Selection count should be visible
- Consider accessibility (WCAG 2.1 AA compliance)

#### Performance Considerations [Source: epic9-brownfield-prd.md#NFR-002]
- System should handle ~100 nodes acceptably
- Bulk operations on 100 nodes should complete within reasonable time
- No specific performance target for bulk operations in MVP

#### File Placement Rules [Source: CLAUDE.md & epic9-implementation-guide.md]
- All components must be under `/lib/premium/components/sitemap/`
- API routes must be under `/app/api/premium/`
- Hooks must be under `/lib/premium/hooks/`
- NEVER place code in root `/components/` or `/lib/` directories

### Testing Standards
- No specific testing framework mentioned in architecture docs
- Focus on manual testing for MVP
- Test scenarios should cover:
  - Multi-select with various node counts (10, 50, 100)
  - Partial failure scenarios
  - Keyboard shortcuts on different OS
  - Memory usage with large selections

### Dependencies
- React Flow (v11.10.1) - already integrated
- Zustand store - already set up
- Existing UndoManager - for history integration
- Existing SaveManager - coordinates with save operations

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-26 | 1.0 | Initial story creation | Scrum Master (Bob) |
| 2025-08-26 | 1.1 | Fixed Git workflow, added testing standards, security considerations, improved task granularity per PO validation | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
[To be filled by Dev Agent]

### Debug Log References
[To be filled by Dev Agent]

### Completion Notes List
[To be filled by Dev Agent]

### File List
[To be filled by Dev Agent]

## QA Results
[To be filled by QA Agent]