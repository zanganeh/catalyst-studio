# Story 8.6: React Flow Canvas Setup

## Status
Draft

## Story Metadata
- **Epic**: Epic 8 - AI-Powered Site Structure Generation
- **Story ID**: 8.6
- **Story Points**: 5
- **Priority**: P1 (High)
- **Dependencies**: Story 8.1 (Database Schema), Story 8.2 (Slug Management), Story 8.3 (Page Orchestration API), Story 8.4 (Site Structure Service)
- **Risk Level**: Medium (Complex UI interactions and state management)
- **Estimated Duration**: 2 days

## Story

**As a** content manager,
**I want** a visual Miro-like canvas interface for viewing and managing site structures,
**So that** I can intuitively understand and modify the hierarchical relationships between pages without dealing with complex tree data structures.

## Background & Context

With the backend services complete (database schema, slug management, page orchestration, and site structure service), we need to implement the visual interface for site structure management. This story focuses on setting up the React Flow canvas with basic node and edge rendering, interaction capabilities, and state management.

**ðŸ”´ CRITICAL ARCHITECTURAL CONSTRAINT**: Per the Hybrid Orchestration Pattern, every SiteStructure node MUST have an associated ContentItem. The canvas must work with the UnifiedPageService to ensure atomic page operations and prevent orphaned nodes.

### Key Challenges
1. **Performance with Large Trees**: Rendering 500+ nodes without lag
2. **State Synchronization**: Keeping canvas state in sync with database
3. **Intuitive Interactions**: Drag-drop, pan, zoom that feels natural
4. **Responsive Design**: Works on various screen sizes

### MVP Scope Limitations
- Focus on core visualization and basic interactions
- No advanced features like undo/redo (future story)
- Basic styling only (detailed theming in future)
- Desktop-first (mobile optimization later)

## Acceptance Criteria

1. [ ] React Flow canvas component integrated into site structure page
2. [ ] Nodes render with proper hierarchy visualization
3. [ ] Edges connect parent-child relationships correctly
4. [ ] Pan and zoom controls work smoothly
5. [ ] Minimap provides overview navigation
6. [ ] Controls panel with zoom, fit-view, and layout buttons
7. [ ] Background grid pattern for spatial reference
8. [ ] Nodes are draggable to reposition (visual only, no persistence yet)
9. [ ] Canvas handles 500 nodes without performance degradation (< 100ms render)
10. [ ] State management with Zustand store for canvas state
11. [ ] Loading and error states properly handled
12. [ ] Component is properly typed with TypeScript

## Tasks / Subtasks

- [ ] Git Setup (REQUIRED FIRST TASK)
  - [ ] Checkout and update main: `git checkout main && git pull origin main`
  - [ ] Create feature branch: `git checkout -b feature/8-6-react-flow-canvas`

- [ ] Setup React Flow Canvas Component (AC: 1, 2, 3)
  - [ ] Create `/app/studio/[websiteId]/site-structure/page.tsx` for the main page
  - [ ] Create `/components/studio/site-structure/SiteStructureCanvas.tsx` main component
  - [ ] Configure React Flow with proper options and settings
  - [ ] Import and setup React Flow CSS styles

- [ ] Implement Node Components (AC: 2, 8)
  - [ ] Create `/components/studio/site-structure/nodes/PageNode.tsx` for page nodes
  - [ ] Create `/components/studio/site-structure/nodes/FolderNode.tsx` for folder/section nodes
  - [ ] Define node types configuration in `/components/studio/site-structure/config/nodeTypes.ts`
  - [ ] Style nodes to show hierarchy levels visually

- [ ] Implement Edge Components (AC: 3)
  - [ ] Create `/components/studio/site-structure/edges/HierarchicalEdge.tsx`
  - [ ] Configure edge types and styling
  - [ ] Ensure proper arrow markers for direction

- [ ] Add Canvas Controls (AC: 4, 5, 6, 7)
  - [ ] Implement pan and zoom functionality
  - [ ] Add MiniMap component with proper configuration
  - [ ] Add Controls component with zoom in/out, fit view
  - [ ] Add Background component with grid pattern
  - [ ] Create custom toolbar in `/components/studio/site-structure/CanvasToolbar.tsx`

- [ ] Setup State Management (AC: 10, 11)
  - [ ] Create `/lib/stores/siteStructureStore.ts` using Zustand
  - [ ] Define state interface for nodes, edges, and viewport
  - [ ] Implement actions for loading, updating, and error handling
  - [ ] Add optimistic updates support

- [ ] Integrate with Backend Services (AC: 2, 3, 11)
  - [ ] Create `/lib/hooks/useSiteStructure.ts` for data fetching
  - [ ] Transform site structure data to React Flow format
  - [ ] Handle loading states with skeleton/spinner
  - [ ] Handle error states with proper messaging

- [ ] Performance Optimization (AC: 9)
  - [ ] Implement node virtualization for large trees
  - [ ] Add memoization for expensive computations
  - [ ] Configure React Flow performance settings
  - [ ] Test with 500+ nodes dataset
  - [ ] Measure performance using:
    ```typescript
    // Performance measurement approach
    const measureRenderTime = () => {
      const startTime = performance.now();
      // Render operation
      const endTime = performance.now();
      const renderTime = endTime - startTime;
      console.assert(renderTime < 100, `Render time ${renderTime}ms exceeds 100ms limit`);
      return renderTime;
    };
    
    // Use React DevTools Profiler in development
    // Use Performance API for production measurements
    ```

- [ ] TypeScript Types (AC: 12)
  - [ ] Define types in `/lib/types/site-structure-canvas.types.ts`
  - [ ] Ensure all components are properly typed
  - [ ] Add JSDoc comments for complex types

- [ ] Testing
  - [ ] Unit tests for store actions and reducers
  - [ ] Component tests for node and edge rendering
  - [ ] Performance test with large dataset
  - [ ] Integration test for canvas interactions

- [ ] Submit PR (REQUIRED FINAL TASK)
  - [ ] Push branch: `git push -u origin feature/8-6-react-flow-canvas`
  - [ ] Create PR from feature branch â†’ main branch
  - [ ] PR Title: "Epic 8 Story 8.6: React Flow Canvas Setup"
  - [ ] Link PR to story in description

## Dev Notes

### GitFlow Workflow
Branch Name: feature/8-6-react-flow-canvas
Base Branch: main
PR Target: main

Git Commands:
1. Setup: `git checkout main && git pull origin main`
2. Create: `git checkout -b feature/8-6-react-flow-canvas`
3. Commit: Use conventional commits (feat:, fix:, docs:, etc.)
4. Push: `git push -u origin feature/8-6-react-flow-canvas`
5. PR: Create PR to main branch with title "Epic 8 Story 8.6: React Flow Canvas Setup"

### Technical Context

#### Existing React Flow Implementation
React Flow is already installed and used in the project. Reference implementation exists at:
- **Demo Page**: `/app/demo/sitemap-builder/page.tsx` - Full working example with custom nodes
- **Custom Nodes**: `/components/studio/sitemap/enhanced-nodes.tsx` - Enhanced node components
- **Layout Engine**: `/lib/sitemap/auto-layout.ts` - Auto-layout algorithms

[Source: Direct file inspection]

#### Site Structure Service Integration
The SiteStructureService provides the data layer:
- **Service**: `/lib/services/site-structure/site-structure-service.ts`
- **Repository**: `/lib/services/site-structure/site-structure-repository.ts`
- **Types**: `/lib/types/site-structure.types.ts`
- **Error Classes**: `/lib/services/site-structure/errors.ts` (from Story 8.4)
  - `SiteStructureError` - Base error class
  - `SiteStructureNotFoundError` - For missing nodes
  - `SiteStructureValidationError` - For validation failures
- **Error Handling Patterns**:
  ```typescript
  // Use in data fetching hook
  try {
    const structure = await siteStructureService.getTree(websiteId);
  } catch (error) {
    if (error instanceof SiteStructureNotFoundError) {
      // Handle missing structure - show empty state
      return { nodes: [], edges: [], isEmpty: true };
    }
    if (error instanceof SiteStructureValidationError) {
      // Handle validation errors - show error message
      toast.error(`Invalid structure: ${error.message}`);
    }
    // Generic error handling
    throw error;
  }
  ```
- Key method: `getTree(websiteId: string): Promise<TreeNode>`

[Source: lib/services/site-structure/site-structure-service.ts]

#### React Flow Configuration (from Architecture)
```typescript
// Based on architecture specifications
export const canvasConfig = {
  nodeTypes: {
    page: PageNode,
    section: SectionNode,
    external: ExternalLinkNode
  },
  edgeTypes: {
    hierarchical: HierarchicalEdge
  },
  defaultViewport: { x: 0, y: 0, zoom: 1 },
  minZoom: 0.1,
  maxZoom: 2,
  snapToGrid: true,
  snapGrid: [10, 10],
  nodesDraggable: true,
  nodesConnectable: true,
  elementsSelectable: true,
  selectNodesOnDrag: false,
  deleteKeyCode: ['Backspace', 'Delete'],
  multiSelectionKeyCode: ['Meta', 'Control'],
  layoutOptions: {
    direction: 'TB', // Top to Bottom
    spacing: [100, 150],
    algorithm: 'dagre'
  }
};
```
[Source: docs/epic8-brownfield-architecture.md#6.3]

#### Zustand Store Structure (from Architecture)
```typescript
interface SiteStructureState {
  // Data
  nodes: Node[];
  edges: Edge[];
  websiteId: string;
  
  // UI State
  selectedNodes: string[];
  hoveredNode: string | null;
  viewport: Viewport;
  isLoading: boolean;
  
  // Actions
  loadStructure: (websiteId: string) => Promise<void>;
  addNode: (parentId: string, data: NodeData) => Promise<void>;
  updateNode: (nodeId: string, updates: Partial<NodeData>) => Promise<void>;
  deleteNodes: (nodeIds: string[]) => Promise<void>;
  moveNode: (nodeId: string, newParentId: string) => Promise<void>;
  
  // Canvas Operations
  setViewport: (viewport: Viewport) => void;
  selectNodes: (nodeIds: string[]) => void;
  autoLayout: () => void;
  
  // Optimistic Updates
  optimisticUpdate: <T>(
    action: () => Promise<T>, 
    rollback: () => void
  ) => Promise<T>;
}
```

**Optimistic Update Rollback Pattern**:
```typescript
// Implementation pattern for optimistic updates with rollback
const optimisticUpdate = async <T>(
  action: () => Promise<T>,
  rollback: () => void
): Promise<T> => {
  // Save current state for rollback
  const previousState = {
    nodes: [...get().nodes],
    edges: [...get().edges],
  };
  
  try {
    // Execute the action
    const result = await action();
    return result;
  } catch (error) {
    // Rollback on failure
    set({
      nodes: previousState.nodes,
      edges: previousState.edges,
      error: error.message,
    });
    
    // Show error notification
    toast.error('Operation failed. Changes have been reverted.');
    throw error;
  }
};
```
[Source: docs/epic8-brownfield-architecture.md#6.2]

#### Performance Requirements
- **Node Capacity**: Support 500+ nodes without degradation
- **Frame Rate**: Maintain 60 FPS during interactions
- **Render Time**: < 100ms for initial render
- **URL Resolution**: < 10ms (backend requirement)

[Source: docs/epic8-brownfield-prd.md - NFR-001]

#### Data Transformation
Site structure nodes from the database need to be transformed to React Flow format:
```typescript
// Transform database node to React Flow node
interface TransformFunction {
  (dbNode: SiteStructure): Node<EnhancedNodeData>
}

// The transformation should:
// 1. Map SiteStructure.id to Node.id
// 2. Determine node type based on content
// 3. Calculate position based on hierarchy
// 4. Include metadata for enhanced features
```

### File Structure to Create
```
app/studio/[websiteId]/site-structure/
  â””â”€â”€ page.tsx                          # Main page component

components/studio/site-structure/
  â”œâ”€â”€ SiteStructureCanvas.tsx           # Main canvas component
  â”œâ”€â”€ CanvasToolbar.tsx                 # Custom toolbar
  â”œâ”€â”€ nodes/
  â”‚   â”œâ”€â”€ PageNode.tsx                  # Page node component
  â”‚   â””â”€â”€ FolderNode.tsx                # Folder/section node
  â”œâ”€â”€ edges/
  â”‚   â””â”€â”€ HierarchicalEdge.tsx         # Custom edge component
  â””â”€â”€ config/
      â””â”€â”€ nodeTypes.ts                  # Node type configurations

lib/
  â”œâ”€â”€ stores/
  â”‚   â””â”€â”€ siteStructureStore.ts        # Zustand store
  â”œâ”€â”€ hooks/
  â”‚   â””â”€â”€ useSiteStructure.ts          # Data fetching hook
  â””â”€â”€ types/
      â””â”€â”€ site-structure-canvas.types.ts # TypeScript types
```


### Dependencies and Imports
The project uses:
- **React Flow**: Already installed (`reactflow` package)
- **Zustand**: For state management
- **TypeScript**: Strict mode enabled
- **Tailwind CSS**: For styling
- **Lucide React**: For icons

### Important Notes from Previous Stories
- Story 8.5 implemented the AI Site Generator Service with mock data for testing
- The UnifiedPageService ensures atomic page creation (content + structure)
- Site structure uses hybrid storage pattern (adjacency list + materialized path)
- Every SiteStructure node MUST have an associated ContentItem

## Testing

### Test Data Generation
For performance testing with 500+ nodes, create a test data generator:

```typescript
// Generate test tree structure with specified depth and breadth
function generateTestSiteStructure(options: {
  totalNodes: number,  // Target: 500
  maxDepth: number,    // Suggested: 5
  avgChildrenPerNode: number  // Suggested: 3-5
}): TreeNode[]

// Test data should include:
// - Varied node types (pages, sections, external links)
// - Realistic content (titles, slugs, descriptions)
// - Deep nesting (at least 5 levels)
// - Wide branches (some nodes with 10+ children)
```

### Unit Tests
**Location**: `/components/studio/site-structure/__tests__/`
- Test canvas component renders with mock data
- Test node drag interactions update position state
- Test zoom/pan controls modify viewport correctly
- Test store actions and state updates

### Integration Tests  
**Location**: `/tests/integration/site-structure/`
- Test data fetching and transformation from backend
- Test error handling for failed API calls
- Test optimistic updates and rollback on failure

### Performance Tests
**Location**: `/tests/performance/`
- Load 500 nodes and measure render time (must be < 100ms)
- Test smooth interactions at 60 FPS with large dataset
- Memory usage should stay under 100MB for 500 nodes
- Profile React Flow render cycles for optimization

### E2E Tests
**Location**: `/tests/e2e/`
- Full user flow: Load page â†’ View structure â†’ Drag nodes â†’ Save changes
- Test canvas controls (zoom, pan, fit-to-view)
- Verify minimap navigation works correctly

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-22 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-08-23 | 1.1 | Fixed issues from PO validation: Added Hybrid Orchestration Pattern reference, error classes from Story 8.4, proper Testing section with test data generation approach | Bob (Scrum Master) |
| 2025-08-24 | 1.2 | Addressed PO feedback: Added error handling examples, performance measurement strategy, and optimistic update rollback pattern | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be populated by dev agent*

### Debug Log References
*To be populated by dev agent*

### Completion Notes List
*To be populated by dev agent*

### File List
*To be populated by dev agent*

## QA Results
*To be populated by QA agent*