# Story 9.5: Complete Undo/Redo Integration

## Status
Draft

## Story
**As a** sitemap builder user,
**I want** to use undo and redo functionality through keyboard shortcuts and UI buttons,
**so that** I can confidently make changes knowing I can easily revert mistakes.

## Acceptance Criteria
1. Existing UndoManager (from 9.4) integrated with Zustand store for all operations
2. Keyboard shortcuts work: Ctrl+Z/Cmd+Z for undo, Ctrl+Y/Ctrl+Shift+Z/Cmd+Shift+Z for redo
3. UI buttons show undo/redo availability (enabled/disabled states)
4. History clears future states when new action performed after undo
5. State preservation includes all node and edge data (via existing UndoManager)
6. Component configurations preserved in history snapshots
7. Parent-child relationships maintained correctly through undo/redo
8. Undo/redo operations complete within 100ms
9. Memory efficient with automatic cleanup beyond 50 states (already in UndoManager)
10. Visual feedback shows what changed during undo/redo
11. History persists during the session but not across page refreshes
12. Integration with save manager prevents saves during undo/redo operations

## Tasks / Subtasks
- [ ] Git Setup (REQUIRED FIRST TASK)
  - [ ] Checkout and update main: `git checkout main && git pull premium main`
  - [ ] Checkout epic branch: `git checkout epic/epic-9-sitemap-builder`
  - [ ] Create story branch from epic: `git checkout -b story/EPIC9-005-undo-redo-integration`
- [ ] Verify Existing Components from Story 9.4
  - [ ] Verify UndoManager exists and works at `/lib/premium/components/sitemap/undo-manager.ts`
  - [ ] Review UndoManager implementation (already has 50-state limit, push, undo, redo methods)
  - [ ] Verify SaveManager exists at `/lib/premium/components/sitemap/save-manager.ts`
  - [ ] Verify Zustand store exists at `/lib/premium/stores/sitemap-store.ts`
  - [ ] Check current store integration status with UndoManager
- [ ] Integrate Existing UndoManager with Zustand Store (AC: 1, 4, 5, 6, 7, 12)
  - [ ] Import existing undoManager singleton in sitemap-store.ts
  - [ ] Add canUndo/canRedo state properties to store
  - [ ] Create captureState() method to push snapshots to undoManager
  - [ ] Hook captureState() into all mutation actions (addNode, updateNode, deleteNodes, moveNode)
  - [ ] Add undo action that applies state from undoManager.undo()
  - [ ] Add redo action that applies state from undoManager.redo()
  - [ ] Subscribe to undoManager.onStateChange to update canUndo/canRedo
  - [ ] Prevent SaveManager from saving during undo/redo operations
  - [ ] Test state preservation includes component configurations
  - [ ] Verify parent-child relationships maintained
- [ ] Create Keyboard Shortcut Hook (AC: 2)
  - [ ] Create `/lib/premium/hooks/use-undo-redo-shortcuts.ts`
  - [ ] Import store's undo/redo/canUndo/canRedo from Zustand
  - [ ] Register Ctrl+Z/Cmd+Z for undo
  - [ ] Register Ctrl+Y for redo (Windows/Linux)
  - [ ] Register Ctrl+Shift+Z/Cmd+Shift+Z for redo (cross-platform)
  - [ ] Connect shortcuts to store actions
  - [ ] Prevent default browser behavior
  - [ ] Add cleanup on unmount
- [ ] Create UI Components (AC: 3, 10)
  - [ ] Create `/lib/premium/components/sitemap/undo-redo-buttons.tsx`
  - [ ] Connect to store's canUndo/canRedo state
  - [ ] Add undo button with disabled state when !canUndo
  - [ ] Add redo button with disabled state when !canRedo
  - [ ] Show tooltips with keyboard shortcuts
  - [ ] Optional: Add description of last action to undo/redo
  - [ ] Style with existing UI patterns from story 9.4
- [ ] Add Visual Feedback (AC: 10)
  - [ ] Create highlight effect for nodes that changed
  - [ ] Add toast notification showing what was undone/redone
  - [ ] Implement smooth transitions between states
  - [ ] Use framer-motion if available, CSS transitions otherwise
  - [ ] Test visual feedback is clear and helpful
- [ ] Integrate Everything into Demo Page (AC: 11)
  - [ ] Import undo-redo components in `/app/premium/demo/sitemap-builder/page.tsx`
  - [ ] Add keyboard shortcut hook to page
  - [ ] Place undo/redo buttons in toolbar
  - [ ] Initialize undoManager with initial state on load
  - [ ] Ensure history clears on page refresh (no persistence)
  - [ ] Verify undoManager singleton works across components
- [ ] Performance Optimization & Testing (AC: 8)
  - [ ] Verify UndoManager's existing structural sharing works
  - [ ] Profile undo/redo operations to ensure <100ms
  - [ ] Test with 50 operations to verify performance
  - [ ] Check memory usage doesn't grow unbounded
  - [ ] Optimize if needed (but UndoManager likely already optimized)
- [ ] Write Unit Tests
  - [ ] Test Zustand store integration with UndoManager
  - [ ] Test keyboard shortcut hook functionality
  - [ ] Test UI button state management
  - [ ] Test save prevention during undo/redo
  - [ ] Test state consistency after undo/redo
  - [ ] Verify existing UndoManager tests still pass
- [ ] Write Integration Tests
  - [ ] Test full undo/redo flow in demo with real operations
  - [ ] Test keyboard shortcuts work in browser
  - [ ] Test UI buttons enable/disable correctly
  - [ ] Test visual feedback displays properly
  - [ ] Test 50-operation limit enforcement
  - [ ] Test future history clearing on new action
- [ ] Documentation
  - [ ] Document keyboard shortcuts in UI
  - [ ] Add usage instructions to demo page
  - [ ] Update story file with implementation notes
  - [ ] Document integration approach for future reference
- [ ] Submit PR (REQUIRED FINAL TASK)
  - [ ] Run linting: `npm run lint`
  - [ ] Run tests: `npm test`
  - [ ] Push branch: `git push -u premium story/EPIC9-005-undo-redo-integration`
  - [ ] Create PR from story/EPIC9-005-undo-redo-integration → epic/epic-9-sitemap-builder
  - [ ] PR Title: "feat(EPIC9-005): integrate undo/redo system with UI and keyboard shortcuts"
  - [ ] Link PR to this story in description
  - [ ] Include screenshots/GIF of undo/redo in action

## Dev Notes

### GitFlow Workflow
**CRITICAL: Follow GitFlow strictly for this story**

Branch Name: story/EPIC9-005-undo-redo-integration
Base Branch: epic/epic-9-sitemap-builder
PR Target: epic/epic-9-sitemap-builder

Git Commands:
1. Setup: `git checkout main && git pull premium main`
2. Checkout epic: `git checkout epic/epic-9-sitemap-builder` 
3. Create story branch: `git checkout -b story/EPIC9-005-undo-redo-integration`
4. Commit: Use conventional commits (feat:, fix:, docs:, etc.)
5. Push: `git push -u premium story/EPIC9-005-undo-redo-integration`
6. PR: Create PR to epic/epic-9-sitemap-builder branch

### Premium Feature Placement Requirements
[Source: docs/epic9-brownfield-prd.md#premium-feature-placement-requirements]

**CRITICAL**: All sitemap code MUST be placed under premium folders:
```
✅ CORRECT Premium Locations:
/lib/premium/components/sitemap/     # UndoManager already here from 9.4
/lib/premium/hooks/                  # New keyboard shortcut hook goes here
/lib/premium/stores/                 # Zustand store already exists from 9.4

❌ FORBIDDEN Locations:
/components/                         # Will leak to open-source
/lib/ (root)                        # Will leak to open-source
/hooks/                             # Will leak to open-source
```

### Existing UndoManager from Story 9.4
[Source: Verified in `/lib/premium/components/sitemap/undo-manager.ts`]

**IMPORTANT**: UndoManager was already implemented in Story 9.4 with the following features:
- Complete class implementation with all required methods
- 50-operation history limit enforced
- State snapshots with deep copying
- canUndo() and canRedo() methods
- onStateChange callback for UI updates
- Singleton instance exported as `undoManager`

**What This Story Needs to Do**:
1. INTEGRATE the existing UndoManager with Zustand store (not implemented yet)
2. ADD keyboard shortcut support (not implemented yet)
3. CREATE UI buttons for undo/redo (not implemented yet)
4. ADD visual feedback for operations (not implemented yet)
5. PREVENT saves during undo/redo (integration needed)

### Integration Pattern with Existing UndoManager
[Source: Story 9.4 implementation analysis]

The existing UndoManager class structure:
```typescript
// Already exists in undo-manager.ts
export class UndoManager {
  pushState(nodes: SitemapNode[], edges: SitemapEdge[]) // Adds to history
  undo(): HistoryState | null                           // Returns previous state
  redo(): HistoryState | null                           // Returns next state
  canUndo(): boolean                                    // UI state check
  canRedo(): boolean                                    // UI state check
  clear()                                               // Reset history
  initialize(nodes, edges)                              // Set initial state
}

// Singleton already exported
export const undoManager = new UndoManager();
```

### Zustand Store Integration Approach
[Source: Story 9.4 store structure]

Extend the existing store to work with the existing UndoManager:
```typescript
// Add to existing sitemap-store.ts
interface SiteStructureState {
  // Existing properties from 9.4
  nodes: Node[]
  edges: Edge[]
  
  // New properties for undo/redo
  canUndo: boolean
  canRedo: boolean
  
  // Existing actions to hook into
  addNode: (parentId: string, data: NodeData) => void    // Hook: capture state after
  updateNode: (nodeId: string, updates: Partial) => void  // Hook: capture state after
  deleteNodes: (nodeIds: string[]) => void                // Hook: capture state after
  moveNode: (nodeId: string, newParentId: string) => void // Hook: capture state after
  
  // New actions for undo/redo
  undo: () => void  // Apply state from undoManager.undo()
  redo: () => void  // Apply state from undoManager.redo()
  
  // Helper to capture current state
  captureState: () => void  // Push current nodes/edges to undoManager
}
```

### Save Prevention During Undo/Redo
[Source: Story 9.4 SaveManager]

The SaveManager from Story 9.4 needs to check if an undo/redo is in progress:
```typescript
// Pattern to prevent saves during undo/redo
let isUndoRedoInProgress = false;

// In undo action
isUndoRedoInProgress = true;
const state = undoManager.undo();
if (state) {
  set({ nodes: state.nodes, edges: state.edges });
}
isUndoRedoInProgress = false;

// In SaveManager integration
if (!isUndoRedoInProgress) {
  saveManager.addOperation(operation);
}
```

### Keyboard Shortcut Implementation
[Source: docs/epic9-brownfield-prd.md#user-interface-integration]

**Cross-platform Support Pattern**:
```typescript
// New file: /lib/premium/hooks/use-undo-redo-shortcuts.ts
export function useUndoRedoShortcuts() {
  const { undo, redo, canUndo, canRedo } = useSitemapStore()
  
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0
      const ctrlOrCmd = isMac ? e.metaKey : e.ctrlKey
      
      if (ctrlOrCmd && e.key === 'z' && !e.shiftKey) {
        e.preventDefault()
        if (canUndo) undo()
      } else if (
        (ctrlOrCmd && e.key === 'y') || 
        (ctrlOrCmd && e.shiftKey && e.key === 'z')
      ) {
        e.preventDefault()
        if (canRedo) redo()
      }
    }
    
    document.addEventListener('keydown', handleKeyDown)
    return () => document.removeEventListener('keydown', handleKeyDown)
  }, [undo, redo, canUndo, canRedo])
}
```

### Visual Feedback Requirements
[Source: docs/epic9-brownfield-prd.md#user-experience]

- Toast notifications showing action description
- Highlight affected nodes temporarily (1-2 seconds)
- Smooth transitions between states
- Consider using framer-motion if available

### Testing Approach
[Source: Story 9.4 patterns]

**Focus Areas**:
1. Integration between UndoManager and Zustand store
2. Keyboard shortcuts on Windows, Mac, Linux
3. UI button states sync with canUndo/canRedo
4. Save prevention during undo/redo
5. Performance with 50 operations
6. Memory usage doesn't grow unbounded

### Dependencies and Versions
[Source: Story 9.4, package.json]

```json
{
  "reactflow": "^11.11.4",    // Already installed
  "zustand": "^5.0.7",         // Already installed  
  "immer": "^10.1.1",          // Already installed
  "framer-motion": "^10.x"    // Check if available for animations
}
```

### Lessons from Story 9.4 Implementation

**What Worked Well**:
- UndoManager class is complete and tested
- Singleton pattern allows global access
- 50-state limit already enforced
- Deep copying prevents mutation issues

**What Needs Integration**:
- Connection to Zustand store actions
- UI components for user interaction
- Keyboard shortcut handling
- Visual feedback system
- Save prevention logic

### Performance Considerations

Since UndoManager already exists with deep copying via JSON.parse/stringify:
- Monitor performance with large sitemaps
- Consider using Immer for structural sharing if performance issues
- Profile undo/redo operations to ensure <100ms
- The existing implementation should be sufficient for MVP

## Testing

### Unit Test Requirements
- Location: `/lib/premium/stores/__tests__/sitemap-store.test.ts` (extend existing)
- Test store integration with UndoManager
- Test canUndo/canRedo state updates
- Test save prevention during undo/redo

### Integration Test Requirements  
- Location: `/app/premium/demo/sitemap-builder/__tests__/`
- Test full user flow with keyboard and buttons
- Verify visual feedback works
- Test with 50 operations

### Manual Testing Checklist
- [ ] Existing UndoManager methods work correctly
- [ ] Zustand store properly captures state after operations
- [ ] Undo/redo buttons enable/disable correctly
- [ ] Keyboard shortcuts work on Windows
- [ ] Keyboard shortcuts work on Mac
- [ ] History limit of 50 enforced (already in UndoManager)
- [ ] Future history clears on new action
- [ ] No saves occur during undo/redo
- [ ] Visual feedback displays properly
- [ ] Performance acceptable (<100ms)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-26 | 1.0 | Initial story creation for undo/redo system | Scrum Master |
| 2025-08-26 | 2.0 | Major revision: Acknowledged existing UndoManager, reframed as integration story | Scrum Master |

## Dev Agent Record
### Agent Model Used
[To be filled by Dev Agent]

### Debug Log References
[To be filled by Dev Agent]

### Completion Notes List
[To be filled by Dev Agent]

### File List
[To be filled by Dev Agent]

## QA Results
[To be filled by QA Agent]