# Story 9.3: Auto-Layout Engine Integration

## Status
Approved

## Story
**As a** developer using the sitemap builder,
**I want** automatic layout positioning for nodes,
**so that** the sitemap is organized visually without manual positioning.

## Acceptance Criteria
1. Dagre library is installed and configured in the project
2. Layout engine module is created under `/lib/premium/components/sitemap/layout/`
3. Auto-layout function calculates positions for all nodes without overlap
4. Layout configuration supports top-to-bottom hierarchy (rankdir: 'TB')
5. Node separation is configured (100px horizontal, 150px vertical)
6. Standard node dimensions are defined (320x200 pixels)
7. Layout engine can handle both pages and folders
8. Positions are calculated based on parent-child relationships
9. Layout function returns nodes with updated positions
10. TypeScript types are properly defined for layout inputs/outputs
11. Layout calculations complete in under 500ms for up to 100 nodes
12. Error handling gracefully manages circular dependencies and invalid graphs

## Tasks / Subtasks
- [ ] Git Setup (REQUIRED FIRST TASK)
  - [ ] Checkout and update main: `git checkout main && git pull premium main`
  - [ ] Checkout epic branch: `git checkout epic/epic-9-sitemap-builder`
  - [ ] Create story branch from epic: `git checkout -b story/EPIC9-003-layout-engine`
- [ ] Install Dagre Dependencies (AC: 1)
  - [ ] Run: `npm install dagre@^0.8.5`
  - [ ] Run: `npm install --save-dev @types/dagre@^0.8.2`
  - [ ] Verify installation in package.json
  - [ ] Test that imports work without TypeScript errors
- [ ] Create Layout Engine Directory Structure (AC: 2)
  - [ ] Create directory: `/lib/premium/components/sitemap/layout/`
  - [ ] Create main layout engine file: `dagre-layout.ts`
  - [ ] Create types file: `types.ts`
  - [ ] Create configuration file: `config.ts`
- [ ] Define TypeScript Types (AC: 10)
  - [ ] Create `/lib/premium/components/sitemap/layout/types.ts`
  - [ ] Define LayoutNode interface with id, type, data, position
  - [ ] Define LayoutEdge interface with id, source, target
  - [ ] Define LayoutConfig interface with graph settings
  - [ ] Define LayoutResult interface with positioned nodes
  - [ ] Export all types for use in other modules
- [ ] Implement Layout Configuration (AC: 4, 5, 6)
  - [ ] Create `/lib/premium/components/sitemap/layout/config.ts`
  - [ ] Define DEFAULT_LAYOUT_CONFIG with rankdir: 'TB'
  - [ ] Set nodesep: 100 (horizontal spacing between nodes)
  - [ ] Set ranksep: 150 (vertical spacing between ranks)
  - [ ] Set NODE_WIDTH: 320 and NODE_HEIGHT: 200
  - [ ] Add margins (marginx: 50, marginy: 50)
  - [ ] Export configuration for use in layout engine
- [ ] Implement Core Layout Engine (AC: 3, 7, 8, 9)
  - [ ] Create `/lib/premium/components/sitemap/layout/dagre-layout.ts`
  - [ ] Import dagre and type definitions
  - [ ] Create calculateLayout function accepting nodes and edges
  - [ ] Initialize dagre graph with configuration
  - [ ] Add nodes to graph with dimensions
  - [ ] Add edges to graph for parent-child relationships
  - [ ] Run dagre.layout() to calculate positions
  - [ ] Map calculated positions back to nodes
  - [ ] Return nodes with updated x,y positions
- [ ] Create Layout Utilities (AC: 7, 8, 12)
  - [ ] Create helper function to identify node type (page/folder)
  - [ ] Create function to validate parent-child relationships
  - [ ] Create function to handle orphaned nodes
  - [ ] Add error handling for invalid graph structures
  - [ ] Implement circular dependency detection and handling
  - [ ] Add performance monitoring for large graphs
- [ ] Create Export Module (AC: 2, 9)
  - [ ] Create `/lib/premium/components/sitemap/layout/index.ts`
  - [ ] Export calculateLayout as main function
  - [ ] Export types for external use
  - [ ] Export configuration constants
  - [ ] Add JSDoc comments for API documentation
- [ ] Test Layout Engine (AC: 3, 4, 5, 6, 7, 8, 9, 11, 12)
  - [ ] Create test file `/lib/premium/components/sitemap/layout/__tests__/dagre-layout.test.ts`
  - [ ] Test that positions are calculated correctly
  - [ ] Test that no nodes overlap
  - [ ] Test hierarchy is maintained (top-to-bottom)
  - [ ] Test spacing between nodes matches configuration
  - [ ] Test with both pages and folders
  - [ ] Test with complex nested structures
  - [ ] Test performance: verify <500ms for 100 nodes
  - [ ] Test circular dependency handling
  - [ ] Verify TypeScript compilation succeeds
- [ ] Integration Preparation
  - [ ] Document how to use the layout engine in sitemap builder
  - [ ] Create example usage code snippet
  - [ ] Note any React Flow specific considerations
  - [ ] Document expected input/output formats
- [ ] Submit PR (REQUIRED FINAL TASK)
  - [ ] Push branch: `git push -u premium story/EPIC9-003-layout-engine`
  - [ ] Create PR from story branch → epic/epic-9-sitemap-builder branch
  - [ ] PR Title: "feat(EPIC9-003): integrate dagre auto-layout engine"
  - [ ] Link PR to story in description
  - [ ] Include test results showing layout calculations

## Dev Notes

### GitFlow Workflow
**CRITICAL: Follow GitFlow strictly for this story**

Branch Name: story/EPIC9-003-layout-engine
Base Branch: epic/epic-9-sitemap-builder
PR Target: epic/epic-9-sitemap-builder

Git Commands:
1. Setup: `git checkout main && git pull premium main`
2. Checkout epic: `git checkout epic/epic-9-sitemap-builder`
3. Create story branch from epic: `git checkout -b story/EPIC9-003-layout-engine`
4. Commit: Use conventional commits (feat:, fix:, docs:, etc.)
5. Push: `git push -u premium story/EPIC9-003-layout-engine`
6. PR: Create PR to epic/epic-9-sitemap-builder branch with title "feat(EPIC9-003): integrate dagre auto-layout engine"

### Premium Feature Placement Requirements
[Source: epic9-brownfield-prd.md#component-architecture]

**CRITICAL**: All layout engine code MUST be placed under `/lib/premium/` folders:
```
✅ CORRECT Premium Locations:
/lib/premium/components/sitemap/layout/   # Layout engine location
  ├── dagre-layout.ts                     # Main layout algorithm
  ├── types.ts                            # TypeScript type definitions
  ├── config.ts                           # Layout configuration
  └── index.ts                            # Public API exports

❌ FORBIDDEN Locations (will leak to open-source):
/components/sitemap/layout/               # WRONG - Common components
/lib/layout/                              # WRONG - Not under premium
/app/sitemap/layout/                      # WRONG - App directory
```

### Dagre Configuration
[Source: epic9-brownfield-architecture.md#auto-layout-with-dagre]

**Graph Configuration**:
```typescript
const dagreGraph = new dagre.graphlib.Graph();
dagreGraph.setGraph({ 
  rankdir: 'TB',     // Top to bottom layout
  nodesep: 100,      // Horizontal spacing between nodes
  ranksep: 150,      // Vertical spacing between ranks
  marginx: 50,       // Horizontal margin
  marginy: 50        // Vertical margin
});
dagreGraph.setDefaultEdgeLabel(() => ({}));
```

**Node Dimensions**:
- Width: 320px (to accommodate component lists)
- Height: 200px (to show page/folder details)

### Implementation Example
[Source: epic9-implementation-guide.md#auto-layout-algorithm]

```typescript
// lib/premium/components/sitemap/layout/dagre-layout.ts
import dagre from 'dagre';
import { LayoutNode, LayoutEdge, LayoutConfig } from './types';

export function calculateLayout(
  nodes: LayoutNode[], 
  edges: LayoutEdge[],
  config?: Partial<LayoutConfig>
): LayoutNode[] {
  const g = new dagre.graphlib.Graph();
  
  // Apply configuration
  g.setGraph({
    rankdir: config?.rankdir || 'TB',
    nodesep: config?.nodesep || 100,
    ranksep: config?.ranksep || 150,
    marginx: config?.marginx || 50,
    marginy: config?.marginy || 50
  });
  
  g.setDefaultEdgeLabel(() => ({}));
  
  // Add nodes with dimensions
  nodes.forEach(node => {
    g.setNode(node.id, { 
      width: 320,
      height: 200
    });
  });
  
  // Add edges
  edges.forEach(edge => {
    g.setEdge(edge.source, edge.target);
  });
  
  // Calculate positions
  dagre.layout(g);
  
  // Map positions back to nodes
  return nodes.map(node => {
    const dagreNode = g.node(node.id);
    return {
      ...node,
      position: {
        x: dagreNode.x - 160, // Center node (width/2)
        y: dagreNode.y - 100  // Center node (height/2)
      }
    };
  });
}
```

### Type Definitions
```typescript
// lib/premium/components/sitemap/layout/types.ts
export interface LayoutNode {
  id: string;
  type: 'page' | 'folder';
  data: {
    label: string;
    [key: string]: any;
  };
  position?: {
    x: number;
    y: number;
  };
}

export interface LayoutEdge {
  id: string;
  source: string;
  target: string;
}

export interface LayoutConfig {
  rankdir: 'TB' | 'BT' | 'LR' | 'RL';
  nodesep: number;
  ranksep: number;
  marginx: number;
  marginy: number;
}
```

### Testing Requirements
[Source: epic9-brownfield-architecture.md#testing-strategy]

**Layout Engine Testing**:
1. Test with simple tree (3-5 nodes)
2. Test with complex tree (20+ nodes)
3. Test with multiple levels of nesting
4. Verify no overlapping positions
5. Verify correct parent-child positioning
6. Test with orphaned nodes
7. Test with circular dependencies (should handle gracefully)

**Manual Testing**:
- Create a test script that generates sample data
- Visualize output positions to verify layout
- Check that all nodes are positioned
- Verify spacing matches configuration

### Integration Points
The layout engine will be used by:
- Sitemap builder UI (to position nodes automatically)
- Save functionality (positions need to be persisted)
- Undo/redo system (position changes are operations)
- Export functionality (to generate visual sitemap)

### Dependencies
- dagre: ^0.8.5 (graph layout library)
- @types/dagre: ^0.8.2 (TypeScript definitions)
- React Flow will consume the positioned nodes

### Technical Constraints
- Must work with React Flow node format
- Should handle up to 100 nodes efficiently
- Position calculations should complete in <500ms
- Must maintain hierarchical relationships
- Should handle edge cases (orphans, cycles)
- TypeScript strict mode compliance required

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-25 | 1.0 | Initial story creation for layout engine integration | Scrum Master |
| 2025-08-25 | 1.1 | Applied PO feedback: Fixed branch naming to EPIC9-003, added performance and error handling criteria | Scrum Master |

## Dev Agent Record
### Agent Model Used
[To be filled by Dev Agent]

### Debug Log References
[To be filled by Dev Agent]

### Completion Notes List
[To be filled by Dev Agent]

### File List
[To be filled by Dev Agent]

## QA Results
[To be filled by QA Agent]