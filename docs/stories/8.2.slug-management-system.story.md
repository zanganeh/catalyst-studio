# Story 8.2: Slug Management System

## Status
Appved

## Story Metadata
- **Epic**: Epic 8 - AI-Powered Site Structure Generation
- **Story ID**: 8.2
- **Story Points**: 3
- **Priority**: P0 (Critical)
- **Dependencies**: Story 8.1 (Database Schema Implementation)
- **Risk Level**: Low
- **Estimated Duration**: 1 day

## Story

**As a** developer,
**I want** to implement a slug generation and validation system,
**So that** we can ensure unique, SEO-friendly URLs at each hierarchy level with automatic conflict resolution.

## Background & Context

Following the database schema implementation in Story 8.1, we need to build the slug management utilities that will generate, validate, and ensure uniqueness of slugs within the site structure hierarchy. This system is critical for maintaining URL integrity and SEO-friendliness across the entire site structure.

### Key Design Decisions
- **Sibling Uniqueness**: Slugs must be unique among siblings (same parent)
- **Case-Insensitive Validation**: Prevent duplicate slugs with different cases
- **URL-Safe Characters**: Enforce alphanumeric + hyphens only
- **Automatic Conflict Resolution**: Add numeric suffixes for duplicates
- **Reserved Slug Protection**: Prevent use of system-reserved slugs

## Acceptance Criteria

1. [ ] Slug generation utility converts titles to URL-safe slugs
2. [ ] Case-insensitive uniqueness validation implemented
3. [ ] URL-safe character enforcement (alphanumeric + hyphens only)
4. [ ] Automatic slug generation from page titles
5. [ ] Duplicate handling with numeric suffixes (-1, -2, etc.)
6. [ ] Reserved slug list protection (api, admin, static, _next)
7. [ ] Unit tests with 90%+ coverage for slug utilities
8. [ ] Integration tests validating slug uniqueness at database level
9. [ ] Performance: slug generation < 5ms, validation < 10ms
10. [ ] Error handling with custom SlugConflictError class

## Tasks / Subtasks

- [ ] **Git Setup** (REQUIRED FIRST TASK)
  - [ ] Checkout and update main: `git checkout main && git pull origin main`
  - [ ] Create feature branch: `git checkout -b feature/8-2-slug-management`

- [ ] **Create Slug Utilities Module** (AC: 1, 3, 4)
  - [ ] Create `lib/services/site-structure/slug-manager.ts`
  - [ ] Implement `generateSlug(title: string): string` function
    - [ ] Convert to lowercase
    - [ ] Replace spaces and special chars with hyphens
    - [ ] Remove consecutive hyphens
    - [ ] Trim hyphens from start/end
    - [ ] Enforce max length of 255 characters
  - [ ] Add TypeScript interfaces for slug operations

- [ ] **Implement Slug Validation** (AC: 2, 6)
  - [ ] Create `validateSlug(slug: string): boolean` function
    - [ ] Check regex pattern: `/^[a-z0-9-]+$/`
    - [ ] Verify max length (255 chars)
    - [ ] Check against reserved slugs array
  - [ ] Create `RESERVED_SLUGS` constant array: ['api', 'admin', 'static', '_next']
  - [ ] Add case-insensitive comparison logic

- [ ] **Build Uniqueness Checker** (AC: 2, 5)
  - [ ] Create `lib/services/site-structure/slug-validator.ts`
  - [ ] Implement `checkSlugUniqueness(slug: string, parentId: string | null, websiteId: string): Promise<boolean>`
    - [ ] Query database for existing slugs at same parent level
    - [ ] Use Prisma to check SiteStructure table
    - [ ] Handle case-insensitive comparison
  - [ ] Implement `ensureUniqueSlug(baseSlug: string, parentId: string | null, websiteId: string): Promise<string>`
    - [ ] Check if base slug is available
    - [ ] If taken, append numeric suffix (-1, -2, etc.)
    - [ ] Loop until unique slug found
    - [ ] Return final unique slug

- [ ] **Create Error Classes** (AC: 10)
  - [ ] Create `lib/services/site-structure/errors.ts`
  - [ ] Implement `SlugConflictError` class extending base Error
  - [ ] Add properties: slug, parentId, statusCode (409)
  - [ ] Implement `InvalidSlugError` for validation failures
  - [ ] Add proper error messages and codes

- [ ] **Write Unit Tests** (AC: 7)
  - [ ] Create `lib/services/site-structure/__tests__/slug-manager.test.ts`
    - [ ] Test slug generation with various inputs
    - [ ] Test special character handling
    - [ ] Test length truncation
    - [ ] Test edge cases (empty string, only special chars)
  - [ ] Create `lib/services/site-structure/__tests__/slug-validator.test.ts`
    - [ ] Test validation rules
    - [ ] Test reserved slug detection
    - [ ] Test case-insensitive validation
  - [ ] Ensure 90%+ code coverage

- [ ] **Write Integration Tests** (AC: 8)
  - [ ] Create `lib/services/site-structure/__tests__/slug-integration.test.ts`
  - [ ] Test database uniqueness constraint
  - [ ] Test concurrent slug creation
  - [ ] Test parent-child slug relationships
  - [ ] Test slug conflict resolution with real database

- [ ] **Performance Testing** (AC: 9)
  - [ ] Add performance benchmarks to tests
  - [ ] Verify slug generation < 5ms
  - [ ] Verify validation queries < 10ms
  - [ ] Document performance results in test comments

- [ ] **Documentation**
  - [ ] Add JSDoc comments to all public functions
  - [ ] Create usage examples in comments
  - [ ] Document error scenarios and handling

- [ ] **Submit PR** (REQUIRED FINAL TASK)
  - [ ] Run all tests: `npm test`
  - [ ] Run type check: `npm run typecheck`
  - [ ] Commit with message: `feat: implement slug management system for site structures`
  - [ ] Push branch: `git push -u origin feature/8-2-slug-management`
  - [ ] Create PR from feature branch → main branch
  - [ ] PR Title: "Epic 8 Story 8.2: Slug Management System"
  - [ ] Link PR to story in description

## Dev Notes

### Previous Story Context
From Story 8.1:
- SiteStructure table is created with `slug` field (VARCHAR 255)
- Unique constraint exists: `@@unique([parentId, slug])`
- Database indexes are in place for performance
- Full path is stored separately from slug for fast lookups

### Technical Architecture
[Source: docs/epic8-brownfield-architecture.md]

#### Database Schema
The SiteStructure model already includes:
```prisma
model SiteStructure {
  slug          String   @db.VarChar(255)
  fullPath      String   @db.Text
  
  @@unique([parentId, slug])  // Enforces uniqueness at sibling level
}
```

#### Slug Generation Rules
[Source: docs/epic8-brownfield-architecture.md#slug-generation]
- Pattern: `/^[a-z0-9-]+$/`
- Max length: 255 characters
- Reserved slugs: ['api', 'admin', 'static', '_next']
- Case-insensitive uniqueness validation required

#### Example Slug Transformations
```typescript
// Title → Slug Examples
"Hello World!"           → "hello-world"
"Products & Services"    → "products-services"
"ABC 123 - Test Page"    → "abc-123-test-page"
"Contact Us!!!"         → "contact-us"
"  Spaces  Everywhere  " → "spaces-everywhere"
"café-résumé"           → "cafe-resume"
"2024 Annual Report"    → "2024-annual-report"
"__Special__Characters__" → "special-characters"
```

#### Service Layer Architecture
[Source: docs/epic8-brownfield-architecture.md#services]
Services should be placed in `lib/services/site-structure/` directory following the existing pattern:
- `slug-manager.ts` - Core slug generation logic
- `slug-validator.ts` - Validation and uniqueness checking
- `errors.ts` - Custom error classes

#### Error Handling Pattern
[Source: docs/epic8-brownfield-architecture.md#error-handling]
```typescript
export class SlugConflictError extends Error {
  constructor(slug: string, parentId: string) {
    super(`Slug "${slug}" already exists under parent ${parentId}`);
    this.name = 'SlugConflictError';
    this.statusCode = 409;
  }
}
```

#### Specific Error Messages
```typescript
// SlugConflictError Examples
"Slug 'about-us' already exists under parent null"  // Root level conflict
"Slug 'overview' already exists under parent 'abc123'"  // Child level conflict

// InvalidSlugError Examples
"Invalid slug: 'About Us' contains uppercase letters"
"Invalid slug: 'contact@us' contains invalid character '@'"
"Invalid slug: 'api' is a reserved system slug"
"Invalid slug: exceeds maximum length of 255 characters"
"Invalid slug: cannot be empty"
```

### GitFlow Workflow
Branch Name: `feature/8-2-slug-management`
Base Branch: main
PR Target: main

Git Commands:
1. Setup: `git checkout main && git pull origin main`
2. Create: `git checkout -b feature/8-2-slug-management`
3. Commit: Use conventional commits (feat:, fix:, docs:, etc.)
4. Push: `git push -u origin feature/8-2-slug-management`
5. PR: Create PR to main branch with title "Epic 8 Story 8.2: Slug Management System"

### Testing Standards
[Source: Project conventions]
- Test files location: Same directory as source with `__tests__` folder
- Testing framework: Jest with TypeScript
- Coverage requirement: 90%+ for utility functions
- Integration tests should use test database
- Performance benchmarks should be included in test comments

### Implementation Notes
- Use Prisma client from `lib/prisma.ts` for database operations
- Follow TypeScript strict mode requirements
- All functions should have proper TypeScript types
- Use async/await for database operations

### Transaction Strategy for Conflict Resolution
```typescript
// Use Prisma transaction for atomic slug conflict resolution
async function ensureUniqueSlug(baseSlug: string, parentId: string | null, websiteId: string): Promise<string> {
  return await prisma.$transaction(async (tx) => {
    let slugToTry = baseSlug;
    let suffix = 0;
    
    while (true) {
      const existing = await tx.siteStructure.findFirst({
        where: {
          websiteId,
          parentId,
          slug: { equals: slugToTry, mode: 'insensitive' }
        }
      });
      
      if (!existing) {
        return slugToTry;  // This slug is available
      }
      
      // Try next suffix
      suffix++;
      slugToTry = `${baseSlug}-${suffix}`;
      
      if (suffix > 100) {
        throw new Error('Unable to generate unique slug after 100 attempts');
      }
    }
  });
}
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-22 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-08-22 | 1.1 | Added examples, transaction strategy, and error messages per PO review | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
*To be filled by Dev Agent*

### Debug Log References
*To be filled by Dev Agent*

### Completion Notes List
*To be filled by Dev Agent*

### File List
*To be filled by Dev Agent*

## QA Results
*To be filled by QA Agent*