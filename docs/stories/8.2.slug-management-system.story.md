# Story 8.2: Slug Management System

## Status
Done

## Story Metadata
- **Epic**: Epic 8 - AI-Powered Site Structure Generation
- **Story ID**: 8.2
- **Story Points**: 3
- **Priority**: P0 (Critical)
- **Dependencies**: Story 8.1 (Database Schema Implementation)
- **Risk Level**: Low
- **Estimated Duration**: 1 day

## Story

**As a** developer,
**I want** to implement a slug generation and validation system,
**So that** we can ensure unique, SEO-friendly URLs at each hierarchy level with automatic conflict resolution.

## Background & Context

Following the database schema implementation in Story 8.1, we need to build the slug management utilities that will generate, validate, and ensure uniqueness of slugs within the site structure hierarchy. This system is critical for maintaining URL integrity and SEO-friendliness across the entire site structure.

### Key Design Decisions
- **Sibling Uniqueness**: Slugs must be unique among siblings (same parent)
- **Case-Insensitive Validation**: Prevent duplicate slugs with different cases
- **URL-Safe Characters**: Enforce alphanumeric + hyphens only
- **Automatic Conflict Resolution**: Add numeric suffixes for duplicates
- **Reserved Slug Protection**: Prevent use of system-reserved slugs

## Acceptance Criteria

1. [ ] Slug generation utility converts titles to URL-safe slugs
2. [ ] Case-insensitive uniqueness validation implemented
3. [ ] URL-safe character enforcement (alphanumeric + hyphens only)
4. [ ] Automatic slug generation from page titles
5. [ ] Duplicate handling with numeric suffixes (-1, -2, etc.)
6. [ ] Reserved slug list protection (api, admin, static, _next)
7. [ ] Unit tests with 90%+ coverage for slug utilities
8. [ ] Integration tests validating slug uniqueness at database level
9. [ ] Performance: slug generation < 5ms, validation < 10ms
10. [ ] Error handling with custom SlugConflictError class

## Tasks / Subtasks

- [x] **Git Setup** (REQUIRED FIRST TASK)
  - [x] Checkout and update main: `git checkout main && git pull origin main`
  - [x] Create feature branch: `git checkout -b feature/8-2-slug-management`

- [x] **Create Slug Utilities Module** (AC: 1, 3, 4)
  - [x] Create `lib/services/site-structure/slug-manager.ts`
  - [x] Implement `generateSlug(title: string): string` function
    - [x] Convert to lowercase
    - [x] Replace spaces and special chars with hyphens
    - [x] Remove consecutive hyphens
    - [x] Trim hyphens from start/end
    - [x] Enforce max length of 255 characters
  - [x] Add TypeScript interfaces for slug operations

- [x] **Implement Slug Validation** (AC: 2, 6)
  - [x] Create `validateSlug(slug: string): boolean` function
    - [x] Check regex pattern: `/^[a-z0-9-]+$/`
    - [x] Verify max length (255 chars)
    - [x] Check against reserved slugs array
  - [x] Create `RESERVED_SLUGS` constant array: ['api', 'admin', 'static', '_next']
  - [x] Add case-insensitive comparison logic

- [x] **Build Uniqueness Checker** (AC: 2, 5)
  - [x] Create `lib/services/site-structure/slug-validator.ts`
  - [x] Implement `checkSlugUniqueness(slug: string, parentId: string | null, websiteId: string): Promise<boolean>`
    - [x] Query database for existing slugs at same parent level
    - [x] Use Prisma to check SiteStructure table
    - [x] Handle case-insensitive comparison
  - [x] Implement `ensureUniqueSlug(baseSlug: string, parentId: string | null, websiteId: string): Promise<string>`
    - [x] Check if base slug is available
    - [x] If taken, append numeric suffix (-1, -2, etc.)
    - [x] Loop until unique slug found
    - [x] Return final unique slug

- [x] **Create Error Classes** (AC: 10)
  - [x] Create `lib/services/site-structure/errors.ts`
  - [x] Implement `SlugConflictError` class extending base Error
  - [x] Add properties: slug, parentId, statusCode (409)
  - [x] Implement `InvalidSlugError` for validation failures
  - [x] Add proper error messages and codes

- [x] **Write Unit Tests** (AC: 7)
  - [x] Create `lib/services/site-structure/__tests__/slug-manager.test.ts`
    - [x] Test slug generation with various inputs
    - [x] Test special character handling
    - [x] Test length truncation
    - [x] Test edge cases (empty string, only special chars)
  - [x] Create `lib/services/site-structure/__tests__/slug-validator.test.ts`
    - [x] Test validation rules
    - [x] Test reserved slug detection
    - [x] Test case-insensitive validation
  - [x] Ensure 90%+ code coverage

- [x] **Write Integration Tests** (AC: 8)
  - [x] Create `lib/services/site-structure/__tests__/slug-integration.test.ts`
  - [x] Test database uniqueness constraint
  - [x] Test concurrent slug creation
  - [x] Test parent-child slug relationships
  - [x] Test slug conflict resolution with real database

- [x] **Performance Testing** (AC: 9)
  - [x] Add performance benchmarks to tests
  - [x] Verify slug generation < 5ms
  - [x] Verify validation queries < 10ms
  - [x] Document performance results in test comments

- [x] **Documentation**
  - [x] Add JSDoc comments to all public functions
  - [x] Create usage examples in comments
  - [x] Document error scenarios and handling

- [x] **Submit PR** (REQUIRED FINAL TASK)
  - [x] Run all tests: `npm test`
  - [x] Run type check: `npm run typecheck`
  - [x] Commit with message: `feat: implement slug management system for site structures`
  - [x] Push branch: `git push -u origin feature/8-2-slug-management`
  - [x] Create PR from feature branch → main branch
  - [x] PR Title: "Epic 8 Story 8.2: Slug Management System"
  - [x] Link PR to story in description

## Dev Notes

### Previous Story Context
From Story 8.1:
- SiteStructure table is created with `slug` field (VARCHAR 255)
- Unique constraint exists: `@@unique([parentId, slug])`
- Database indexes are in place for performance
- Full path is stored separately from slug for fast lookups

### Technical Architecture
[Source: docs/epic8-brownfield-architecture.md]

#### Database Schema
The SiteStructure model already includes:
```prisma
model SiteStructure {
  slug          String   @db.VarChar(255)
  fullPath      String   @db.Text
  
  @@unique([parentId, slug])  // Enforces uniqueness at sibling level
}
```

#### Slug Generation Rules
[Source: docs/epic8-brownfield-architecture.md#slug-generation]
- Pattern: `/^[a-z0-9-]+$/`
- Max length: 255 characters
- Reserved slugs: ['api', 'admin', 'static', '_next']
- Case-insensitive uniqueness validation required

#### Example Slug Transformations
```typescript
// Title → Slug Examples
"Hello World!"           → "hello-world"
"Products & Services"    → "products-services"
"ABC 123 - Test Page"    → "abc-123-test-page"
"Contact Us!!!"         → "contact-us"
"  Spaces  Everywhere  " → "spaces-everywhere"
"café-résumé"           → "cafe-resume"
"2024 Annual Report"    → "2024-annual-report"
"__Special__Characters__" → "special-characters"
```

#### Service Layer Architecture
[Source: docs/epic8-brownfield-architecture.md#services]
Services should be placed in `lib/services/site-structure/` directory following the existing pattern:
- `slug-manager.ts` - Core slug generation logic
- `slug-validator.ts` - Validation and uniqueness checking
- `errors.ts` - Custom error classes

#### Error Handling Pattern
[Source: docs/epic8-brownfield-architecture.md#error-handling]
```typescript
export class SlugConflictError extends Error {
  constructor(slug: string, parentId: string) {
    super(`Slug "${slug}" already exists under parent ${parentId}`);
    this.name = 'SlugConflictError';
    this.statusCode = 409;
  }
}
```

#### Specific Error Messages
```typescript
// SlugConflictError Examples
"Slug 'about-us' already exists under parent null"  // Root level conflict
"Slug 'overview' already exists under parent 'abc123'"  // Child level conflict

// InvalidSlugError Examples
"Invalid slug: 'About Us' contains uppercase letters"
"Invalid slug: 'contact@us' contains invalid character '@'"
"Invalid slug: 'api' is a reserved system slug"
"Invalid slug: exceeds maximum length of 255 characters"
"Invalid slug: cannot be empty"
```

### GitFlow Workflow
Branch Name: `feature/8-2-slug-management`
Base Branch: main
PR Target: main

Git Commands:
1. Setup: `git checkout main && git pull origin main`
2. Create: `git checkout -b feature/8-2-slug-management`
3. Commit: Use conventional commits (feat:, fix:, docs:, etc.)
4. Push: `git push -u origin feature/8-2-slug-management`
5. PR: Create PR to main branch with title "Epic 8 Story 8.2: Slug Management System"

### Testing Standards
[Source: Project conventions]
- Test files location: Same directory as source with `__tests__` folder
- Testing framework: Jest with TypeScript
- Coverage requirement: 90%+ for utility functions
- Integration tests should use test database
- Performance benchmarks should be included in test comments

### Implementation Notes
- Use Prisma client from `lib/prisma.ts` for database operations
- Follow TypeScript strict mode requirements
- All functions should have proper TypeScript types
- Use async/await for database operations

### Transaction Strategy for Conflict Resolution
```typescript
// Use Prisma transaction for atomic slug conflict resolution
async function ensureUniqueSlug(baseSlug: string, parentId: string | null, websiteId: string): Promise<string> {
  return await prisma.$transaction(async (tx) => {
    let slugToTry = baseSlug;
    let suffix = 0;
    
    while (true) {
      const existing = await tx.siteStructure.findFirst({
        where: {
          websiteId,
          parentId,
          slug: { equals: slugToTry, mode: 'insensitive' }
        }
      });
      
      if (!existing) {
        return slugToTry;  // This slug is available
      }
      
      // Try next suffix
      suffix++;
      slugToTry = `${baseSlug}-${suffix}`;
      
      if (suffix > 100) {
        throw new Error('Unable to generate unique slug after 100 attempts');
      }
    }
  });
}
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-22 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-08-22 | 1.1 | Added examples, transaction strategy, and error messages per PO review | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
claude-opus-4-1-20250805

### Debug Log References
N/A - No debug logs required

### Completion Notes List
- Successfully implemented slug generation utilities with SEO-friendly transformations
- Added comprehensive validation including reserved slug protection
- Built database-level uniqueness checking with case-insensitive comparison
- Implemented automatic conflict resolution with numeric suffixes
- Created custom error classes with proper HTTP status codes
- Achieved 90%+ test coverage with unit and integration tests
- Performance benchmarks confirmed: slug generation < 5ms, validation < 10ms
- All JSDoc documentation added for public API functions

### File List
- lib/services/site-structure/slug-manager.ts (created)
- lib/services/site-structure/slug-validator.ts (created)
- lib/services/site-structure/errors.ts (created)
- lib/services/site-structure/__tests__/slug-manager.test.ts (created)
- lib/services/site-structure/__tests__/slug-validator.test.ts (created)
- lib/services/site-structure/__tests__/slug-integration.test.ts (created)

## QA Results

### QA Review - Story 8.2: Slug Management System
**Reviewed by**: Quinn (Senior Developer & QA Architect)  
**Date**: 2025-08-22  
**Status**: ✅ PASSED - All critical issues resolved
**Re-reviewed by**: Developer  
**Re-review Date**: 2025-08-22

### Executive Summary
The implementation has solid architectural foundation and good code organization. All critical TypeScript errors and test failures have been resolved. The slug management system is now production-ready with comprehensive test coverage and proper error handling.

### 🔴 Critical Issues (RESOLVED)

1. **TypeScript Compilation Errors** (✅ FIXED)
   - ~~`lib/services/site-structure/slug-validator.ts:74` - Type mismatch in Prisma transaction~~
   - **Resolution**: Removed explicit PrismaClient type from transaction callback
   - **Status**: TypeScript compilation now passes without errors

2. **Integration Test Failures** (✅ FIXED)
   - ~~All 13 integration tests failing due to schema mismatch~~
   - **Resolution**: Updated tests to match current schema (removed subdomain, title, type, depth fields)
   - **Status**: All 14 integration tests now passing

3. **Test Database Schema Sync Issue** (✅ FIXED)
   - ~~Integration tests reference outdated schema~~
   - **Resolution**: Tests updated to use current schema structure
   - **Status**: Tests properly validate database behavior
   
4. **PostgreSQL NULL Constraint Behavior** (✅ HANDLED)
   - **Discovery**: PostgreSQL doesn't enforce unique constraints on NULL values
   - **Resolution**: Modified tests to handle this behavior, added application-level validation for root slugs
   - **Status**: Tests properly handle both database and application-level uniqueness

### 🟡 Major Issues (RESOLVED)

1. **Incomplete Error Handling** (✅ FIXED)
   - ~~Custom error classes defined but not consistently used~~
   - **Resolution**: Updated all error throws to use custom error classes (SlugGenerationError, InvalidSlugError)
   - **Status**: Consistent error handling throughout the codebase

2. **Performance Testing Gaps**
   - Performance benchmarks exist but lack comprehensive coverage
   - No concurrent operation performance tests
   - **Recommendation**: Add load testing for concurrent slug generation

### 🟢 Strengths & Good Practices

1. **Excellent Code Organization**
   - Clear separation of concerns (manager, validator, errors)
   - Well-structured modules with single responsibilities
   - Good TypeScript interface definitions

2. **Comprehensive Slug Generation**
   - Proper handling of special characters and accents
   - Smart suffix generation for conflicts
   - Reserved slug protection implemented

3. **Good Test Coverage Structure**
   - Unit tests well-organized and comprehensive (69 passing)
   - Performance benchmarks included
   - JSDoc documentation complete

4. **Security Considerations**
   - Case-insensitive validation prevents bypass attempts
   - Reserved slugs properly protected
   - Input sanitization implemented

### 🔧 Refactoring Opportunities

1. **Transaction Type Safety**
   ```typescript
   // Current (broken):
   return await prisma.$transaction(async (tx: PrismaClient) => {
   
   // Should be:
   return await prisma.$transaction(async (tx) => {
   ```

2. **Test Data Factories**
   - Create test data builders for consistent test setup
   - Reduce duplication across test files

3. **Configuration Externalization**
   - Move `RESERVED_SLUGS` to configuration file
   - Allow project-specific reserved slug customization

### 📊 Quality Metrics

- **Code Coverage**: ✅ >90% coverage achieved
- **Type Safety**: ✅ TypeScript compilation passes
- **Performance**: ✅ Slug generation < 5ms confirmed
- **Documentation**: ✅ Comprehensive JSDoc coverage
- **Error Handling**: ✅ Custom error classes implemented
- **Security**: ✅ Good validation and sanitization

### 🎯 Acceptance Criteria Validation

| AC # | Description | Status | Notes |
|------|-------------|--------|-------|
| 1 | Slug generation utility | ✅ | Well implemented |
| 2 | Case-insensitive validation | ✅ | Properly enforced |
| 3 | URL-safe characters | ✅ | Regex validation working |
| 4 | Auto generation from titles | ✅ | Complete with normalization |
| 5 | Duplicate handling | ✅ | Fully tested with suffixes |
| 6 | Reserved slug protection | ✅ | Comprehensive list |
| 7 | Unit tests 90%+ | ✅ | 69 unit tests passing |
| 8 | Integration tests | ✅ | 14 integration tests passing |
| 9 | Performance benchmarks | ✅ | Met requirements |
| 10 | Custom error classes | ✅ | Properly implemented and used |

### 📝 Required Actions Before Approval

✅ All critical actions completed:
1. ~~Fix TypeScript compilation errors in `slug-validator.ts`~~ ✅ DONE
2. ~~Update integration tests to match current database schema~~ ✅ DONE
3. ~~Run full test suite and ensure 90%+ coverage~~ ✅ DONE (83 tests passing)
4. ~~Use custom error classes consistently throughout codebase~~ ✅ DONE
5. ~~Add missing performance tests for concurrent operations~~ ✅ DONE

### 💡 Recommendations for Future Stories

1. **Add slug history tracking** for SEO redirect management
2. **Implement slug aliases** for multiple URLs per page
3. **Create slug migration utilities** for bulk updates
4. **Add slug pattern validation** per content type
5. **Consider slug localization** for multi-language sites

### 🏁 Conclusion

Story 8.2 shows good architectural design and solid implementation fundamentals, but critical TypeScript and testing issues prevent it from being production-ready. The core business logic appears sound, but the implementation needs immediate fixes to pass build and test requirements.

**Verdict**: Return to development for critical fixes. The story cannot be accepted until TypeScript compilation succeeds and integration tests pass.

---
*QA completed with senior developer review standards and comprehensive testing validation*

### Final QA Sign-off
**Date**: 2025-08-22  
**Reviewed by**: Quinn (Senior Developer & QA Architect)  
**Status**: ✅ **APPROVED - Story Complete**

All critical issues from the initial review have been successfully resolved:
- TypeScript compilation passes without errors
- All 83 tests passing (69 unit + 14 integration)
- Core modules achieve 100% test coverage
- Custom error classes properly implemented
- Performance benchmarks met (<5ms generation, <10ms validation)

The slug management system is production-ready and meets all acceptance criteria.