# Story 6.10: Implement UPDATE and DELETE Operations

## Status
Approved

## Story
**As a** developer,  
**I want to** support UPDATE and DELETE operations,  
**So that** we have full CRUD capability for content types

## Acceptance Criteria
1. UPDATE operation for modified content types
2. DELETE operation for removed content types  
3. Safe deletion with dependency checking
4. Batch operations support

## Tasks / Subtasks
- [ ] Git Setup (REQUIRED FIRST TASK)
  - [ ] Checkout and update main: `git checkout main && git pull origin main`
  - [ ] Create feature branch: `git checkout -b feature/epic6-update-delete`
- [ ] Enhance UPDATE Operation (AC: 1)
  - [ ] Review existing `updateContentType` method in `/lib/sync/adapters/optimizely-api-client.ts`
  - [ ] Add comprehensive error handling for UPDATE operations
  - [ ] Implement retry logic for transient failures
  - [ ] Add support for partial updates (only changed fields)
  - [ ] Ensure proper ETag handling for optimistic concurrency control
  - [ ] Add sync history tracking for UPDATE operations
  - [ ] Write unit tests for UPDATE operation in `/lib/sync/adapters/__tests__/optimizely-api-client.test.ts`
- [ ] Enhance DELETE Operation (AC: 2, 3)
  - [ ] Review existing `deleteContentType` method in `/lib/sync/adapters/optimizely-api-client.ts`
  - [ ] Implement dependency checking before deletion to prevent orphaned content
  - [ ] Add soft delete capability with restoration option
  - [ ] Implement cascade delete for dependent types (with user confirmation)
  - [ ] Add sync history tracking for DELETE operations
  - [ ] Create safeguards to prevent accidental mass deletion
  - [ ] Write unit tests for DELETE operation
- [ ] Integrate Operations with Sync Engine (AC: 1, 2)
  - [ ] Update `/lib/sync/engine/sync-orchestrator.ts` to handle UPDATE operations
  - [ ] Add DELETE operation support to sync orchestrator
  - [ ] Implement change detection for UPDATE vs CREATE decisions
  - [ ] Add operation type tracking in sync state
  - [ ] Ensure proper transaction handling for multiple operations
- [ ] Implement Batch Operations (AC: 4)
  - [ ] Create batch UPDATE method in API client
  - [ ] Create batch DELETE method in API client
  - [ ] Implement parallel processing with rate limiting (using existing p-limit)
  - [ ] Add progress tracking for batch operations
  - [ ] Implement rollback mechanism for failed batch operations:
    - [ ] Track successful operations in temporary transaction log
    - [ ] On failure, reverse successful operations in reverse order
    - [ ] For UPDATE: restore previous version from sync_history
    - [ ] For DELETE: re-create from last known state
    - [ ] For CREATE: delete created items
  - [ ] Add batch operation methods to sync orchestrator
- [ ] Add Operation History Tracking (AC: 1, 2)
  - [ ] Update `SyncHistoryManager` to track UPDATE operations
  - [ ] Update `SyncHistoryManager` to track DELETE operations
  - [ ] Add operation type field to sync_history table if not present
  - [ ] Implement audit trail for all CRUD operations
- [ ] Create Operation Validation (AC: 1, 2, 3)
  - [ ] Add pre-update validation in ValidationLayer
  - [ ] Add pre-delete validation with dependency checks
  - [ ] Implement business rule validation for operations
  - [ ] Add input validation for batch operations (max 50 items per batch)
  - [ ] Validate DELETE operations (cannot delete if content exists)
  - [ ] Create validation error reporting for operations
- [ ] Add UI Integration Points (AC: 1, 2, 4)
  - [ ] Create API endpoints for UPDATE operations in `/app/api/sync/update/route.ts`
  - [ ] Create API endpoints for DELETE operations in `/app/api/sync/delete/route.ts`
  - [ ] Create batch operation endpoints in `/app/api/sync/batch/route.ts`
  - [ ] Add operation status tracking to deployment progress
- [ ] Testing and Verification (AC: 1, 2, 3, 4)
  - [ ] Write integration tests for UPDATE operations
  - [ ] Write integration tests for DELETE operations
  - [ ] Write integration tests for batch operations
  - [ ] Test dependency checking and cascade delete
  - [ ] Test rollback scenarios for failed operations
  - [ ] Verify sync history tracking for all operations
- [ ] Submit PR (REQUIRED FINAL TASK)
  - [ ] Push branch: `git push -u origin feature/epic6-update-delete`
  - [ ] Create PR from feature branch â†’ main branch
  - [ ] PR Title: "Epic 6 Story 10: Implement UPDATE and DELETE Operations"
  - [ ] Link PR to story in description

## Dev Notes

### GitFlow Workflow
Branch Name: feature/epic6-update-delete
Base Branch: main
PR Target: main

Git Commands:
1. Setup: `git checkout main && git pull origin main`
2. Create: `git checkout -b feature/epic6-update-delete`
3. Commit: Use conventional commits (feat:, fix:, docs:, etc.)
4. Push: `git push -u origin feature/epic6-update-delete`
5. PR: Create PR to main branch with title "Epic 6 Story 10: Implement UPDATE and DELETE Operations"

### Existing Code Context

**Current Implementation Status:**
- The `OptimizelyApiClient` class in `/lib/sync/adapters/optimizely-api-client.ts` already has basic UPDATE and DELETE methods
- UPDATE uses JSON Patch format with ETag support for optimistic concurrency
- DELETE has basic implementation with 404 handling
- Both methods have dry-run support and rate limiting via p-limit

**Key Files and Components:**
- `/lib/sync/adapters/optimizely-api-client.ts` - Contains API client with UPDATE/DELETE methods (lines 310-440)
- `/lib/sync/engine/sync-orchestrator.ts` - Sync engine that needs UPDATE/DELETE integration
- `/lib/sync/tracking/SyncHistoryManager.ts` - Handles sync history tracking
- `/lib/sync/state/sync-state.ts` - Manages sync state and change detection
- `/lib/sync/validation/validation-layer.ts` - Validation layer for operations

**Technical Details from Architecture:**
[Source: epic6-architecture.md]

**Update Operation Requirements:**
- Use PATCH method with JSON Patch format for Optimizely API
- Content-Type header must be 'application/json-patch+json'
- Include If-Match header with ETag for optimistic concurrency control
- Handle 412 Precondition Failed for concurrent modification conflicts
- Track all updates in sync_history with operation type 'UPDATE'

**Delete Operation Requirements:**
- Check for dependent content types before deletion
- Implement soft delete pattern with is_deleted flag
- Support cascade delete with explicit user confirmation
- Track deletions in sync_history with operation type 'DELETE'
- Prevent accidental mass deletion (max 5 types without confirmation)

**Batch Operations:**
- Use existing p-limit (already imported) for rate limiting
- Default concurrency limit of 2 parallel operations
- Maximum batch size: 50 items per batch (validate before processing)
- Implement transaction pattern - all succeed or all rollback
- Progress tracking via Server-Sent Events (SSE)
- Rate limiting strategy: Process in chunks of 10 with 500ms delay between chunks
- Performance expectation: Process 50 items in under 30 seconds

**Sync State Tracking:**
[Source: epic6-prd.md#sync-state-management]
- Update sync_state table with operation results
- Track local_hash and remote_hash for change detection
- Set sync_status to 'in_sync' after successful UPDATE
- Set sync_status to 'deleted' after successful DELETE

**Error Handling Patterns:**
- 401: Clear auth token and re-authenticate
- 404: Log warning but don't fail the sync
- 412: Conflict - fetch latest and retry or skip
- 415: Invalid media type - skip and log error
- 429: Rate limited - exponential backoff retry

### Testing Standards
[Source: Testing requirements from existing codebase]
- Test files location: `/lib/sync/adapters/__tests__/` for unit tests
- Integration tests in `/tests/integration/` directory
- Use Jest and React Testing Library patterns
- Mock external API calls using MSW or jest mocks
- Test coverage requirement: >80% for new code
- Test both success and failure scenarios
- Test dry-run mode for all operations

### Database Schema Updates Required
```sql
-- Already exists from previous stories, but verify:
ALTER TABLE sync_history ADD COLUMN IF NOT EXISTS operation_type TEXT;
ALTER TABLE sync_state ADD COLUMN IF NOT EXISTS is_deleted BOOLEAN DEFAULT FALSE;
```

### API Rate Limiting Configuration
- Current limit: 2 concurrent requests (via p-limit)
- Retry with exponential backoff on 429 responses
- Maximum retry attempts: 3
- Base delay: 1000ms, max delay: 10000ms

### Example JSON Patch Format for UPDATE
```json
[
  { "op": "replace", "path": "/displayName", "value": "Updated Name" },
  { "op": "replace", "path": "/description", "value": "Updated description" },
  { "op": "replace", "path": "/properties", "value": [...] },
  { "op": "add", "path": "/properties/-", "value": { "name": "newField", "type": "string" } }
]
```

### Expected Error Response Formats
```typescript
// 412 Precondition Failed
{
  "error": "PRECONDITION_FAILED",
  "message": "Content type has been modified externally",
  "etag": "current-etag-value"
}

// 429 Rate Limited
{
  "error": "RATE_LIMITED", 
  "message": "Too many requests",
  "retryAfter": 1000
}

// Batch Operation Failure
{
  "status": "PARTIAL_SUCCESS",
  "successful": ["type1", "type2"],
  "failed": [
    { "key": "type3", "error": "VALIDATION_FAILED", "message": "Invalid schema" }
  ],
  "rollbackStatus": "COMPLETED"
}
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-18 | 1.0 | Initial story creation | Scrum Master |
| 2025-01-18 | 1.1 | Applied PO feedback: Added validation rules, rate limiting details, rollback strategy, examples | Scrum Master |

## Dev Agent Record

### Agent Model Used
_To be populated during development_

### Debug Log References
_To be populated during development_

### Completion Notes List
_To be populated during development_

### File List
_To be populated during development_

## QA Results
_To be populated during QA review_