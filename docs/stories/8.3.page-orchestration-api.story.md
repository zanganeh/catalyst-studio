# Story 8.3: Page Orchestration API

## Status
Ready for Review

## Story Metadata
- **Epic**: Epic 8 - AI-Powered Site Structure Generation
- **Story ID**: 8.3
- **Story Points**: 5
- **Priority**: P0 (Critical)
- **Dependencies**: Story 8.1 (Database Schema), Story 8.2 (Slug Management)
- **Risk Level**: High (Core architectural decision)
- **Estimated Duration**: 2 days

## Story

**As a** developer,
**I want** a unified Page API that orchestrates ContentItem and SiteStructure creation atomically,
**So that** we prevent orphaned nodes and maintain data consistency throughout the system.

## Background & Context

Following the database schema implementation (8.1) and slug management system (8.2), we need to implement the Hybrid Orchestration Pattern identified in the architecture consensus. This pattern ensures every SiteStructure node has an associated ContentItem, preventing orphaned navigation nodes and maintaining referential integrity.

### Key Architectural Decision
The original design had separate APIs for ContentItem and SiteStructure creation, which could lead to:
- Orphaned SiteStructure nodes without content
- Inconsistent slug management across two entities
- Complex transaction management for clients
- Partial failures leaving system in inconsistent state

The solution is to implement a unified Page API that orchestrates both entities atomically.

## Acceptance Criteria

1. [ ] PageOrchestrator service class implemented with transaction management
2. [ ] POST `/api/pages` endpoint creates page atomically (ContentItem + SiteStructure)
3. [ ] PATCH `/api/pages/:id` updates page with slug synchronization
4. [ ] DELETE `/api/pages/:id` deletes page with configurable cascade options
5. [ ] POST `/api/pages/:id/move` moves page in hierarchy with path recalculation
6. [ ] GET `/api/pages/resolve?path=` resolves URL to page with < 10ms response
7. [ ] All operations use database transactions for atomicity
8. [ ] Single slug source of truth maintained in ContentItem
9. [ ] Error handling with proper rollback on any failure
10. [ ] Unit tests with 85%+ coverage for orchestrator service
11. [ ] Integration tests validating atomic operations
12. [ ] API documentation with TypeScript types

## Tasks / Subtasks

- [x] **Git Setup** (REQUIRED FIRST TASK)
  - [x] Checkout and update main: `git checkout main && git pull origin main`
  - [x] Create feature branch: `git checkout -b feature/8-3-page-orchestration`

- [x] **Create PageOrchestrator Service** (AC: 1, 7, 8)
  - [x] Create `lib/services/site-structure/page-orchestrator.ts`
  - [x] Implement `IPageOrchestrator` interface with all methods
  - [x] Add transaction management using Prisma `$transaction`
  - [x] Integrate with existing slug-manager for slug generation
  - [x] Handle path building and depth calculation

- [x] **Implement Page DTOs and Types** (AC: 12)
  - [x] Create `lib/types/page-orchestrator.types.ts`
  - [x] Define `CreatePageDto` interface
  - [x] Define `UpdatePageDto` interface  
  - [x] Define `PageResult` response type
  - [x] Define `DeleteOptions` for cascade control

- [x] **Create Pages API Endpoints** (AC: 2-6)
  - [x] Create `app/api/pages/route.ts` for POST (create page)
  - [x] Create `app/api/pages/[id]/route.ts` for PATCH and DELETE
  - [x] Create `app/api/pages/[id]/move/route.ts` for hierarchy moves
  - [x] Create `app/api/pages/resolve/route.ts` for URL resolution
  - [x] Add proper error handling and status codes

- [x] **Implement Core Operations** (AC: 2, 7, 8, 9)
  - [x] `createPage`: Atomic creation with slug generation
  - [x] Validate content type exists before creation
  - [x] Calculate materialized path from parent
  - [x] Handle position ordering among siblings
  - [x] Return combined ContentItem + SiteStructure data

- [x] **Implement Update Operations** (AC: 3, 8)
  - [x] `updatePage`: Sync slug changes between entities
  - [x] Handle title changes that affect slug
  - [x] Cascade path updates to descendants if slug changes
  - [x] Maintain transaction safety

- [x] **Implement Delete Operations** (AC: 4, 9)
  - [x] `deletePage`: Configure cascade behavior
  - [x] Option to delete content but keep structure
  - [x] Option to orphan children vs cascade delete
  - [x] Handle cleanup of related data

- [x] **Implement Move Operations** (AC: 5)
  - [x] `movePage`: Change parent with path recalculation
  - [x] Validate no circular references created
  - [x] Update all descendant paths recursively
  - [x] Maintain position ordering

- [x] **Implement URL Resolution** (AC: 6)
  - [x] `resolveUrl`: Path to page lookup
  - [x] Use indexed fullPath for O(1) performance
  - [x] Return 404 for non-existent paths
  - [x] Include content and structure data in response

- [x] **Add Error Handling** (AC: 9)
  - [x] Create custom error classes in `lib/services/site-structure/errors.ts`
  - [x] Add `OrphanedNodeError` for validation
  - [x] Add `CircularReferenceError` for move operations
  - [x] Implement rollback on any operation failure

- [x] **Write Unit Tests** (AC: 10)
  - [x] Create `lib/services/site-structure/__tests__/page-orchestrator.test.ts`
  - [x] Test atomic creation with transactions
  - [x] Test rollback on failures
  - [x] Test slug generation and uniqueness
  - [x] Mock Prisma transactions

- [x] **Write Integration Tests** (AC: 11)
  - [x] Create `app/api/pages/__tests__/pages.integration.test.ts`
  - [x] Test full API flow with real database
  - [x] Test transaction rollback scenarios
  - [x] Test concurrent operations
  - [x] Performance test URL resolution

- [x] **Documentation** (AC: 12)
  - [x] Add JSDoc comments to all public methods
  - [x] Document transaction boundaries
  - [x] Create API usage examples
  - [x] Update architecture docs if needed

- [x] **Submit PR** (REQUIRED FINAL TASK)
  - [x] Push branch: `git push -u origin feature/8-3-page-orchestration`
  - [x] Create PR from feature branch â†’ main branch
  - [x] PR Title: "Epic 8 Story 8.3: Page Orchestration API"
  - [x] Link PR to story in description

## Dev Notes

### Previous Story Insights
From Story 8.2 (Slug Management):
- Slug generation utilities are in `lib/services/site-structure/slug-manager.ts`
- Slug validation is in `lib/services/site-structure/slug-validator.ts`
- Custom error classes are in `lib/services/site-structure/errors.ts`
- Case-insensitive uniqueness checking is already implemented
- Reserved slugs are validated (api, admin, static, _next)

### Architecture Context

#### Hybrid Orchestration Pattern
[Source: docs/epic8-brownfield-architecture.md#integration-architecture]
The PageOrchestrator implements the Hybrid Orchestration Pattern to ensure:
1. Every SiteStructure node MUST have an associated ContentItem
2. Page creation/deletion must be atomic operations
3. ContentItem owns the slug (single source of truth)
4. SiteStructure mirrors the slug for path construction

#### Service Layer Location
[Source: docs/epic8-brownfield-architecture.md#component-architecture]
Place the PageOrchestrator service in: `lib/services/site-structure/page-orchestrator.ts`

#### Transaction Management Pattern
[Source: docs/epic8-brownfield-architecture.md#integration-architecture]
```typescript
return await prisma.$transaction(async (tx) => {
  // All database operations here
  // Automatic rollback on any error
});
```

#### API Route Structure
[Source: Existing patterns in app/api/]
- Use Next.js 13+ App Router conventions
- Return NextResponse with proper status codes
- Handle errors with try/catch blocks
- Use TypeScript for all route handlers

#### Database Models
[Source: prisma/schema.prisma]
- SiteStructure model has relations to Website, ContentItem, and parent/children
- ContentItem has slug field (source of truth)
- Use Prisma client from `lib/prisma.ts`

#### Performance Requirements
[Source: docs/epic8-brownfield-prd.md#performance]
- URL resolution must complete in < 10ms
- Use indexed fullPath field for O(1) lookups
- Bulk operations should complete in < 1 second for 100 nodes

### GitFlow Workflow
Branch Name: `feature/8-3-page-orchestration`
Base Branch: main
PR Target: main

Git Commands:
1. Setup: `git checkout main && git pull origin main`
2. Create: `git checkout -b feature/8-3-page-orchestration`
3. Commit: Use conventional commits (feat:, fix:, docs:, etc.)
4. Push: `git push -u origin feature/8-3-page-orchestration`
5. PR: Create PR to main branch with title "Epic 8 Story 8.3: Page Orchestration API"

### Testing Standards
[Source: Project conventions]
- Test files location: `__tests__` folder in same directory as source
- Testing framework: Jest with TypeScript
- Coverage requirement: 85%+ for services
- Use test database for integration tests
- Mock Prisma for unit tests using jest.mock()

### Implementation Example
[Source: docs/epic8-brownfield-architecture.md#page-orchestrator]
```typescript
interface CreatePageDto {
  // Content fields
  title: string;
  contentTypeId: string;
  content: Record<string, any>;
  metadata?: Record<string, any>;
  
  // Structure fields  
  parentId?: string;
  position?: number;
  slug?: string;  // Auto-generated if not provided
  
  // Publishing
  status?: 'draft' | 'published';
}
```

### API Response Format
```typescript
interface PageResult {
  contentItem: ContentItem;
  siteStructure: SiteStructure;
  fullPath: string;
  breadcrumbs?: Array<{id: string; title: string; slug: string}>;
}
```

### Error Handling
- Use HTTP 409 for slug conflicts
- Use HTTP 404 for non-existent resources
- Use HTTP 400 for validation errors
- Use HTTP 500 for transaction failures
- Always include error message in response

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-22 | 1.0 | Initial story creation based on Hybrid Orchestration Pattern | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
Claude Opus 4.1

### Debug Log References
N/A - No critical issues encountered

### Completion Notes List
- Implemented PageOrchestrator service with atomic transaction management
- Created comprehensive DTOs and types for page operations
- Built REST API endpoints for all page operations (create, update, delete, move, resolve)
- Adapted to existing database schema (pathDepth instead of depth, no materializedPath field)
- Removed authentication temporarily as auth system not yet implemented
- Fixed all TypeScript and linting errors
- Comprehensive unit tests with mocked Prisma transactions
- Integration tests covering all API endpoints
- URL resolution performance meets < 10ms requirement using indexed fullPath

### File List
- lib/services/site-structure/page-orchestrator.ts (created)
- lib/types/page-orchestrator.types.ts (created)
- lib/services/site-structure/errors.ts (modified)
- app/api/pages/route.ts (created)
- app/api/pages/[id]/route.ts (created)
- app/api/pages/[id]/move/route.ts (created)
- app/api/pages/resolve/route.ts (created)
- lib/services/site-structure/__tests__/page-orchestrator.test.ts (created)
- app/api/pages/__tests__/pages.integration.test.ts (created)

## QA Results
<!-- To be filled by QA Agent -->