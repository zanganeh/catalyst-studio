# Story 4.3: API Route Pattern Implementation

## Status
Ready for Review

## Story
**As a** developer,  
**I want** to implement the first API route with full CRUD operations,  
**so that** I establish the pattern for all subsequent APIs.

## Acceptance Criteria
1. Create first API route in `/app/api/[module]/route.ts`
2. Implement GET, POST, PUT, DELETE methods
3. Add proper error handling and response formatting
4. Include TypeScript types for request/response
5. Add basic validation using Zod or similar
6. Document the API pattern for team reference

## Tasks / Subtasks
- [x] Git Setup (REQUIRED FIRST TASK)
  - [x] Checkout and update develop: `git checkout develop && git pull origin develop`
  - [x] Create feature branch: `git checkout -b feature/4-3-api-route-pattern`
- [x] Create TypeScript Types (AC: 4)
  - [x] Create `/types/api.ts` with shared API types:
    - Base response types (success and error)
    - Website model types
    - Request/response interfaces
  - [x] Export types for use in both API routes and frontend
- [x] Implement Website API Route (AC: 1, 2)
  - [x] Create `/app/api/websites/route.ts`
  - [x] Implement GET method to list all websites
  - [x] Implement POST method to create new website
  - [x] Create `/app/api/websites/[id]/route.ts`
  - [x] Implement GET method to retrieve single website
  - [x] Implement PUT method to update website
  - [x] Implement DELETE method to remove website
- [x] Add Validation Layer (AC: 5)
  - [x] Create `/lib/api/validation/website.ts` with Zod schemas:
    - CreateWebsiteSchema for POST requests
    - UpdateWebsiteSchema for PUT requests
    - Query parameter schemas for GET requests
  - [x] Integrate validation in each API method
  - [x] Return 400 status with validation errors
- [x] Implement Error Handling (AC: 3)
  - [x] Create `/lib/api/errors.ts` with error handling utilities:
    - ApiError class for structured errors
    - Error response formatter
    - Common error handlers (404, 400, 500)
  - [x] Wrap all route handlers with try-catch
  - [x] Return consistent error format: `{ error: { message, code, details? } }`
- [x] Add Response Formatting (AC: 3)
  - [x] Create `/lib/api/responses.ts` with response utilities:
    - Success response formatter
    - Pagination helper (for future use)
    - Status code constants
  - [x] Ensure all responses follow format: `{ data: T } | { error: ErrorType }`
- [x] Create API Documentation (AC: 6)
  - [x] Create `/docs/api-patterns.md` documenting:
    - Route structure and naming conventions
    - Request/response format standards
    - Error handling patterns
    - Validation approach
    - Code examples from implemented routes
  - [x] Add JSDoc comments to all API methods
- [x] Test API Routes (AC: 2, 3)
  - [x] Create test script `/scripts/test-api.ts` to verify:
    - All CRUD operations work correctly
    - Error responses are properly formatted
    - Validation rejects invalid data
    - Status codes are correct
  - [x] Test with curl or Postman and document results
  - [x] Verify existing `/api/chat` route still works (IV2)
- [ ] Submit PR (REQUIRED FINAL TASK)
  - [ ] Push branch: `git push -u origin feature/4-3-api-route-pattern`
  - [ ] Create PR from feature branch â†’ develop branch
  - [ ] PR Title: "Epic 4 Story 3: API Route Pattern Implementation"
  - [ ] Link PR to story in description

## Dev Notes

### GitFlow Workflow
Branch Name: feature/4-3-api-route-pattern
Base Branch: develop (NOT main)  
PR Target: develop (NOT main)

Git Commands:
1. Setup: `git checkout develop && git pull origin develop`
2. Create: `git checkout -b feature/4-3-api-route-pattern`
3. Commit: Use conventional commits (feat:, fix:, docs:, etc.)
4. Push: `git push -u origin feature/4-3-api-route-pattern`
5. PR: Create PR to develop branch with title "Epic 4 Story 3: API Route Pattern Implementation"

### Technical Implementation Details

#### API Route Structure
[Source: architecture/epic4-architecture.md#api-design-and-integration]

Use Next.js App Router API routes with this structure:
- `/app/api/websites/route.ts` - Collection operations (GET all, POST new)
- `/app/api/websites/[id]/route.ts` - Item operations (GET one, PUT, DELETE)

#### TypeScript Types Structure
[Source: architecture/epic4-architecture.md#new-api-endpoints]

Create these types in `/types/api.ts`:

```typescript
// Base response types
export type ApiResponse<T> = 
  | { data: T }
  | { error: ApiError };

export interface ApiError {
  message: string;
  code?: string;
  details?: any;
}

// Website model types
export interface Website {
  id: string;
  name: string;
  description?: string;
  category: string;
  metadata?: Record<string, any>;
  createdAt: Date;
  updatedAt: Date;
}

export interface CreateWebsiteRequest {
  name: string;
  description?: string;
  category: string;
  metadata?: Record<string, any>;
}

export interface UpdateWebsiteRequest extends Partial<CreateWebsiteRequest> {}
```

#### Validation Schemas
[Source: architecture/epic4-architecture.md#critical-integration-rules]

Use Zod (already installed: version 3.25.76) for validation:

```typescript
// /lib/api/validation/website.ts
import { z } from 'zod';

export const CreateWebsiteSchema = z.object({
  name: z.string().min(1).max(255),
  description: z.string().optional(),
  category: z.string().min(1),
  metadata: z.record(z.any()).optional()
});

export const UpdateWebsiteSchema = CreateWebsiteSchema.partial();
```

#### Error Handling Pattern
[Source: architecture/epic4-architecture.md#critical-integration-rules]

Implement consistent error handling:

```typescript
// /lib/api/errors.ts
export class ApiError extends Error {
  constructor(
    public statusCode: number,
    message: string,
    public code?: string,
    public details?: any
  ) {
    super(message);
  }
}

export function handleApiError(error: unknown): Response {
  if (error instanceof ApiError) {
    return Response.json(
      { error: { message: error.message, code: error.code, details: error.details } },
      { status: error.statusCode }
    );
  }
  
  console.error('Unexpected error:', error);
  return Response.json(
    { error: { message: 'Internal server error', code: 'INTERNAL_ERROR' } },
    { status: 500 }
  );
}
```

#### Route Handler Example
[Source: architecture/epic4-architecture.md#api-route-handlers]

Example implementation for `/app/api/websites/route.ts`:

```typescript
import { NextRequest } from 'next/server';
import { getClient } from '@/lib/db/client';
import { CreateWebsiteSchema } from '@/lib/api/validation/website';
import { handleApiError, ApiError } from '@/lib/api/errors';

export async function GET() {
  try {
    const prisma = getClient();
    const websites = await prisma.website.findMany();
    return Response.json({ data: websites });
  } catch (error) {
    return handleApiError(error);
  }
}

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const validated = CreateWebsiteSchema.parse(body);
    
    const prisma = getClient();
    const website = await prisma.website.create({
      data: validated
    });
    
    return Response.json({ data: website }, { status: 201 });
  } catch (error) {
    if (error instanceof z.ZodError) {
      return handleApiError(new ApiError(400, 'Validation failed', 'VALIDATION_ERROR', error.errors));
    }
    return handleApiError(error);
  }
}
```

### Integration Verification Requirements
[Source: epic4-prd.md#story-4.3]

Must verify:
- IV1: API routes accessible at `/api/websites` endpoints
- IV2: Existing routes and pages continue to work (especially `/api/chat`)
- IV3: API responses follow consistent format

### Testing Standards
[Source: architecture/epic4-architecture.md#testing-strategy]

For API routes:
- Manual testing with curl/Postman for all CRUD operations
- Verify error cases (invalid data, not found, etc.)
- Document example requests/responses
- Future: Add Jest tests in `app/api/websites/__tests__/`

### Important Notes

1. This story establishes the pattern - must be exemplary code
2. All future API routes will follow this pattern
3. Use Prisma client from Story 4.2 setup
4. Focus on consistency and reusability
5. Document patterns thoroughly for team reference

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-12 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-08-12 | 1.1 | Completed implementation | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used
claude-opus-4-1-20250805

### Debug Log References
None

### Completion Notes List
- All CRUD operations implemented and tested successfully
- JSON serialization handling added for SQLite metadata storage
- Comprehensive error handling with custom ApiError class
- Validation using Zod schemas for type safety
- Complete API documentation created for team reference
- All tests pass (10/10)

### File List
- `/types/api.ts` - Created - API type definitions
- `/app/api/websites/route.ts` - Created - Collection endpoints (GET all, POST)
- `/app/api/websites/[id]/route.ts` - Created - Item endpoints (GET one, PUT, DELETE)
- `/lib/api/validation/website.ts` - Created - Zod validation schemas
- `/lib/api/errors.ts` - Created - Error handling utilities
- `/lib/api/responses.ts` - Created - Response formatting utilities
- `/docs/api-patterns.md` - Created - API patterns documentation
- `/scripts/test-api.ts` - Created - API test script
- `/docs/stories/4.3.api-route-pattern.story.md` - Modified - Updated status and checkboxes

## QA Results
*To be populated during QA review*