# Story 4.7: AI Context Manager Database Implementation

## Status
Approved

## Story
**As a** developer,  
**I want** to implement database storage for AI conversation context,  
**so that** AI interactions and prompts are persistently stored on the server.

## Acceptance Criteria
1. Create AIContext model in database schema
2. Implement `/app/api/ai-context` CRUD endpoints
3. Create service layer for AI context operations
4. Implement API-based AI context storage for frontend components
5. Add React Query hooks for AI context data fetching
6. Implement context pruning for large conversations
7. Verify all AI operations work correctly with fresh database

## Tasks / Subtasks
- [ ] Git Setup (REQUIRED FIRST TASK)
  - [ ] Checkout and update develop: `git checkout develop && git pull origin develop`
  - [ ] Create feature branch: `git checkout -b feature/4-7-ai-context-database`
- [ ] Create Database Schema (AC: 1)
  - [ ] Add to `prisma/schema.prisma`:
    ```prisma
    model AIContext {
      id           String   @id @default(cuid())
      websiteId    String
      sessionId    String
      messages     Json     // Array of conversation messages
      metadata     Json?    // Context metadata (tokens, model, etc.)
      summary      String?  // Summarized context for long conversations
      isActive     Boolean  @default(true)
      createdAt    DateTime @default(now())
      updatedAt    DateTime @updatedAt
      
      website Website @relation(fields: [websiteId], references: [id], onDelete: Cascade)
      
      @@index([websiteId, sessionId])
      @@unique([websiteId, sessionId])
    }
    ```
  - [ ] Add relation to Website model: `aiContexts AIContext[]`
  - [ ] Create database table (schema update): `npm run db:migrate -- --name add-ai-context`
- [ ] Create TypeScript Types (AC: 2)
  - [ ] Create `/types/ai-context.ts`:
    - AIMessage interface (role, content, timestamp)
    - AIContext interface matching schema
    - AIMetadata interface (model, tokens, temperature)
  - [ ] Ensure consistency with Prisma generated types
- [ ] Implement AI Context API Routes (AC: 2)
  - [ ] Create `/app/api/ai-context/route.ts`:
    - GET: List contexts by websiteId
    - POST: Create new context session
  - [ ] Create `/app/api/ai-context/[sessionId]/route.ts`:
    - GET: Retrieve specific session context
    - PUT: Update context (append messages)
    - DELETE: Soft delete context session
  - [ ] Create `/app/api/ai-context/[sessionId]/messages/route.ts`:
    - POST: Append new message to context
    - DELETE: Clear messages (keep session)
- [ ] Add Validation Schemas (AC: 2)
  - [ ] Create `/lib/api/validation/ai-context.ts`:
    - CreateAIContextSchema
    - UpdateAIContextSchema
    - AppendMessageSchema
    - Validate message structure and size limits
- [ ] Create AI Context Service Layer (AC: 3)
  - [ ] Create `/lib/services/ai-context-service.ts`:
    - `getAIContexts(websiteId)` - list all contexts
    - `getAIContext(sessionId)` - get specific context
    - `createAIContext(websiteId, initialMessage)` - start new session
    - `appendMessage(sessionId, message)` - add to conversation
    - `pruneContext(sessionId)` - remove old messages
    - `summarizeContext(sessionId)` - create summary for long chats
  - [ ] Implement message limit (e.g., keep last 50 messages)
  - [ ] Add token counting utility
- [ ] Implement Context Pruning (AC: 6)
  - [ ] Create `/lib/utils/ai-context-pruning.ts`:
    - Implement sliding window (keep recent N messages)
    - Create summarization before pruning
    - Calculate token counts
    - Preserve important context markers
  - [ ] Add pruning triggers:
    - Message count threshold (> 50 messages)
    - Token count threshold (> 8000 tokens)
    - Time-based pruning (older than 30 days)
- [ ] Create React Query Hooks (AC: 5)
  - [ ] Create `/lib/api/hooks/use-ai-context.ts`:
    - `useAIContexts(websiteId)` - fetch all contexts
    - `useAIContext(sessionId)` - fetch specific context
    - `useCreateAIContext()` - mutation for new session
    - `useAppendMessage()` - mutation for adding messages
    - `useClearContext()` - mutation for clearing
  - [ ] Implement optimistic updates for real-time feel
  - [ ] Add proper cache invalidation
- [ ] Implement Frontend Integration (AC: 4)
  - [ ] Identify or create AI components:
    - Search for existing AI-related components in codebase
    - Note: If no AI chat components exist, create basic chat interface
    - Document component locations for future reference
  - [ ] Integrate API calls in components:
    - Use React Query hooks for data fetching
    - Add loading states for context operations
    - Implement error recovery
  - [ ] Build/enhance AI chat functionality:
    - Use API for message persistence
    - Show context loading state
    - Handle session continuity
    - Create minimal chat UI if none exists
- [ ] Testing and Validation (AC: 7)
  - [ ] Create API tests:
    - Test CRUD operations
    - Test message appending
    - Test context pruning logic
    - Test token counting
  - [ ] Manual testing checklist:
    - Start with clean database
    - Create new AI conversation
    - Continue existing conversation
    - Test pruning with long conversation
    - Verify context persistence across sessions
    - Test multiple website contexts
  - [ ] Performance testing:
    - Measure API response times
    - Test with large message arrays
    - Verify pruning efficiency
- [ ] Documentation Updates
  - [ ] Document AI context API endpoints
  - [ ] Document pruning strategy
  - [ ] Add token limit guidelines
- [ ] Submit PR (REQUIRED FINAL TASK)
  - [ ] Push branch: `git push -u origin feature/4-7-ai-context-database`
  - [ ] Create PR from feature branch â†’ develop branch
  - [ ] PR Title: "Epic 4 Story 7: AI Context Manager Database Implementation"
  - [ ] Link PR to story in description

## Dev Notes

### GitFlow Workflow
Branch Name: feature/4-7-ai-context-database
Base Branch: develop (NOT main)  
PR Target: develop (NOT main)

Git Commands:
1. Setup: `git checkout develop && git pull origin develop`
2. Create: `git checkout -b feature/4-7-ai-context-database`
3. Commit: Use conventional commits (feat:, fix:, docs:, etc.)
4. Push: `git push -u origin feature/4-7-ai-context-database`
5. PR: Create PR to develop branch with title "Epic 4 Story 7: AI Context Manager Database Implementation"

### AI Context Storage Design
[Source: storage-audit-report.md#ai-conversation-management]

Database storage will handle:
- Active conversation sessions
- Historical conversation data
- Context metadata and summaries

### Message Structure
```typescript
interface AIMessage {
  role: 'user' | 'assistant' | 'system';
  content: string;
  timestamp: Date;
  metadata?: {
    model?: string;
    tokens?: number;
    temperature?: number;
  };
}
```

### Context Pruning Strategy
[Source: Best practices for AI context management]

1. **Sliding Window**: Keep last 50 messages
2. **Token Limit**: Max 8000 tokens per context
3. **Summarization**: Create summary before pruning
4. **Important Messages**: Preserve system prompts and key decisions

### API Pattern Reference
[Source: Stories 4.3-4.6 patterns]

Follow established patterns:
- Error handling: `/lib/api/errors.ts`
- Response format: `{ data: T } | { error: ErrorType }`
- Validation: Zod schemas
- Soft delete using isActive flag

### React Query Integration
Use patterns from Stories 4.4-4.6:
- Optimistic updates for real-time feel
- Proper cache invalidation
- Loading and error states

### Performance Considerations
1. **Large Message Arrays**: Use pagination for listing
2. **Real-time Updates**: Implement optimistic updates
3. **Token Counting**: Cache token counts in metadata
4. **Pruning**: Run as background job if needed

### Testing Standards
[Source: Stories 4.2-4.5 patterns]

**Test Configuration:**
- Test framework: Jest + React Testing Library
- Test file location: `__tests__` folders with `.test.ts` suffix
- Coverage requirement: Maintain existing coverage levels
- Start with clean database for testing (no migration)

**Module-Specific Testing Requirements:**
- Test all CRUD operations for AI context
- Test message appending and pruning logic
- Test token counting accuracy
- Verify context persistence across sessions
- Test with large message arrays (50+ messages)
- Performance benchmarks for large contexts
- Measure API response times (target < 200ms for typical operations)

### Important Notes

1. **Fresh Implementation**: Building new database functionality from scratch
2. **No Existing Data**: System has no production data, only test data
3. **Session Management**: Use unique sessionId per conversation
4. **Token Limits**: Implement token counting to prevent overflow
5. **Soft Delete**: Use isActive flag, preserve data for analytics
6. **Real-time Feel**: Use optimistic updates for chat interface

### Dependencies
This story depends on:
- Story 4.2: Database setup (Prisma configured)
- Story 4.3: API patterns established
- Story 4.6a: Website model exists

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-13 | 1.0 | Initial story creation - Fresh database implementation, no existing data | Bob (Scrum Master) |
| 2025-08-13 | 1.1 | Addressed PO feedback - Fixed AC4, added component creation notes, reorganized testing | Bob (Scrum Master) |

## Dev Agent Record
*To be populated during implementation*

### Agent Model Used
*To be populated*

### Debug Log References
*To be populated*

### Completion Notes List
*To be populated*

### File List
*To be populated*

## QA Results
*To be populated during QA review*