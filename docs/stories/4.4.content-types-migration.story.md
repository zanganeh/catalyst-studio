# Story 4.4: Content Types Module Migration

## Status
Approved

## Story
**As a** developer,  
**I want** to migrate content types from local storage to database,  
**so that** content type definitions are persistently stored.

## Acceptance Criteria
1. Create content_types table schema in ORM
2. Implement `/app/api/content-types/route.ts` with full CRUD
3. Create service layer for content type operations
4. Replace localStorage calls with API calls in frontend
5. Add data fetching with React Query/SWR
6. Verify all content type operations work correctly

## Tasks / Subtasks
- [ ] Git Setup (REQUIRED FIRST TASK)
  - [ ] Checkout and update develop: `git checkout develop && git pull origin develop`
  - [ ] Create feature branch: `git checkout -b feature/4-4-content-types-migration`
- [ ] Update Database Schema (AC: 1)
  - [ ] Ensure ContentType model exists in `prisma/schema.prisma` (from Story 4.2)
  - [ ] Run `npm run db:generate` to update Prisma client
  - [ ] Run `npm run db:migrate -- --name add_content_types` if schema changes needed
  - [ ] Verify schema matches requirements from audit
- [ ] Implement Content Types API Routes (AC: 2)
  - [ ] Create `/app/api/content-types/route.ts`:
    - GET: List all content types (with optional websiteId filter)
    - POST: Create new content type
  - [ ] Create `/app/api/content-types/[id]/route.ts`:
    - GET: Retrieve single content type
    - PUT: Update content type
    - DELETE: Delete content type (check for dependent content items)
  - [ ] Use patterns established in Story 4.3 (error handling, validation, response format)
- [ ] Create Validation Schemas (AC: 2)
  - [ ] Create `/lib/api/validation/content-type.ts`:
    - CreateContentTypeSchema
    - UpdateContentTypeSchema
    - ContentTypeFieldSchema for field definitions
  - [ ] Validate field structure matches existing format
- [ ] Implement Service Layer (AC: 3)
  - [ ] Create `/lib/services/content-type-service.ts`:
    - `getContentTypes(websiteId?: string)`
    - `getContentType(id: string)`
    - `createContentType(data: CreateContentTypeRequest)`
    - `updateContentType(id: string, data: UpdateContentTypeRequest)`
    - `deleteContentType(id: string)`
  - [ ] Add proper TypeScript types and error handling
  - [ ] Use Prisma client from Story 4.2
- [ ] Install and Configure React Query (AC: 5)
  - [ ] Install React Query: `npm install @tanstack/react-query`
  - [ ] Create `/lib/api/hooks/use-content-types.ts`:
    - `useContentTypes()` - fetch all content types
    - `useContentType(id)` - fetch single content type
    - `useCreateContentType()` - mutation for create
    - `useUpdateContentType()` - mutation for update
    - `useDeleteContentType()` - mutation for delete
  - [ ] Set up QueryClient provider in app layout if not exists
- [ ] Migrate ContentTypeContext (AC: 4, 5)
  - [ ] Update `/lib/context/content-type-context.tsx`:
    - Replace localStorage.getItem('contentTypes') with useContentTypes hook
    - Replace localStorage.setItem('contentTypes') with API mutations
    - Maintain same interface for minimal disruption
    - Add loading and error states
    - Keep optimistic updates for UI responsiveness
  - [ ] Update context methods to use React Query mutations
- [ ] Update Content Builder Page (AC: 4)
  - [ ] Update `/app/(dashboard)/content/page.tsx`:
    - Remove direct localStorage access
    - Use ContentTypeContext as before (interface unchanged)
  - [ ] Verify content type creation flow works
  - [ ] Ensure field management still functions
- [ ] Add Data Migration Script (AC: 6)
  - [ ] Create `/scripts/migrate-content-types.ts`:
    - Read existing contentTypes from localStorage
    - Transform to database format
    - Create records via API
    - Mark migration complete
  - [ ] Add migration command to package.json: `"migrate:content-types": "tsx scripts/migrate-content-types.ts"`
- [ ] Testing and Verification (AC: 6)
  - [ ] Test all CRUD operations through UI:
    - Create new content type
    - Edit existing content type
    - Delete content type
    - Add/remove fields
  - [ ] Verify data persistence across page refreshes
  - [ ] Test optimistic updates work correctly
  - [ ] Ensure no UI regressions (IV1)
  - [ ] Run migration script with test data (IV2)
  - [ ] Measure response times for UI operations (IV3)
- [ ] Submit PR (REQUIRED FINAL TASK)
  - [ ] Push branch: `git push -u origin feature/4-4-content-types-migration`
  - [ ] Create PR from feature branch â†’ develop branch
  - [ ] PR Title: "Epic 4 Story 4: Content Types Module Migration"
  - [ ] Link PR to story in description

## Dev Notes

### GitFlow Workflow
Branch Name: feature/4-4-content-types-migration
Base Branch: develop (NOT main)  
PR Target: develop (NOT main)

Git Commands:
1. Setup: `git checkout develop && git pull origin develop`
2. Create: `git checkout -b feature/4-4-content-types-migration`
3. Commit: Use conventional commits (feat:, fix:, docs:, etc.)
4. Push: `git push -u origin feature/4-4-content-types-migration`
5. PR: Create PR to develop branch with title "Epic 4 Story 4: Content Types Module Migration"

### Existing Content Type Structure
[Source: storage-audit-report.md#content-management]

Current localStorage implementation in:
- `lib/context/content-type-context.tsx` - Main context provider
- `app/(dashboard)/content/page.tsx` - Content management page
- Key: `contentTypes`
- Data structure: Array of ContentType objects

### ContentType Interface
[Source: lib/types/content.ts]

```typescript
interface ContentType {
  id: string;
  name: string;
  fields: ContentField[];
  createdAt?: string;
  updatedAt?: string;
}

interface ContentField {
  id: string;
  name: string;
  type: 'text' | 'number' | 'date' | 'boolean' | 'select' | 'multiselect' | 'richtext';
  required?: boolean;
  options?: string[]; // for select/multiselect
  defaultValue?: any;
}
```

### API Implementation Pattern
[Source: Story 4.3 patterns]

Follow the established patterns from Story 4.3:
- Use consistent error handling from `/lib/api/errors.ts`
- Apply response formatting from `/lib/api/responses.ts`
- Implement validation with Zod schemas
- Return format: `{ data: T } | { error: ErrorType }`

### React Query Setup
[Source: architecture/epic4-architecture.md#new-technology-additions]

React Query configuration:
```typescript
// /lib/api/hooks/use-content-types.ts
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';

export function useContentTypes(websiteId?: string) {
  return useQuery({
    queryKey: ['content-types', websiteId],
    queryFn: () => fetchContentTypes(websiteId),
  });
}

export function useCreateContentType() {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: createContentType,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['content-types'] });
    },
  });
}
```

### Migration Strategy
[Source: architecture/epic4-architecture.md#schema-integration-strategy]

1. **Backward compatibility**: Keep ContentTypeContext interface unchanged
2. **Optimistic updates**: Use React Query's optimistic update feature
3. **Error recovery**: Fallback to cached data on API failures
4. **Progressive migration**: Can run with feature flag if needed

### Integration Verification Requirements
[Source: epic4-prd.md#story-4.4]

Must verify:
- IV1: Existing content type features remain functional
- IV2: No data loss during transition
- IV3: UI responsiveness maintained despite API calls

### Testing Standards
[Source: architecture/epic4-architecture.md#testing-strategy]

- Manual testing through UI for all CRUD operations
- Verify optimistic updates provide smooth UX
- Test error states and recovery
- Measure response times to ensure < 200ms for typical operations

### Important Notes

1. **Maintain backward compatibility** - Context interface must not change
2. **Use optimistic updates** - Critical for UI responsiveness
3. **Handle relationships** - Content types may have dependent content items
4. **Migration safety** - Backup localStorage before migration
5. **Use patterns from Story 4.3** - Consistency is key

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-12 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*To be populated during implementation*

### Agent Model Used
*To be populated*

### Debug Log References
*To be populated*

### Completion Notes List
*To be populated*

### File List
*To be populated*

## QA Results
*To be populated during QA review*