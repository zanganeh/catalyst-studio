# Story 4.4: Content Types Module Migration

## Status
Ready for Review

## Story
**As a** developer,  
**I want** to migrate content types from local storage to database,  
**so that** content type definitions are persistently stored.

## Acceptance Criteria
1. Create content_types table schema in ORM
2. Implement `/app/api/content-types/route.ts` with full CRUD
3. Create service layer for content type operations
4. Replace localStorage calls with API calls in frontend
5. Add data fetching with React Query/SWR
6. Verify all content type operations work correctly

## Tasks / Subtasks
- [x] Git Setup (REQUIRED FIRST TASK)
  - [x] Checkout and update develop: `git checkout develop && git pull origin develop`
  - [x] Create feature branch: `git checkout -b feature/4-4-content-types-migration`
- [x] Update Database Schema (AC: 1)
  - [x] Ensure ContentType model exists in `prisma/schema.prisma` (from Story 4.2)
  - [x] Run `npm run db:generate` to update Prisma client
  - [x] Run `npm run db:migrate -- --name add_content_types` if schema changes needed
  - [x] Verify schema matches requirements from audit
- [x] Implement Content Types API Routes (AC: 2)
  - [x] Create `/app/api/content-types/route.ts`:
    - GET: List all content types (with optional websiteId filter)
    - POST: Create new content type
  - [x] Create `/app/api/content-types/[id]/route.ts`:
    - GET: Retrieve single content type
    - PUT: Update content type
    - DELETE: Delete content type (check for dependent content items)
  - [x] Use patterns established in Story 4.3 (error handling, validation, response format)
- [x] Create Validation Schemas (AC: 2)
  - [x] Create `/lib/api/validation/content-type.ts`:
    - CreateContentTypeSchema
    - UpdateContentTypeSchema
    - ContentTypeFieldSchema for field definitions
  - [x] Validate field structure matches existing format
- [x] Implement Service Layer (AC: 3)
  - [x] Create `/lib/services/content-type-service.ts`:
    - `getContentTypes(websiteId?: string)`
    - `getContentType(id: string)`
    - `createContentType(data: CreateContentTypeRequest)`
    - `updateContentType(id: string, data: UpdateContentTypeRequest)`
    - `deleteContentType(id: string)`
  - [x] Add proper TypeScript types and error handling
  - [x] Use Prisma client from Story 4.2
- [x] Install and Configure React Query (AC: 5)
  - [x] Install React Query: `npm install @tanstack/react-query`
  - [x] Create `/lib/api/hooks/use-content-types.ts`:
    - `useContentTypes()` - fetch all content types
    - `useContentType(id)` - fetch single content type
    - `useCreateContentType()` - mutation for create
    - `useUpdateContentType()` - mutation for update
    - `useDeleteContentType()` - mutation for delete
  - [x] Set up QueryClient provider in app layout if not exists
- [x] Update ContentTypeContext (AC: 4, 5)
  - [x] Update `/lib/context/content-type-context.tsx`:
    - Replace localStorage.getItem('contentTypes') with useContentTypes hook
    - Replace localStorage.setItem('contentTypes') with API mutations
    - Maintain same interface for minimal disruption
    - Add loading and error states
    - Keep optimistic updates for UI responsiveness
  - [x] Update context methods to use React Query mutations
- [x] Update Content Builder Page (AC: 4)
  - [x] Update `/app/(dashboard)/content/page.tsx`:
    - Remove direct localStorage access
    - Use ContentTypeContext as before (interface unchanged)
  - [x] Verify content type creation flow works
  - [x] Ensure field management still functions
- [x] Testing and Verification (AC: 6)
  - [x] Test all CRUD operations through UI:
    - Create new content type
    - Edit existing content type
    - Delete content type
    - Add/remove fields
  - [x] Verify data persistence across page refreshes
  - [x] Test optimistic updates work correctly
  - [x] Ensure no UI regressions (IV1)
  - [x] Clear localStorage test data before testing (no migration needed)
  - [x] Measure response times for UI operations (IV3)
- [x] Submit PR (REQUIRED FINAL TASK)
  - [x] Push branch: `git push -u origin feature/4-4-content-types-migration`
  - [x] Create PR from feature branch â†’ develop branch
  - [x] PR Title: "Epic 4 Story 4: Content Types Module Migration"
  - [x] Link PR to story in description

## Dev Notes

### GitFlow Workflow
Branch Name: feature/4-4-content-types-migration
Base Branch: develop (NOT main)  
PR Target: develop (NOT main)

Git Commands:
1. Setup: `git checkout develop && git pull origin develop`
2. Create: `git checkout -b feature/4-4-content-types-migration`
3. Commit: Use conventional commits (feat:, fix:, docs:, etc.)
4. Push: `git push -u origin feature/4-4-content-types-migration`
5. PR: Create PR to develop branch with title "Epic 4 Story 4: Content Types Module Migration"

### Existing Content Type Structure
[Source: storage-audit-report.md#content-management]

Current localStorage implementation in:
- `lib/context/content-type-context.tsx` - Main context provider
- `app/(dashboard)/content/page.tsx` - Content management page
- Key: `contentTypes`
- Data structure: Array of ContentType objects

### ContentType Interface
[Source: lib/types/content.ts]

```typescript
interface ContentType {
  id: string;
  name: string;
  fields: ContentField[];
  createdAt?: string;
  updatedAt?: string;
}

interface ContentField {
  id: string;
  name: string;
  type: 'text' | 'number' | 'date' | 'boolean' | 'select' | 'multiselect' | 'richtext';
  required?: boolean;
  options?: string[]; // for select/multiselect
  defaultValue?: any;
}
```

### API Implementation Pattern
[Source: Story 4.3 patterns]

Follow the established patterns from Story 4.3:
- Use consistent error handling from `/lib/api/errors.ts`
- Apply response formatting from `/lib/api/responses.ts`
- Implement validation with Zod schemas
- Return format: `{ data: T } | { error: ErrorType }`

### React Query Setup
[Source: architecture/epic4-architecture.md#new-technology-additions]

React Query configuration:
```typescript
// /lib/api/hooks/use-content-types.ts
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';

export function useContentTypes(websiteId?: string) {
  return useQuery({
    queryKey: ['content-types', websiteId],
    queryFn: () => fetchContentTypes(websiteId),
  });
}

export function useCreateContentType() {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: createContentType,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['content-types'] });
    },
  });
}
```

### Implementation Strategy
[Source: architecture/epic4-architecture.md#schema-integration-strategy]

1. **Backward compatibility**: Keep ContentTypeContext interface unchanged
2. **Optimistic updates**: Use React Query's optimistic update feature
3. **Error recovery**: Fallback to cached data on API failures
4. **No migration needed**: System is not in production, test data can be discarded

### Integration Verification Requirements
[Source: epic4-prd.md#story-4.4]

Must verify:
- IV1: Existing content type features remain functional
- IV2: Clean transition (no migration needed - test data can be cleared)
- IV3: UI responsiveness maintained despite API calls

### Testing Standards
[Source: architecture/epic4-architecture.md#testing-strategy]

- Manual testing through UI for all CRUD operations
- Verify optimistic updates provide smooth UX
- Test error states and recovery
- Measure response times to ensure < 200ms for typical operations

### Important Notes

1. **Maintain backward compatibility** - Context interface must not change
2. **Use optimistic updates** - Critical for UI responsiveness
3. **Handle relationships** - Content types may have dependent content items
4. **No migration required** - Clear localStorage test data, start fresh with database
5. **Use patterns from Story 4.3** - Consistency is key

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-12 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-08-12 | 1.1 | Removed migration requirements - no production data to preserve | User Request |

## Dev Agent Record

### Agent Model Used
Claude 3.5 Sonnet (claude-3-5-sonnet-20241022)

### Debug Log References
- Successfully ran database migration (no changes needed, schema already in place)
- API routes tested with curl commands
- Content builder page tested in browser
- Type checking and linting completed

### Completion Notes List
- ContentType model was already created in Story 4.2, no schema changes needed
- Implemented API routes following patterns from Story 4.3
- React Query integrated for data fetching with optimistic updates
- ContentTypeContext refactored to use API while maintaining same interface
- Fixed Next.js 15 async params issue in dynamic routes
- Default websiteId used from existing test data in database
- No data migration needed as system is not in production

### File List
- app/api/content-types/route.ts (new)
- app/api/content-types/[id]/route.ts (new)
- lib/api/validation/content-type.ts (new)
- lib/services/content-type-service.ts (new)
- lib/api/hooks/use-content-types.ts (new)
- lib/providers/query-provider.tsx (new)
- lib/context/content-type-context.tsx (modified)
- lib/context/content-type-context-old.tsx (backup)
- components/providers.tsx (modified)
- app/(dashboard)/content/page.tsx (modified)

## QA Results
*To be populated during QA review*