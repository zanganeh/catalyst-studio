# Story 9.5: Undo/Redo System Implementation

## Status
Approved

## Story
**As a** sitemap builder user,
**I want** comprehensive undo/redo functionality with keyboard shortcuts,
**so that** I can easily revert or restore changes during sitemap editing without fear of losing work.

## Acceptance Criteria
1. System maintains a linear history of up to 50 operations
2. Undo (Ctrl+Z/Cmd+Z) reverts to previous state instantly
3. Redo (Ctrl+Y/Ctrl+Shift+Z/Cmd+Shift+Z) restores next state if available
4. Visual indicators show when undo/redo are available or disabled
5. Complete state snapshots include all nodes, edges, and component data
6. Handle branching - clear redo stack when new changes made after undo
7. State restoration completes within 100ms for smooth UX
8. History persists across component re-renders but not page refresh
9. Memory efficient - old states removed when 50 operation limit exceeded
10. All sitemap operations are undoable (create, update, delete, move nodes)
11. Component changes within pages are also undoable
12. Undo/redo operations themselves don't create new history entries

## Tasks / Subtasks
- [ ] Git Setup (REQUIRED FIRST TASK)
  - [ ] Checkout and update main: `git checkout main && git pull origin main`
  - [ ] Create story branch from main: `git checkout -b story/EPIC9-005-undo-redo`
- [ ] Create UndoManager Class (AC: 1, 5, 6)
  - [ ] Create `/lib/premium/components/sitemap/undo-manager.ts`
  - [ ] Define TypeScript interface for history state:
    ```typescript
    interface HistoryState {
      nodes: Node[];
      edges: Edge[];
      timestamp: number;
      description?: string; // Optional operation description
    }
    ```
  - [ ] Implement UndoManager class with:
    - [ ] Private history array: `HistoryState[]`
    - [ ] Private currentIndex pointer
    - [ ] Max history limit constant: `MAX_HISTORY = 50`
  - [ ] Add method to capture current state: `pushState(state: HistoryState)`
  - [ ] Implement branching logic - clear redo stack on new changes
  - [ ] Add memory management - remove oldest when limit exceeded
- [ ] Implement Core Undo/Redo Methods (AC: 2, 3, 7)
  - [ ] Create `undo()` method:
    - [ ] Check if undo available (currentIndex > 0)
    - [ ] Decrement currentIndex
    - [ ] Return state at currentIndex
    - [ ] Ensure operation completes < 100ms
  - [ ] Create `redo()` method:
    - [ ] Check if redo available (currentIndex < history.length - 1)
    - [ ] Increment currentIndex
    - [ ] Return state at currentIndex
    - [ ] Ensure operation completes < 100ms
  - [ ] Add helper methods:
    - [ ] `canUndo(): boolean`
    - [ ] `canRedo(): boolean`
    - [ ] `clear(): void` - Reset history
    - [ ] `getHistorySize(): number`
- [ ] Create React Hook Integration (AC: 8)
  - [ ] Create `/lib/premium/hooks/use-undo-redo.ts`
  - [ ] Implement `useUndoRedo` hook:
    ```typescript
    export function useUndoRedo(initialState: HistoryState) {
      const undoManagerRef = useRef(new UndoManager());
      // ... hook implementation
    }
    ```
  - [ ] Use useRef to persist UndoManager across renders
  - [ ] Return object with:
    - [ ] `undo()` function
    - [ ] `redo()` function
    - [ ] `pushState()` function
    - [ ] `canUndo` boolean
    - [ ] `canRedo` boolean
    - [ ] `historySize` number
  - [ ] Ensure state persists during component lifecycle
- [ ] Integrate with Zustand Store (AC: 10, 11, 12)
  - [ ] Modify `/lib/premium/stores/sitemap-store.ts`
  - [ ] Add UndoManager instance to store
  - [ ] Wrap all state-changing actions to capture history:
    - [ ] Before: `addNode()`, `updateNode()`, `deleteNode()`, `moveNode()`
    - [ ] Before: Component operations (add/remove/reorder)
  - [ ] Create store actions:
    - [ ] `undo()` - Apply undo and update store state
    - [ ] `redo()` - Apply redo and update store state
  - [ ] Ensure undo/redo operations don't trigger new history entries
  - [ ] Add flag to prevent history capture during undo/redo
- [ ] Implement Keyboard Shortcuts (AC: 2, 3)
  - [ ] Create keyboard event handler in sitemap builder component
  - [ ] Register shortcuts:
    - [ ] Undo: Ctrl+Z (Windows/Linux), Cmd+Z (Mac)
    - [ ] Redo: Ctrl+Y, Ctrl+Shift+Z (Windows/Linux), Cmd+Shift+Z (Mac)
  - [ ] Use `useEffect` to add/remove event listeners
  - [ ] Check for input/textarea focus to avoid conflicts
  - [ ] Prevent default browser behavior for these shortcuts
  - [ ] Call store's undo/redo methods on shortcut trigger
- [ ] Create Visual Indicators UI (AC: 4)
  - [ ] Create `/lib/premium/components/sitemap/undo-redo-controls.tsx`
  - [ ] Design button component with:
    - [ ] Undo button with icon (arrow-left or rotate-left)
    - [ ] Redo button with icon (arrow-right or rotate-right)
  - [ ] Connect to store state:
    - [ ] Disable undo when `!canUndo`
    - [ ] Disable redo when `!canRedo`
    - [ ] Show disabled state visually (opacity, cursor)
  - [ ] Add tooltips showing keyboard shortcuts
  - [ ] Position controls in toolbar or top-right corner
  - [ ] Optional: Show history count (e.g., "5/50 operations")
- [ ] Memory Optimization (AC: 9)
  - [ ] Implement efficient state cloning:
    - [ ] Use structured cloning for deep copies
    - [ ] Consider using Immer for immutable updates
  - [ ] Add state compression if needed:
    - [ ] Store only diffs instead of full snapshots (optional enhancement)
  - [ ] Monitor memory usage in development
  - [ ] Add memory profiling tests
  - [ ] Implement cleanup on component unmount
- [ ] Testing Implementation (AC: 1-12)
  - [ ] Create `/lib/premium/components/sitemap/__tests__/undo-manager.test.ts`
  - [ ] Unit tests for UndoManager:
    - [ ] Test history limit enforcement (50 operations)
    - [ ] Test branching behavior
    - [ ] Test undo/redo operations
    - [ ] Test canUndo/canRedo logic
  - [ ] Integration tests with Zustand store:
    - [ ] Test state capture for all operations
    - [ ] Test undo/redo with actual sitemap data
    - [ ] Test that undo/redo don't create new history
  - [ ] React Testing Library tests:
    - [ ] Test keyboard shortcuts
    - [ ] Test visual indicators
    - [ ] Test hook behavior
  - [ ] Performance tests:
    - [ ] Verify < 100ms restoration time
    - [ ] Test with 50 operations in history
    - [ ] Memory usage benchmarks
- [ ] Documentation and Examples
  - [ ] Add JSDoc comments to all public methods
  - [ ] Create usage example in sitemap builder
  - [ ] Document keyboard shortcuts in UI
  - [ ] Add inline comments for complex logic
  - [ ] Update README with undo/redo feature
- [ ] Submit PR (REQUIRED FINAL TASK)
  - [ ] Ensure all tests pass: `npm test`
  - [ ] Check no console errors in browser
  - [ ] Verify performance targets met
  - [ ] Push branch: `git push -u origin story/EPIC9-005-undo-redo`
  - [ ] Create PR from story branch â†’ main branch
  - [ ] PR Title: "feat(EPIC9-005): implement comprehensive undo/redo system"
  - [ ] Link PR to story in description
  - [ ] Include performance benchmarks in PR description

## Dev Notes

### GitFlow Workflow
**CRITICAL: Follow GitFlow strictly for this story**

Branch Name: `story/EPIC9-005-undo-redo`
Base Branch: `main`
PR Target: `main`

Git Commands:
1. Setup: `git checkout main && git pull origin main`
2. Create: `git checkout -b story/EPIC9-005-undo-redo`
3. Commit: Use conventional commits (feat:, fix:, docs:, etc.)
4. Push: `git push -u origin story/EPIC9-005-undo-redo`
5. PR: Create PR to main branch with title "feat(EPIC9-005): implement comprehensive undo/redo system"

### Technical Implementation Details

#### Required File Locations (CRITICAL - Premium Feature)
All files MUST be created under `/lib/premium/` paths:
```
/lib/premium/components/sitemap/undo-manager.ts         # Main UndoManager class
/lib/premium/hooks/use-undo-redo.ts                    # React hook for undo/redo
/lib/premium/components/sitemap/undo-redo-controls.tsx # UI controls component
/lib/premium/stores/sitemap-store.ts                   # Modify existing store
```

#### State Structure (from PRD Appendix A)
```typescript
interface HistoryState {
  nodes: Node[];    // Complete React Flow nodes array
  edges: Edge[];    // Complete React Flow edges array
  timestamp: number;
  description?: string; // Optional: "Added page node", "Deleted folder", etc.
}
```

#### Performance Requirements
- State restoration must complete within 100ms
- Support up to 50 operations in history
- Memory efficient - use structured cloning
- No performance degradation with full history

#### Integration Points
1. **Zustand Store** (`/lib/premium/stores/sitemap-store.ts`):
   - Already exists from Story 9.4
   - Current interface includes history array and historyIndex
   - Key existing methods to wrap: addNode, updateNode, deleteNodes, moveNode
   - Existing store interface:
   ```typescript
   interface SitemapState {
     nodes: SitemapNode[];
     edges: SitemapEdge[];
     websiteId: string | null;
     selectedNodes: string[];
     saveStatus: SaveStatus;
     
     // History (partially implemented)
     history: Array<{ nodes: SitemapNode[]; edges: SitemapEdge[] }>;
     historyIndex: number;
     
     // Actions to wrap with history capture
     addNode: (parentId: string | null, data: CreateNodeData) => void;
     updateNode: (nodeId: string, updates: Partial<Node>) => void;
     deleteNodes: (nodeIds: string[]) => void;
     moveNode: (nodeId: string, newParentId: string | null) => void;
   }
   ```

2. **React Flow UI**:
   - Already integrated in `/app/premium/demo/sitemap-builder/page.tsx`
   - Add keyboard event handlers
   - Add UI controls to toolbar

3. **Save Manager**:
   - Undo/redo operations should trigger saves
   - Coordinate with debounced saving

#### Keyboard Shortcut Implementation
Use standard patterns for cross-platform support:
```typescript
const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
const undoKey = isMac ? 'metaKey' : 'ctrlKey';

// In event handler:
if (e[undoKey] && e.key === 'z' && !e.shiftKey) {
  // Undo
} else if (e[undoKey] && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {
  // Redo
}
```

### Testing Standards

#### Test Locations
- Unit tests: `/lib/premium/components/sitemap/__tests__/undo-manager.test.ts`
- Integration tests: `/lib/premium/stores/__tests__/sitemap-store.test.ts`
- Component tests: `/lib/premium/components/sitemap/__tests__/undo-redo-controls.test.tsx`

#### Testing Framework
- Jest for unit tests
- React Testing Library for component tests
- Use `@testing-library/user-event` for keyboard shortcuts

#### Key Test Scenarios
1. History limit enforcement (50 operations)
2. Branching behavior (redo stack cleared on new changes)
3. Performance benchmarks (< 100ms)
4. Memory usage monitoring
5. Keyboard shortcut functionality
6. Visual indicator states

### Dependencies from Previous Stories
- **Story 9.4**: Zustand store already created at `/lib/premium/stores/sitemap-store.ts`
- **Story 9.4**: React Flow UI integration complete
- **Story 9.3**: Dagre layout - undo/redo should preserve or recalculate layout

### Global Component Metadata Structure
The 4 MVP global components (hero, header, footer, CTA) use this metadata format:
```typescript
interface ComponentMetadata {
  id: string;                    // Unique identifier
  name: string;                  // Display name
  category: 'hero' | 'header' | 'footer' | 'cta';
  aiContext?: string;            // AI-specific context for generation
  defaultConfig?: Record<string, any>;  // Default configuration
  allowedInPageTypes?: string[]; // Which page types can use this
}
```

### Important Notes
1. **Premium Feature**: All code MUST be in `/lib/premium/` folders
2. **No Manual Position**: Layout is auto-calculated, so position changes aren't in history
3. **Component Data**: Must include component configurations in state snapshots
4. **Performance**: Critical for UX - must feel instant (< 100ms)
5. **Memory**: With 50 states, approximate memory usage: 50 * ~10KB = 500KB (acceptable)
6. **Browser Compatibility**: Use JSON.parse(JSON.stringify()) for deep cloning if structuredClone not available

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-26 | 1.0 | Initial story draft created | Bob (Scrum Master) |
| 2025-01-26 | 1.1 | Fixed Git remotes, corrected file paths, added missing context per PO validation | Bob (Scrum Master) |

## Dev Agent Record
*To be populated during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*To be populated by QA review*