# Story 8.5: AI Site Generation Engine

## Status
Draft

## Story Metadata
- **Epic**: Epic 8 - AI-Powered Site Structure Generation
- **Story ID**: 8.5
- **Story Points**: 8
- **Priority**: P0 (Critical)
- **Dependencies**: Story 8.1 (Database Schema), Story 8.2 (Slug Management), Story 8.3 (Page Orchestration API), Story 8.4 (Site Structure Service Layer)
- **Risk Level**: High (Core AI integration for site generation)
- **Estimated Duration**: 3 days

## Story

**As a** developer,
**I want** an AI-powered site structure generation engine that creates hierarchical site structures from natural language requirements,
**So that** users can generate complete site structures with appropriate content types and SEO-friendly slugs automatically using AI.

## Background & Context

Following the implementation of the Page Orchestration API (8.3) and Site Structure Service Layer (8.4), we now need to implement the AI Site Generation Engine. This engine will analyze natural language requirements and generate hierarchical site structures, suggest appropriate content types for each page, create SEO-friendly slugs, and use the PageOrchestrator to create all pages atomically in the database.

### Key Architectural Requirements
The AI Site Generation Engine provides:
- Natural language understanding of site requirements
- Hierarchical structure generation with proper parent-child relationships
- Content type suggestion based on page purpose
- SEO-friendly slug generation
- Atomic page creation using PageOrchestrator
- Validation before creation
- Support for rollback on partial failures

## Acceptance Criteria

1. [ ] AI Generation Service implemented with GPT-4 integration
2. [ ] Generate hierarchical site structure from natural language requirements
3. [ ] Suggest appropriate content types for each page based on context
4. [ ] Create SEO-friendly slugs automatically
5. [ ] Validate generated structure before creation
6. [ ] Process AI-generated structure and create pages atomically using Page Orchestrator
7. [ ] Handle batch creation in database transactions
8. [ ] Report generation statistics (pages created, structure depth, etc.)
9. [ ] POST `/api/pages/generate` endpoint implemented
10. [ ] Use PageOrchestrator for all page creation
11. [ ] Maintain referential integrity throughout generation
12. [ ] Support rollback on partial failures
13. [ ] Unit tests with 80%+ coverage for AI service
14. [ ] Integration tests validating end-to-end generation

## Tasks / Subtasks

- [ ] **Git Setup** (REQUIRED FIRST TASK)
  - [ ] Checkout and update main: `git checkout main && git pull origin main`
  - [ ] Create feature branch: `git checkout -b feature/8-5-ai-site-generation`

- [ ] **Create AI Generation Service** (AC: 1)
  - [ ] Create `lib/services/ai/site-structure-generator.ts`
  - [ ] Implement `ISiteStructureGenerator` interface
  - [ ] Add OpenAI/GPT-4 integration configuration
  - [ ] Create error handling for AI failures

- [ ] **Implement Prompt Engineering** (AC: 2, 3, 4)
  - [ ] Create `lib/prompts/site-structure-prompt.ts`
  - [ ] Design system prompt for site structure generation
  - [ ] Create user prompt template with variable injection
  - [ ] Add few-shot examples for consistent output
  - [ ] Implement output schema validation

- [ ] **Create Structure Parser** (AC: 2, 5)
  - [ ] Create `lib/services/ai/structure-parser.ts`
  - [ ] Parse AI response into structured format
  - [ ] Validate node relationships and hierarchy
  - [ ] Ensure no circular references
  - [ ] Validate content type suggestions exist

- [ ] **Implement Content Type Mapper** (AC: 3)
  - [ ] Create `lib/services/ai/content-type-mapper.ts`
  - [ ] Map page purposes to existing content types
  - [ ] Query available content types from database
  - [ ] Create fallback to default 'Page' content type if no match found
  - [ ] Log unmapped content types for future content type creation
  - [ ] Cache content type mappings for performance

- [ ] **Implement Slug Generation** (AC: 4)
  - [ ] Integrate with existing slug-manager utilities
  - [ ] Generate SEO-friendly slugs from page titles
  - [ ] Handle duplicate slug conflicts
  - [ ] Ensure URL-safe characters only
  - [ ] Apply slug uniqueness per parent

- [ ] **Create Validation Service** (AC: 5)
  - [ ] Create `lib/services/ai/structure-validator.ts`
  - [ ] Validate tree structure integrity
  - [ ] Check content type availability
  - [ ] Verify slug uniqueness
  - [ ] Ensure max depth constraints
  - [ ] Return detailed validation report

- [ ] **Implement Page Creation Pipeline** (AC: 6, 7, 10)
  - [ ] Create `lib/services/ai/page-creation-pipeline.ts`
  - [ ] Process nodes in breadth-first order
  - [ ] Use PageOrchestrator.createPage for each node
  - [ ] Map AI structure to CreatePageDto format
  - [ ] Handle parent-child relationships correctly

- [ ] **Add Transaction Management** (AC: 7, 11, 12)
  - [ ] Wrap entire creation in database transaction
  - [ ] Implement rollback on any failure
  - [ ] Log transaction progress for debugging
  - [ ] Handle partial failure scenarios
  - [ ] Return detailed error information

- [ ] **Create Generation API Endpoint** (AC: 9)
  - [ ] Create `app/api/pages/generate/route.ts`
  - [ ] Implement POST handler with request validation
  - [ ] Add website ID header requirement
  - [ ] Parse and validate generation options
  - [ ] Call AI generation service
  - [ ] Return generation results with statistics

- [ ] **Add Generation Statistics** (AC: 8)
  - [ ] Track total pages created
  - [ ] Record structure depth
  - [ ] Calculate generation time
  - [ ] Count pages by content type
  - [ ] Return statistics in API response

- [ ] **Create Type Definitions** (AC: 1, 9)
  - [ ] Create `lib/types/ai-generation.types.ts`
  - [ ] Define GenerationRequest interface
  - [ ] Define GeneratedNode interface
  - [ ] Define GenerationResult interface
  - [ ] Export all AI-related types

- [ ] **Write Unit Tests** (AC: 13)
  - [ ] Create `lib/services/ai/__tests__/site-structure-generator.test.ts`
  - [ ] Test prompt generation
  - [ ] Test structure parsing
  - [ ] Test validation logic
  - [ ] Test error handling
  - [ ] Mock OpenAI responses

- [ ] **Write Integration Tests** (AC: 14)
  - [ ] Create `app/api/pages/generate/__tests__/route.test.ts`
  - [ ] Test complete generation flow
  - [ ] Test transaction rollback
  - [ ] Test with various requirement inputs
  - [ ] Verify database state after generation

- [ ] **Documentation** (AC: 1, 9)
  - [ ] Add JSDoc comments to all public methods
  - [ ] Document prompt engineering approach
  - [ ] Create usage examples
  - [ ] Document error codes and handling

- [ ] **Submit PR** (REQUIRED FINAL TASK)
  - [ ] Push branch: `git push -u origin feature/8-5-ai-site-generation`
  - [ ] Create PR from feature branch â†’ main branch
  - [ ] PR Title: "Epic 8 Story 8.5: AI Site Generation Engine"
  - [ ] Link PR to story in description

## Dev Notes

### Previous Story Insights
From Story 8.3 (Page Orchestration API):
- PageOrchestrator is in `lib/services/site-structure/page-orchestrator.ts`
- Uses atomic page creation with ContentItem + SiteStructure
- Slug generation handled by `generateUniqueSlug` from slug-validator
- API endpoint `/api/pages` already exists for page creation
- Uses Prisma transactions with `$transaction` for atomicity

From Story 8.4 (Site Structure Service Layer):
- SiteStructureService provides tree operations
- Path management in `lib/services/site-structure/path-manager.ts`
- Validation methods available for structure integrity
- Repository pattern implemented for data access

### Architecture Context

#### AI Integration Architecture
[Source: docs/epic8-brownfield-architecture.md#prompt-engineering-system]
```typescript
// AI Generation Service structure
interface SiteStructurePrompt {
  requirements: string;
  maxDepth?: number;
  includedPageTypes?: string[];
  seoOptimized?: boolean;
}

interface GeneratedNode {
  title: string;
  slug: string;
  contentType: string;
  children: GeneratedNode[];
  metadata?: Record<string, any>;
}
```

#### Prompt Engineering Template
[Source: docs/epic8-brownfield-architecture.md#prompt-engineering-system]
```typescript
const template = `
Generate a hierarchical site structure for the following requirements:

Requirements: {requirements}

Context:
- Website Type: {websiteType}
- Target Audience: {targetAudience}
- Max Depth: {maxDepth}

Rules:
1. Create a logical hierarchy starting with homepage
2. Use SEO-friendly slugs (lowercase, hyphens, no special chars)
3. Each page needs: title, slug, contentType, description
4. Organize by user journey and information architecture
5. Include both pages and sections

Output as JSON matching this schema:
{
  "title": "Homepage",
  "slug": "home",
  "contentType": "LandingPage",
  "description": "Main landing page",
  "children": [...]
}
`;
```

#### Atomic Page Creation Flow
[Source: docs/epic8-brownfield-architecture.md#ai-generation]
```typescript
// Process AI-generated structure
const pages = await prisma.$transaction(async (tx) => {
  const created = [];
  
  for (const node of flattenTree(structure)) {
    const page = await pageOrchestrator.createPage({
      title: node.title,
      contentTypeId: node.suggestedContentType,
      content: await generateInitialContent(node),
      parentId: node.parentId,
      slug: node.slug,
      position: node.position
    }, websiteId);
    
    created.push(page);
  }
  
  return created;
});
```

#### Existing Prompt Patterns
[Source: lib/prompts/structured-prompts.ts]
The codebase already has structured prompt templates with:
- System prompts for AI role definition
- User prompt templates with variable injection
- Variable definitions with types and validation
- Follow-up suggestions for iterative refinement

#### Database Models
[Source: Story 8.1 implementation]
- ContentItem: Source of truth for slug, title, content
- SiteStructure: Hierarchy, paths, parent-child relationships
- Both created atomically via PageOrchestrator

#### API Patterns
[Source: app/api/pages/route.ts]
- Uses NextRequest/NextResponse
- Requires `x-website-id` header
- Returns appropriate HTTP status codes
- Handles specific error types (DuplicateSlugError, InvalidSlugError)

### Implementation Notes

#### OpenAI Integration
Since no existing OpenAI integration was found in the codebase, we'll need to:
1. Install OpenAI SDK: `npm install openai`
2. Add environment variable: `OPENAI_API_KEY`
3. Create OpenAI client singleton
4. Implement retry logic for API failures

#### Tree Flattening Algorithm
For breadth-first processing:
```typescript
function flattenTree(root: GeneratedNode): FlatNode[] {
  const result: FlatNode[] = [];
  const queue: Array<{node: GeneratedNode, parentId: string | null, depth: number}> = [
    {node: root, parentId: null, depth: 0}
  ];
  
  while (queue.length > 0) {
    const {node, parentId, depth} = queue.shift()!;
    const id = generateId();
    
    result.push({
      ...node,
      id,
      parentId,
      depth,
      position: result.filter(n => n.parentId === parentId).length
    });
    
    node.children?.forEach(child => {
      queue.push({node: child, parentId: id, depth: depth + 1});
    });
  }
  
  return result;
}
```

#### Content Type Fallback Strategy
When AI suggests a content type that doesn't exist:
1. First attempt: Map to closest existing content type by name similarity
2. Second attempt: Use category-based default ('Page' for pages, 'Component' for components)
3. Final fallback: Use generic 'Page' content type
4. Log unmapped types for admin review and future content type creation

#### Error Handling Strategy
- Wrap OpenAI calls in try-catch with specific error messages
- Validate AI output against expected schema
- Use custom error classes for different failure types
- Log all AI interactions for debugging
- Implement exponential backoff for retries

#### Performance Targets
- Small sites (< 10 pages): < 3 seconds total generation time
- Medium sites (10-50 pages): < 8 seconds total generation time  
- Large sites (50-100 pages): < 15 seconds total generation time
- OpenAI API response: < 5 seconds for initial structure generation
- Database transaction: < 2 seconds for 50 page insertions

### GitFlow Workflow
Branch Name: `feature/8-5-ai-site-generation`
Base Branch: main
PR Target: main

Git Commands:
1. Setup: `git checkout main && git pull origin main`
2. Create: `git checkout -b feature/8-5-ai-site-generation`
3. Commit: Use conventional commits (feat:, fix:, docs:, etc.)
4. Push: `git push -u origin feature/8-5-ai-site-generation`
5. PR: Create PR to main branch with title "Epic 8 Story 8.5: AI Site Generation Engine"

### Testing Standards
[Source: Project conventions]
- Test files location: `__tests__` folder in same directory as source
- Testing framework: Jest with TypeScript
- Coverage requirement: 80%+ for AI services
- Mock OpenAI responses for unit tests
- Use test database for integration tests
- Test various requirement inputs for robustness

#### Example Test Requirements
```javascript
// Example natural language inputs for testing:
const testRequirements = [
  "Create a simple blog with about, contact, and articles pages",
  "Build an e-commerce site with products, categories, and checkout",
  "Corporate website with services, team, portfolio, and case studies",
  "Documentation site with guides, API reference, and tutorials"
];

// Expected to handle edge cases:
- Empty requirements
- Very deep nesting (> 5 levels)
- Duplicate page names at different levels
- Special characters in titles
- Maximum size generation (100 pages)
```

### Security Considerations
- Sanitize user input before sending to AI
- Validate AI output for potential injection attacks
- Rate limit generation requests:
  - 10 generations per hour per website
  - 50 generations per day per organization
  - Queue excess requests with user notification
- Log all generation attempts for audit
- Never expose OpenAI API key to client

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-22 | 1.0 | Initial story creation for AI Site Generation Engine | Bob (Scrum Master) |
| 2025-08-22 | 1.1 | Applied PO feedback: Added content type fallback strategy, rate limiting specifics, performance targets, and test examples | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
[To be filled by dev agent]

### Debug Log References
[To be filled by dev agent]

### Completion Notes List
[To be filled by dev agent]

### File List
[To be filled by dev agent]

## QA Results
[To be filled by QA agent]