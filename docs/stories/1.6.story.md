# Story 1.6: Add Content Management and Editing

## Status
Ready for Review

## Story
**As a** content editor,
**I want** to create and edit content items,
**so that** I can populate my website with real data.

### Dependencies
- **Requires**: Story 1.3 (Content Type Builder) must be completed first to create content types
- **Note**: This story assumes content types exist from Story 1.3 implementation

## Acceptance Criteria
1. Content list view with all items for selected content type
2. Modal-based content creation and editing forms
3. Form fields dynamically generated based on content type
4. Save and cancel functionality with proper state management
5. Content preview in list view

## Integration Verification
- IV1: Modal system matches mockup's design and behavior
- IV2: Form generation works with all field types
- IV3: Content changes reflect immediately in preview

## Tasks / Subtasks

### Task 1: Create Content List View Component (AC: 1, 5) ✅
- [x] Create `components/content/content-list.tsx` component
- [x] Implement grid/list view with content items display
- [x] Add content type selector dropdown at top of list
- [x] Display content item cards with title, preview, and actions
- [x] Add "New Content" button with plus icon
- [x] Style with unified dark theme from Story 1.5b
- [x] Add empty state when no content exists
- [x] Handle scenario when no content types are available (show helpful message to create content types first)

### Task 2: Implement Content Modal System (AC: 2) ✅
- [x] Create `components/content/content-modal.tsx` base modal component
- [x] Use shadcn/ui Dialog component for modal foundation
- [x] Implement proper z-index management (z-50 for overlay, z-50 for modal)
- [x] Add backdrop blur effect matching glass morphism theme
- [x] Create modal header with title and close button
- [x] Add modal footer with Save and Cancel buttons
- [x] Ensure ESC key and backdrop click close modal

### Task 3: Build Dynamic Form Generation System (AC: 3) ✅
- [x] Create `components/content/form-generator.tsx` component
- [x] Implement field type mapping:
  - text → Input component
  - richText → Textarea with formatting toolbar
  - image → File upload with preview
  - date → Date picker component
  - number → Number input with validation
  - boolean → Checkbox/Switch component
  - reference → Select dropdown with related items
- [x] Use React Hook Form for form state management
- [x] Integrate Zod schemas from content type definitions
- [x] Add field validation display (required, min/max, patterns)

### Task 4: Implement Content CRUD Operations (AC: 4) ✅
- [x] Create `lib/stores/content-store.ts` using Zustand
- [x] Implement content state management:
  - `addContent(contentType: string, data: any)`
  - `updateContent(id: string, data: any)`
  - `deleteContent(id: string)`
  - `getContentByType(contentType: string)`
- [x] Add optimistic updates for better UX
- [x] Integrate with project persistence layer (localStorage/IndexedDB)
- [x] Handle save errors with user-friendly messages

### Task 5: Create Content Preview Cards (AC: 5) ✅
- [x] Create `components/content/content-card.tsx` component
- [x] Display content preview based on field types:
  - Show first text field as title
  - Show first image field as thumbnail
  - Show truncated rich text as description
- [x] Add action buttons (Edit, Delete, Duplicate)
- [x] Implement hover effects matching design system
- [x] Add status badges (Draft, Published - for future use)

### Task 6: Integrate with Navigation and Routing (IV1, IV2, IV3) ✅
- [x] Add content management route to navigation sidebar
- [x] Update `app/(dashboard)/content/page.tsx` with content list
- [x] Ensure modal opens/closes smoothly with animations
- [x] Connect content changes to preview system (if Story 1.4 complete)
- [x] Maintain navigation state when modals are open

### Task 7: Add Form Validation and Error Handling ✅
- [x] Implement comprehensive field validation:
  - Required field validation
  - Type-specific validation (email, URL, etc.)
  - Custom validation rules from content type
- [x] Display inline validation errors below fields
- [x] Show save confirmation toast on success
- [x] Handle and display API errors gracefully
- [x] Add unsaved changes warning when closing modal

### Task 8: Implement Keyboard Navigation and Accessibility ✅
- [x] Add keyboard navigation within forms (Tab, Shift+Tab)
- [x] Implement keyboard shortcuts (Ctrl+S to save)
- [x] Add proper ARIA labels to all form elements
- [x] Ensure modal focus trap works correctly
- [x] Add screen reader announcements for actions
- [x] Test with keyboard-only navigation

### Task 9: Write Tests ✅
- [x] Unit tests for form generator with all field types
- [x] Unit tests for content store CRUD operations
- [x] Integration tests for modal open/close flow
- [x] E2E tests for complete content creation workflow
- [x] Test form validation for all field types
- [x] Test error handling scenarios

## Dev Notes

### Previous Story Insights
**From Story 1.5b**: The unified design system has been successfully implemented with centralized design tokens in `/lib/design-system/`. All new components should use these tokens for consistency. The dark theme with glass morphism effects is now standard across all pages.

### Architecture Context

#### Component Architecture
[Source: architecture.md#Component Architecture]
- All new components should follow the established pattern with error boundaries
- Use feature flags for new functionality: `contentBuilder: boolean` flag controls this feature
- Components should be placed in `components/content/` directory

#### State Management
[Source: architecture.md#State Management Architecture]
- Use Zustand for complex UI state management (content CRUD operations)
- React Context remains for simpler state (current content type selection)
- Local component state with useState for form inputs

#### Data Models
[Source: architecture.md#Data Models and Schema Changes]

**ContentType Model Structure:**
```typescript
interface ContentType {
  id: string;
  name: string;
  pluralName: string;
  icon: string;
  fields: Field[];
  relationships: Relationship[];
}
```

**Field Model Structure:**
```typescript
interface Field {
  id: string;
  name: string;
  type: 'text' | 'richText' | 'image' | 'date' | 'number' | 'boolean' | 'reference';
  required: boolean;
  defaultValue: any;
  validation: ValidationRule[];
  order: number;
}
```

**ContentItem Model:**
```typescript
interface ContentItem {
  id: string;
  contentTypeId: string;
  data: Record<string, any>; // Dynamic based on content type fields
  createdAt: Date;
  updatedAt: Date;
}
```

#### File Structure
[Source: architecture.md#Source Tree Integration]
```
components/
├── content/                    # NEW - Content management
│   ├── content-list.tsx       # Main list view
│   ├── content-modal.tsx      # Modal container
│   ├── content-card.tsx       # Preview cards
│   ├── form-generator.tsx     # Dynamic forms
│   └── field-editors/         # Individual field components
│       ├── text-field.tsx
│       ├── image-field.tsx
│       └── ...
lib/
├── stores/
│   └── content-store.ts       # Zustand store for content
└── schemas/
    └── content.ts             # Zod schemas for validation
```

#### UI Components to Use
[Source: architecture.md#Tech Stack Alignment]
- **shadcn/ui components**: Dialog, Input, Textarea, Select, Checkbox, Switch, Button, Toast
- **React Hook Form**: For form state management with Zod validation
- **Framer Motion**: For modal animations and transitions

#### Persistence Strategy
[Source: architecture.md#Persistence Layer Architecture]
- Use the established StorageService with IndexedDB as primary, localStorage as fallback
- Content items should be stored under key: `project:${projectId}:content`
- Implement optimistic updates with rollback on failure

### Testing Requirements
[Source: architecture.md#Testing Strategy]

#### Test Structure
- **Unit Tests**: Place in `components/content/*.test.tsx` files
- **Integration Tests**: Place in `tests/features/content.spec.ts`
- **E2E Tests**: Place in `tests/integration/content-journey.spec.ts`

#### Testing Standards
- Use Jest + React Testing Library for component tests
- Use Playwright for E2E testing
- Mock Zustand stores for unit tests
- Test coverage target: 80% for new code
- All tests must pass before PR merge

#### Specific Test Requirements
- Test all field types in form generator
- Test validation for required fields
- Test modal keyboard navigation
- Test content persistence across page reloads
- Test error states and recovery

### Performance Considerations
[Source: architecture.md#Performance Budget]
- Modal open/close animations must maintain 60fps
- Form generation should complete within 100ms
- Content list should virtualize if >50 items
- Save operations should show optimistic updates immediately

### Security Considerations
[Source: architecture.md#Security Integration]
- All user-generated content must be sanitized using DOMPurify
- Validate all inputs on both client and server (future)
- Prevent XSS in rich text fields
- Implement proper escape handling for special characters

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-10 | 1.0 | Initial story draft created | Bob (Scrum Master) |
| 2025-01-10 | 1.1 | Applied PO feedback: Added Story 1.3 dependency clarification and empty content type handling | Bob (Scrum Master) |
| 2025-01-10 | 1.2 | Story approved by PO with 9.5/10 readiness score | Sarah (PO) |

## Dev Agent Record
*To be populated during implementation*

### Agent Model Used
*TBD*

### Debug Log References
*TBD*

### Completion Notes List
*TBD*

### File List
*TBD*

## QA Results

### Review Date: 2025-01-10
### Reviewed By: Quinn (Senior Developer & QA Architect)
### Overall Score: 92/100

#### Summary
Excellent implementation meeting all acceptance criteria with outstanding accessibility features. Production-ready with minor improvements recommended for scale and security.

#### Strengths
- Clean architecture with proper separation of concerns
- Comprehensive accessibility (ARIA labels, keyboard navigation, focus management)
- Well-structured components following single responsibility principle
- Good test coverage for critical paths
- Proper use of Zustand for state management
- Effective React Hook Form + Zod validation implementation

#### Priority Issues to Address

**HIGH Priority:**
1. **Missing Error Boundary** - Add wrapper for content components to handle runtime errors gracefully
2. **No Optimistic UI Rollback** - Implement state rollback mechanism when saves fail

**MEDIUM Priority:**
1. **Performance** - Add virtual scrolling for lists >100 items
2. **Security** - Sanitize image URLs and implement CSP headers for external sources
3. **Memory Leak Risk** - Keyboard event listener cleanup in FormGenerator

**LOW Priority:**
1. **Code Organization** - Extract field components to separate files for maintainability
2. **Extensibility** - Consider field registry pattern for easier field type additions

#### Testing Gaps
- Concurrent editing scenarios not covered
- Network failure handling needs tests
- XSS attack vectors in rich text fields need security tests
- Browser refresh persistence tests missing

#### Security Considerations
- Image field accepts any URL without validation (needs sanitization)
- Rich text fields need additional XSS protection
- Consider implementing image proxy for external sources

#### Performance Notes
- Current implementation may struggle with >500 content items
- Consider implementing pagination or virtual scrolling
- Form generation performs well within 100ms requirement

#### Recommendation
**APPROVED for merge** after addressing HIGH priority issues. The implementation demonstrates excellent understanding of React patterns, state management, and accessibility best practices. Minor improvements will enhance production readiness.