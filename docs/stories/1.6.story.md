# Story 1.6: Add Content Management and Editing

## Status
Approved

## Story
**As a** content editor,
**I want** to create and edit content items,
**so that** I can populate my website with real data.

### Dependencies
- **Requires**: Story 1.3 (Content Type Builder) must be completed first to create content types
- **Note**: This story assumes content types exist from Story 1.3 implementation

## Acceptance Criteria
1. Content list view with all items for selected content type
2. Modal-based content creation and editing forms
3. Form fields dynamically generated based on content type
4. Save and cancel functionality with proper state management
5. Content preview in list view

## Integration Verification
- IV1: Modal system matches mockup's design and behavior
- IV2: Form generation works with all field types
- IV3: Content changes reflect immediately in preview

## Tasks / Subtasks

### Task 1: Create Content List View Component (AC: 1, 5)
- [ ] Create `components/content/content-list.tsx` component
- [ ] Implement grid/list view with content items display
- [ ] Add content type selector dropdown at top of list
- [ ] Display content item cards with title, preview, and actions
- [ ] Add "New Content" button with plus icon
- [ ] Style with unified dark theme from Story 1.5b
- [ ] Add empty state when no content exists
- [ ] Handle scenario when no content types are available (show helpful message to create content types first)

### Task 2: Implement Content Modal System (AC: 2)
- [ ] Create `components/content/content-modal.tsx` base modal component
- [ ] Use shadcn/ui Dialog component for modal foundation
- [ ] Implement proper z-index management (z-50 for overlay, z-50 for modal)
- [ ] Add backdrop blur effect matching glass morphism theme
- [ ] Create modal header with title and close button
- [ ] Add modal footer with Save and Cancel buttons
- [ ] Ensure ESC key and backdrop click close modal

### Task 3: Build Dynamic Form Generation System (AC: 3)
- [ ] Create `components/content/form-generator.tsx` component
- [ ] Implement field type mapping:
  - text → Input component
  - richText → Textarea with formatting toolbar
  - image → File upload with preview
  - date → Date picker component
  - number → Number input with validation
  - boolean → Checkbox/Switch component
  - reference → Select dropdown with related items
- [ ] Use React Hook Form for form state management
- [ ] Integrate Zod schemas from content type definitions
- [ ] Add field validation display (required, min/max, patterns)

### Task 4: Implement Content CRUD Operations (AC: 4)
- [ ] Create `lib/stores/content-store.ts` using Zustand
- [ ] Implement content state management:
  - `addContent(contentType: string, data: any)`
  - `updateContent(id: string, data: any)`
  - `deleteContent(id: string)`
  - `getContentByType(contentType: string)`
- [ ] Add optimistic updates for better UX
- [ ] Integrate with project persistence layer (localStorage/IndexedDB)
- [ ] Handle save errors with user-friendly messages

### Task 5: Create Content Preview Cards (AC: 5)
- [ ] Create `components/content/content-card.tsx` component
- [ ] Display content preview based on field types:
  - Show first text field as title
  - Show first image field as thumbnail
  - Show truncated rich text as description
- [ ] Add action buttons (Edit, Delete, Duplicate)
- [ ] Implement hover effects matching design system
- [ ] Add status badges (Draft, Published - for future use)

### Task 6: Integrate with Navigation and Routing (IV1, IV2, IV3)
- [ ] Add content management route to navigation sidebar
- [ ] Update `app/(dashboard)/content/page.tsx` with content list
- [ ] Ensure modal opens/closes smoothly with animations
- [ ] Connect content changes to preview system (if Story 1.4 complete)
- [ ] Maintain navigation state when modals are open

### Task 7: Add Form Validation and Error Handling
- [ ] Implement comprehensive field validation:
  - Required field validation
  - Type-specific validation (email, URL, etc.)
  - Custom validation rules from content type
- [ ] Display inline validation errors below fields
- [ ] Show save confirmation toast on success
- [ ] Handle and display API errors gracefully
- [ ] Add unsaved changes warning when closing modal

### Task 8: Implement Keyboard Navigation and Accessibility
- [ ] Add keyboard navigation within forms (Tab, Shift+Tab)
- [ ] Implement keyboard shortcuts (Ctrl+S to save)
- [ ] Add proper ARIA labels to all form elements
- [ ] Ensure modal focus trap works correctly
- [ ] Add screen reader announcements for actions
- [ ] Test with keyboard-only navigation

### Task 9: Write Tests
- [ ] Unit tests for form generator with all field types
- [ ] Unit tests for content store CRUD operations
- [ ] Integration tests for modal open/close flow
- [ ] E2E tests for complete content creation workflow
- [ ] Test form validation for all field types
- [ ] Test error handling scenarios

## Dev Notes

### Previous Story Insights
**From Story 1.5b**: The unified design system has been successfully implemented with centralized design tokens in `/lib/design-system/`. All new components should use these tokens for consistency. The dark theme with glass morphism effects is now standard across all pages.

### Architecture Context

#### Component Architecture
[Source: architecture.md#Component Architecture]
- All new components should follow the established pattern with error boundaries
- Use feature flags for new functionality: `contentBuilder: boolean` flag controls this feature
- Components should be placed in `components/content/` directory

#### State Management
[Source: architecture.md#State Management Architecture]
- Use Zustand for complex UI state management (content CRUD operations)
- React Context remains for simpler state (current content type selection)
- Local component state with useState for form inputs

#### Data Models
[Source: architecture.md#Data Models and Schema Changes]

**ContentType Model Structure:**
```typescript
interface ContentType {
  id: string;
  name: string;
  pluralName: string;
  icon: string;
  fields: Field[];
  relationships: Relationship[];
}
```

**Field Model Structure:**
```typescript
interface Field {
  id: string;
  name: string;
  type: 'text' | 'richText' | 'image' | 'date' | 'number' | 'boolean' | 'reference';
  required: boolean;
  defaultValue: any;
  validation: ValidationRule[];
  order: number;
}
```

**ContentItem Model:**
```typescript
interface ContentItem {
  id: string;
  contentTypeId: string;
  data: Record<string, any>; // Dynamic based on content type fields
  createdAt: Date;
  updatedAt: Date;
}
```

#### File Structure
[Source: architecture.md#Source Tree Integration]
```
components/
├── content/                    # NEW - Content management
│   ├── content-list.tsx       # Main list view
│   ├── content-modal.tsx      # Modal container
│   ├── content-card.tsx       # Preview cards
│   ├── form-generator.tsx     # Dynamic forms
│   └── field-editors/         # Individual field components
│       ├── text-field.tsx
│       ├── image-field.tsx
│       └── ...
lib/
├── stores/
│   └── content-store.ts       # Zustand store for content
└── schemas/
    └── content.ts             # Zod schemas for validation
```

#### UI Components to Use
[Source: architecture.md#Tech Stack Alignment]
- **shadcn/ui components**: Dialog, Input, Textarea, Select, Checkbox, Switch, Button, Toast
- **React Hook Form**: For form state management with Zod validation
- **Framer Motion**: For modal animations and transitions

#### Persistence Strategy
[Source: architecture.md#Persistence Layer Architecture]
- Use the established StorageService with IndexedDB as primary, localStorage as fallback
- Content items should be stored under key: `project:${projectId}:content`
- Implement optimistic updates with rollback on failure

### Testing Requirements
[Source: architecture.md#Testing Strategy]

#### Test Structure
- **Unit Tests**: Place in `components/content/*.test.tsx` files
- **Integration Tests**: Place in `tests/features/content.spec.ts`
- **E2E Tests**: Place in `tests/integration/content-journey.spec.ts`

#### Testing Standards
- Use Jest + React Testing Library for component tests
- Use Playwright for E2E testing
- Mock Zustand stores for unit tests
- Test coverage target: 80% for new code
- All tests must pass before PR merge

#### Specific Test Requirements
- Test all field types in form generator
- Test validation for required fields
- Test modal keyboard navigation
- Test content persistence across page reloads
- Test error states and recovery

### Performance Considerations
[Source: architecture.md#Performance Budget]
- Modal open/close animations must maintain 60fps
- Form generation should complete within 100ms
- Content list should virtualize if >50 items
- Save operations should show optimistic updates immediately

### Security Considerations
[Source: architecture.md#Security Integration]
- All user-generated content must be sanitized using DOMPurify
- Validate all inputs on both client and server (future)
- Prevent XSS in rich text fields
- Implement proper escape handling for special characters

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-10 | 1.0 | Initial story draft created | Bob (Scrum Master) |
| 2025-01-10 | 1.1 | Applied PO feedback: Added Story 1.3 dependency clarification and empty content type handling | Bob (Scrum Master) |
| 2025-01-10 | 1.2 | Story approved by PO with 9.5/10 readiness score | Sarah (PO) |

## Dev Agent Record
*To be populated during implementation*

### Agent Model Used
*TBD*

### Debug Log References
*TBD*

### Completion Notes List
*TBD*

### File List
*TBD*

## QA Results
*To be completed by QA Agent*