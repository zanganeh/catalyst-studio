# Story 6.3: Build Version History Tracking

## Status
Ready for Review

## Story
**As a** content architect,  
**I want** to see the complete version history of content types,  
**so that** I can track changes over time like Git

## Acceptance Criteria
1. Merkle tree structure for version history
2. Each version links to parent version(s)
3. Store full content type snapshot per version
4. Query history by date, author, or change type
5. Support for viewing version differences
6. Version tree visualization capability
7. All version operations are properly unit tested

## Tasks / Subtasks
- [x] Git Setup (REQUIRED FIRST TASK)
  - [x] Checkout and update main: `git checkout main && git pull origin main`
  - [x] Create feature branch: `git checkout -b feature/6-3-version-history`
- [x] Extend Database Schema for Version Tree Structure (AC: 1, 2)
  - [x] Update Prisma schema to add parent_versions junction table for multiple parents
  - [x] Add indexes for efficient tree traversal
  - [x] Run migration to update database structure
- [x] Implement VersionTree Class (AC: 1, 2, 6)
  - [x] Create `/lib/sync/versioning/VersionTree.ts`
  - [x] Implement `buildTree(typeKey)` method to construct Merkle tree
  - [x] Implement `findCommonAncestor(hash1, hash2)` for three-way merge support
  - [x] Add `getLineage(hash)` to trace version ancestry
  - [x] Implement `visualizeTree()` for tree structure output
- [x] Enhance VersionHistoryManager with Query Methods (AC: 3, 4)
  - [x] Update `/lib/sync/versioning/VersionHistoryManager.ts`
  - [x] Add `getVersionHistory(typeKey, options)` with date/author/type filters
  - [x] Implement `getVersionByHash(hash)` to retrieve specific versions
  - [x] Add `getVersionsByDateRange(typeKey, startDate, endDate)` method
  - [x] Implement `getVersionsByAuthor(author)` method
  - [x] Add `getVersionsByChangeSource(source)` method
- [x] Implement Version Difference Calculation (AC: 5)
  - [x] Create `/lib/sync/versioning/VersionDiff.ts`
  - [x] Implement `calculateDiff(version1, version2)` method
  - [x] Add support for field-level differences
  - [x] Create human-readable diff format output
  - [x] Support three-way diff for merge scenarios
- [x] Add Version Tree API Endpoints (AC: 4, 6)
  - [x] Create `/app/api/v1/versions/[typeKey]/route.ts` (Next.js 14 App Router format)
  - [x] Implement GET endpoint for version history with query parameters
  - [x] Create `/app/api/v1/versions/[typeKey]/tree/route.ts` for tree visualization
  - [x] Create `/app/api/v1/versions/[hash]/diff/route.ts` for version comparison
- [x] Update Content Type Service Integration (AC: 3)
  - [x] Modify `/lib/services/content-type-service.ts`
  - [x] Add method to retrieve version history for a content type
  - [x] Ensure all modifications update version tree correctly
  - [x] Add helper methods for version navigation
- [x] Add Unit Tests (AC: 7)
  - [x] Create `/lib/sync/versioning/__tests__/VersionTree.test.ts`
  - [x] Test Merkle tree construction and traversal
  - [x] Test common ancestor finding algorithm
  - [x] Create `/lib/sync/versioning/__tests__/VersionDiff.test.ts`
  - [x] Test diff calculation accuracy
  - [x] Test version history query methods
  - [x] Add integration tests for complete version workflow
- [x] Integration Testing
  - [x] Test version tree building with multiple branches
  - [x] Verify parent-child relationships are maintained
  - [x] Test query filters work correctly
  - [x] Validate diff generation between versions
  - [x] Test API endpoints return correct data
- [x] Submit PR (REQUIRED FINAL TASK)
  - [x] Push branch: `git push -u origin feature/6-3-version-history`
  - [x] Create PR from feature branch → main branch
  - [x] PR Title: "Epic 6 Story 3: Build Version History Tracking"
  - [x] Link PR to story in description

## Dev Notes

### GitFlow Workflow
Branch Name: feature/6-3-version-history  
Base Branch: main  
PR Target: main  

Git Commands:
1. Setup: `git checkout main && git pull origin main`
2. Create: `git checkout -b feature/6-3-version-history`
3. Commit: Use conventional commits (feat:, fix:, docs:, etc.)
4. Push: `git push -u origin feature/6-3-version-history`
5. PR: Create PR to main branch with title "Epic 6 Story 3: Build Version History Tracking"

### Source Tree Context
[Source: Story 6.2 Implementation & Epic 6 Architecture]

**Existing Versioning Structure** (from Story 6.2):
```
/lib/sync/versioning/
├── ContentTypeHasher.ts        # SHA-256 hash calculation (existing)
├── VersionHistoryManager.ts    # Basic version tracking (to be enhanced)
└── __tests__/                  # Existing test files
```

**New Additions for Story 6.3**:
```
/lib/sync/versioning/
├── VersionTree.ts              # NEW - Merkle tree implementation
├── VersionDiff.ts              # NEW - Version comparison logic
└── __tests__/
    ├── VersionTree.test.ts     # NEW - Tree structure tests
    └── VersionDiff.test.ts     # NEW - Diff calculation tests

/app/api/v1/versions/           # NEW - Version API endpoints
├── [typeKey]/
│   └── route.ts
└── [hash]/
    └── diff/
        └── route.ts
```

### Database Schema Enhancement
[Source: Epic 6 PRD - Section 6.3 & Story 6.2 Implementation]

**Existing Table** (from Story 6.2):
```sql
-- content_type_versions table already exists with:
-- id, type_key, version_hash, parent_hash, content_snapshot, 
-- change_source, author, created_at, message
```

**New Table for Multi-Parent Support**:
```sql
-- Support for merge commits with multiple parents
CREATE TABLE version_parents (
  version_hash TEXT NOT NULL,
  parent_hash TEXT NOT NULL,
  parent_order INTEGER DEFAULT 0,
  PRIMARY KEY (version_hash, parent_hash),
  FOREIGN KEY (version_hash) REFERENCES content_type_versions(version_hash),
  FOREIGN KEY (parent_hash) REFERENCES content_type_versions(version_hash)
);

CREATE INDEX idx_version_parents ON version_parents(version_hash);
CREATE INDEX idx_parent_versions ON version_parents(parent_hash);
```

**Prisma Model Definition**:
```prisma
// Add to schema.prisma
model VersionParent {
  versionHash  String @map("version_hash")
  parentHash   String @map("parent_hash")
  parentOrder  Int    @default(0) @map("parent_order")
  
  // Relations
  version ContentTypeVersion @relation("VersionToParents", fields: [versionHash], references: [versionHash])
  parent  ContentTypeVersion @relation("ParentToVersions", fields: [parentHash], references: [versionHash])
  
  @@id([versionHash, parentHash])
  @@index([versionHash])
  @@index([parentHash])
  @@map("version_parents")
}
```

### Technical Implementation Details
[Source: Epic 6 PRD - Section 7.1 Git-Like Versioning & Epic 6 Architecture]

**VersionTree Class Structure**:
```typescript
// /lib/sync/versioning/VersionTree.ts
export class VersionTree {
  constructor(private prisma: PrismaClient) {}
  
  async buildTree(typeKey: string): Promise<TreeNode> {
    // Fetch all versions for the content type
    // Build Merkle tree structure with parent-child relationships
    // Return root node with full tree
  }
  
  async findCommonAncestor(hash1: string, hash2: string): Promise<string | null> {
    // Traverse both lineages to find common ancestor
    // Used for three-way merge scenarios
  }
  
  async getLineage(hash: string): Promise<string[]> {
    // Return array of hashes from current to root
    // Follow first parent for linear history
  }
  
  visualizeTree(tree: TreeNode): string {
    // Generate ASCII or structured representation
    // Similar to git log --graph output
  }
}

interface TreeNode {
  hash: string;
  typeKey: string;
  author: string;
  createdAt: Date;
  message?: string;
  parents: TreeNode[];
  children: TreeNode[];
}
```

**VersionDiff Implementation**:
```typescript
// /lib/sync/versioning/VersionDiff.ts
export class VersionDiff {
  calculateDiff(version1: any, version2: any): DiffResult {
    // Deep comparison of content type structures
    // Identify added, modified, and removed fields
    // Return structured diff result
  }
  
  formatDiff(diff: DiffResult): string {
    // Human-readable diff format
    // Similar to git diff output
  }
  
  threeWayDiff(base: any, local: any, remote: any): ThreeWayDiff {
    // For merge conflict resolution
    // Identify conflicting vs. non-conflicting changes
  }
}

interface DiffResult {
  added: Field[];
  modified: Field[];
  removed: Field[];
  unchanged: Field[];
}
```

**Version Query API Structure (Next.js 14 App Router)**:
```typescript
// /app/api/v1/versions/[typeKey]/route.ts
// Note: Next.js 14 App Router convention - route.ts handles HTTP methods
export async function GET(
  request: Request,
  { params }: { params: { typeKey: string } }
) {
  const url = new URL(request.url);
  const author = url.searchParams.get('author');
  const startDate = url.searchParams.get('startDate');
  const endDate = url.searchParams.get('endDate');
  const source = url.searchParams.get('source');
  
  const versionManager = new VersionHistoryManager(prisma, hasher);
  const history = await versionManager.getVersionHistory(params.typeKey, {
    author,
    dateRange: startDate && endDate ? { start: startDate, end: endDate } : undefined,
    source: source as ChangeSource
  });
  
  return NextResponse.json(history);
}
```

### Integration Points
[Source: Story 6.2 Implementation & Epic 6 Architecture - Component Integration]

**ContentTypeHasher Integration**:
- Already implemented in Story 6.2
- Provides SHA-256 hashes for version identification
- No modifications needed

**VersionHistoryManager Enhancement**:
- Extend existing class from Story 6.2
- Add query methods for filtering history
- Maintain backward compatibility with existing `onDataChange` method

**Content Type Service Integration**:
- Hook into existing service at `/lib/services/content-type-service.ts`
- Add `getVersionHistory(typeKey)` method
- Ensure version tracking continues to work with UI and AI sources

### Important Notes from Previous Story (6.2)
[Source: Story 6.2 Dev Agent Record]

1. **Hash System Working**: SHA-256 hashing successfully implemented and tested
2. **Version Tracking Active**: Basic version creation on all content type changes
3. **Database Schema Established**: content_type_versions table in place
4. **Source Attribution Working**: UI, AI, and SYNC sources properly tracked
5. **Testing Pattern Established**: Jest tests in `__tests__` folders adjacent to source
6. **Error Handling Pattern**: Use comprehensive try-catch with partial failure support:
   ```typescript
   try {
     // Version operations
   } catch (error) {
     console.error(`Version operation failed for ${typeKey}:`, error);
     // Log error but don't stop the process
     await this.logError(error, 'VERSION_OPERATION_FAILED', typeKey);
   }
   ```

### MVP Considerations
[Source: Epic 6 PRD - MVP Context]

**Focus Areas**:
- Basic version tree that can show linear history
- Simple diff between two versions
- Query by basic filters (date, author)
- API endpoints for version retrieval

**Not Required for MVP**:
- Complex merge scenarios (can be linear for now)
- Advanced visualization (ASCII tree is sufficient)
- Performance optimization for large histories
- Real-time updates of version tree

### Testing Standards
[Source: Story 6.2 patterns & Epic 6 Architecture]

**Test Framework**: Jest (already configured)
**Test Location**: `/lib/sync/versioning/__tests__/`
**Test Files to Create**:
- `VersionTree.test.ts` - Tree building and traversal
- `VersionDiff.test.ts` - Diff calculation

**Example Test Cases**:
```typescript
// VersionTree.test.ts
describe('VersionTree', () => {
  it('should build tree from linear history', async () => {
    // Create linear version chain
    // Build tree
    // Verify structure
  });
  
  it('should handle branching history', async () => {
    // Create versions with same parent (branch)
    // Build tree
    // Verify both branches exist
  });
  
  it('should find common ancestor', async () => {
    // Create divergent branches
    // Find common ancestor
    // Verify correct ancestor found
  });
});

// VersionDiff.test.ts
describe('VersionDiff', () => {
  it('should identify field additions', () => {
    const v1 = { fields: [{ name: 'title' }] };
    const v2 = { fields: [{ name: 'title' }, { name: 'body' }] };
    const diff = calculator.calculateDiff(v1, v2);
    expect(diff.added).toHaveLength(1);
  });
  
  it('should detect field modifications', () => {
    // Test field type changes, validation changes, etc.
  });
});
```

### Dependencies
[Source: Epic 6 Architecture]
- **crypto**: Built into Node.js (already used for hashing)
- **Prisma**: Already installed and configured
- No new npm packages required for this story

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-17 | 1.0 | Initial story creation based on Epic 6 PRD and Story 6.2 context | Scrum Master (Bob) |
| 2025-01-17 | 1.1 | Added Prisma model definition, clarified Next.js 14 App Router conventions, and added error handling patterns per PO validation feedback | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.1 (claude-opus-4-1-20250805)

### Debug Log References
- Initial Git setup and branch creation
- Database schema extension with version_parents table
- VersionTree class implementation with Merkle tree structure
- VersionHistoryManager enhancement with query methods
- VersionDiff implementation for version comparison
- API endpoint creation for version operations
- Service integration updates
- Unit test implementation and verification

### Completion Notes List
- Successfully implemented Merkle tree structure for version history
- Added multi-parent support for merge scenarios
- Implemented comprehensive query methods (by date, author, source)
- Created field-level diff calculation with three-way merge support
- All unit tests passing (19 tests in VersionTree and VersionDiff)
- Fixed TypeScript linting issues for type safety
- Updated existing tests to work with new method signatures
- PR #28 created and submitted for review

### File List
**New Files:**
- `/lib/sync/versioning/VersionTree.ts`
- `/lib/sync/versioning/VersionDiff.ts`
- `/lib/sync/versioning/__tests__/VersionTree.test.ts`
- `/lib/sync/versioning/__tests__/VersionDiff.test.ts`
- `/app/api/v1/versions/[typeKey]/route.ts`
- `/app/api/v1/versions/[typeKey]/tree/route.ts`
- `/app/api/v1/versions/[hash]/diff/route.ts`
- `/prisma/migrations/20250817095900_add_version_parents/migration.sql`

**Modified Files:**
- `/prisma/schema.prisma`
- `/lib/sync/versioning/VersionHistoryManager.ts`
- `/lib/services/content-type-service.ts`
- `/lib/sync/versioning/__tests__/VersionHistoryManager.test.ts`

### Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-17 | 1.0 | Initial story creation based on Epic 6 PRD and Story 6.2 context | Scrum Master (Bob) |
| 2025-01-17 | 1.1 | Added Prisma model definition, clarified Next.js 14 App Router conventions, and added error handling patterns per PO validation feedback | Scrum Master (Bob) |
| 2025-08-17 | 2.0 | Story implementation completed with all ACs met | James (Dev Agent) |

## QA Results
*To be completed after implementation*