# Story 5.2: Website Management Tools Implementation

## Status
Draft

## Story
**As a** content manager,  
**I want** AI to understand my website context and business requirements,  
**so that** it can apply appropriate rules automatically.

## Acceptance Criteria
1. `get-website-context` tool retrieves current website metadata and settings
2. `update-business-requirements` tool modifies website rules and metadata
3. `validate-content` tool checks content against business requirements
4. Business rules engine applies category-specific validation (blog, e-commerce, portfolio)
5. All tools complete execution in <2 seconds

## Tasks / Subtasks
- [ ] Git Setup (REQUIRED FIRST TASK)
  - [ ] Checkout and update develop: `git checkout develop && git pull origin develop`
  - [ ] Create feature branch: `git checkout -b feature/5-2-website-management-tools`

- [ ] Implement Business Rule Engine (AC: 4)
  - [ ] Create `/lib/ai-tools/business-rule-engine.ts`
  - [ ] Implement `validateForCategory(data, category)` function
  - [ ] Implement `getRequiredFields(category, contentType)` function
  - [ ] Implement `suggestFields(category, purpose)` function
  - [ ] Define category-specific validation rules for blog, e-commerce, portfolio
  - [ ] Create Zod schemas for each category type

- [ ] Implement get-website-context Tool (AC: 1)
  - [ ] Create `/lib/ai-tools/website/get-website-context.ts`
  - [ ] Define tool with Vercel AI SDK tool() function
  - [ ] Implement parameters schema with Zod (websiteId required)
  - [ ] Implement execute function to retrieve website metadata
  - [ ] Use existing WebsiteService for database operations
  - [ ] Return website name, category, settings, metadata, and business requirements

- [ ] Implement update-business-requirements Tool (AC: 2)
  - [ ] Create `/lib/ai-tools/website/update-business-requirements.ts`
  - [ ] Define tool with description and parameters schema
  - [ ] Implement execute function with Prisma transaction wrapper
  - [ ] Update website metadata with new business rules
  - [ ] Validate requirements before saving
  - [ ] Return success/failure with updated requirements

- [ ] Implement validate-content Tool (AC: 3)
  - [ ] Create `/lib/ai-tools/website/validate-content.ts`
  - [ ] Define tool with content validation parameters
  - [ ] Implement validation against business requirements
  - [ ] Use Business Rule Engine for category-specific checks
  - [ ] Return validation results with specific error messages
  - [ ] Include suggestions for fixing validation issues

- [ ] Update Tool Index and Exports
  - [ ] Update `/lib/ai-tools/index.ts` to export new website tools
  - [ ] Create `/lib/ai-tools/website/index.ts` for tool organization
  - [ ] Ensure tools are properly typed and exported

- [ ] Integrate Tools with Chat Route
  - [ ] Update `/app/api/chat/route.ts` to include website tools
  - [ ] Add tools to the allTools array passed to AI
  - [ ] Test tool detection and execution flow

- [ ] Write Unit Tests
  - [ ] Create `__tests__/ai-tools/business-rule-engine.test.ts`
  - [ ] Create `__tests__/ai-tools/website/get-website-context.test.ts`
  - [ ] Create `__tests__/ai-tools/website/update-business-requirements.test.ts`
  - [ ] Create `__tests__/ai-tools/website/validate-content.test.ts`
  - [ ] Test category-specific validation rules
  - [ ] Test performance (<2 seconds execution)

- [ ] Integration Verification Tests
  - [ ] Verify tools use existing WebsiteService without modifications (IV1)
  - [ ] Verify database transactions properly rollback on failure (IV2)
  - [ ] Verify existing website CRUD operations remain unaffected (IV3)
  - [ ] Test tool chaining scenarios

- [ ] Submit PR (REQUIRED FINAL TASK)
  - [ ] Push branch: `git push -u origin feature/5-2-website-management-tools`
  - [ ] Create PR from feature branch → develop branch
  - [ ] PR Title: "Epic 5 Story 2: Website Management Tools Implementation"
  - [ ] Link PR to story in description

## Dev Notes

### GitFlow Workflow
Branch Name: feature/5-2-website-management-tools  
Base Branch: develop (AFTER Story 5.1 merged)  
PR Target: develop (NOT main)  

Git Commands:
1. Setup: `git checkout develop && git pull origin develop`
2. Create: `git checkout -b feature/5-2-website-management-tools`
3. Commit: Use conventional commits (feat:, fix:, docs:, etc.)
4. Push: `git push -u origin feature/5-2-website-management-tools`
5. PR: Create PR to develop branch with title "Epic 5 Story 2: Website Management Tools Implementation"

### Technical Context

**Dependencies from Story 5.1:**
- Tool infrastructure established in `/lib/ai-tools/`
- Tool executor with Zod validation available
- Context provider for loading website data
- OpenRouter configuration completed
- Base types defined in `/lib/ai-tools/types.ts`

**Tool Implementation Pattern:**
Following the pattern established in Story 5.1 and POC:
```typescript
import { tool } from 'ai';
import { z } from 'zod';

export const toolName = tool({
  description: 'Tool description for AI',
  parameters: z.object({
    // Zod schema for parameters
  }),
  execute: async (params) => {
    // Direct database access via Prisma
    // Use existing services
    // Return structured result
  }
});
```

**Category-Specific Business Rules:**
Based on requirements document [Source: docs/epic-5-requirements-document.md#159-165]:

| Website Type | Required Fields | Validation Rules |
|-------------|-----------------|------------------|
| Blog | Title, SEO description, Author, Date | Title ≤ 60 chars, Description 120-160 chars |
| E-commerce | SKU, Price, Inventory | Unique SKUs, Price > 0 |
| Portfolio | Project name, Client, Technologies | Valid completion date |

**Existing Services to Leverage:**
- `lib/services/website-service.ts` - WebsiteService for website operations
- `lib/db/prisma.ts` - Prisma client for database access
- Context provider from Story 5.1 for loading website data

**Project Structure After Story 5.2:**
```
lib/
├── ai-tools/
│   ├── index.ts                     # Updated with website tools
│   ├── tool-executor.ts             # From Story 5.1
│   ├── context-provider.ts          # From Story 5.1
│   ├── business-rule-engine.ts      # NEW - Category validation
│   ├── website/                     # Website management tools
│   │   ├── index.ts                 # NEW - Export website tools
│   │   ├── get-website-context.ts   # NEW
│   │   ├── update-business-requirements.ts # NEW
│   │   └── validate-content.ts      # NEW
│   └── helpers/                     # From Story 5.1
```

**Performance Requirements:**
- All tools must complete execution in <2 seconds [Source: docs/epic-5-brownfield-prd.md#248]
- Use existing WebsiteService methods without modifications
- Implement proper error handling and rollback

**Testing Requirements:**
- Unit tests for each tool and business rule engine
- Mock WebsiteService and Prisma operations
- Test category-specific validation for all three types
- Performance tests to ensure <2 second execution
- Integration tests for tool chaining

### Testing Standards
- Test files location: `__tests__/` directories at the same level as source files
- Testing framework: Jest with existing configuration
- Mock Prisma client and WebsiteService for database operations
- Test all three category types (blog, e-commerce, portfolio)
- Verify proper transaction rollback on failures

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-14 | 1.0 | Initial story creation | Scrum Master Bob |

## Dev Agent Record
*This section to be populated by the development agent during implementation*

### Agent Model Used
*To be filled*

### Debug Log References
*To be filled*

### Completion Notes List
*To be filled*

### File List
*To be filled*

## QA Results
*This section to be populated by QA agent after story completion*