# Story 9.9: Final Polish and Production Deployment

## Parent Epic
[Epic 9: Visual Sitemap Builder](../epic9-brownfield-prd.md) - Transform existing React Flow demo into production-ready visual site structure management system for premium users.

## Status
Backlog

## Story
**As a** product team,
**I want** to complete final testing, security verification, and production deployment of the sitemap builder,
**so that** premium users can access the fully functional visual sitemap builder with confidence in its stability and security.

## Acceptance Criteria
1. All previous stories (9.1-9.8) are completed and integrated successfully
2. Full integration testing suite passes with >70% coverage for critical paths
3. Security audit completed with premium feature gating verified
4. Performance benchmarks met (load <3s for 100 nodes, 60 FPS drag operations)
5. Production build optimized with tree-shaking and code splitting
6. Premium authentication and authorization verified in production environment
7. Error tracking with Sentry configured and tested
8. Monitoring dashboards configured for key metrics
9. Documentation completed for user guide and troubleshooting
10. Rollback plan tested and documented
11. Feature flag configured for controlled rollout
12. Deployment to premium repository verified with no leakage to public repo

## Tasks / Subtasks
- [ ] Git Setup (REQUIRED FIRST TASK)
  - [ ] Checkout and update main: `git checkout main && git pull premium main`
  - [ ] Create feature branch from main: `git checkout -b feature/9-9-deployment-polish`
- [ ] Complete Integration Testing (AC: 1, 2)
  - [ ] Verify all components from stories 9.1-9.8 work together
  - [ ] Run full test suite: `npm test`
  - [ ] Ensure >70% coverage for critical sitemap builder paths
  - [ ] Fix any failing tests or integration issues
  - [ ] Document any known limitations or edge cases
- [ ] Security Audit and Premium Gating (AC: 3, 6, 12)
  - [ ] Verify all sitemap code is under `/lib/premium/` and `/app/premium/`
  - [ ] Test premium subscription check at `/app/premium/demo/sitemap-builder/`
  - [ ] Verify API routes under `/app/api/premium/` are protected
  - [ ] Confirm GitHub Action excludes premium folders from public sync
  - [ ] Test with non-premium user to ensure proper access denial
  - [ ] Review for any security vulnerabilities (XSS, CSRF protection)
- [ ] Performance Optimization and Testing (AC: 4, 5)
  - [ ] Run production build: `npm run build`
  - [ ] Verify tree-shaking removes unused code
  - [ ] Test load time with 100-node sitemap (<3s requirement)
  - [ ] Profile drag operations to ensure 60 FPS
  - [ ] Optimize bundle size if needed
  - [ ] Test with Chrome, Firefox, Safari, Edge browsers
- [ ] Configure Sentry Error Tracking (AC: 7)
  - [ ] Install Sentry SDK: `npm install @sentry/nextjs`
  - [ ] Configure Sentry in `sentry.client.config.js` and `sentry.server.config.js`
  - [ ] Set up environment variables (NEXT_PUBLIC_SENTRY_DSN, SENTRY_AUTH_TOKEN)
  - [ ] Configure error boundary integration with React components
  - [ ] Test error reporting in development environment
  - [ ] Verify production configuration and source maps upload
  - [ ] Document Sentry setup and alert configuration
- [ ] Setup Monitoring and Dashboards (AC: 8)
  - [ ] Enable Vercel Analytics for the project
  - [ ] Implement custom event tracking for sitemap metrics
  - [ ] Configure alerts for critical thresholds (load >5s, save failures >2%, errors >5%)
  - [ ] Create custom dashboard views in Vercel Analytics
  - [ ] Integrate Sentry with analytics for error correlation
  - [ ] Test monitoring in staging environment
  - [ ] Document dashboard access and metric definitions
- [ ] Complete Documentation (AC: 9)
  - [ ] Write user guide for sitemap builder
  - [ ] Create troubleshooting guide for common issues
  - [ ] Document keyboard shortcuts and UI features
  - [ ] Add screenshots/GIFs for key workflows
  - [ ] Update main README with sitemap builder section
- [ ] Test Rollback Procedures (AC: 10, 11)
  - [ ] Document rollback plan in deployment runbook
  - [ ] Test feature flag enable/disable functionality
  - [ ] Verify instant disable capability works
  - [ ] Document rollback decision criteria
  - [ ] Test database state after rollback (no corruption)
- [ ] Final Polish and Bug Fixes
  - [ ] Address any remaining issues from QA testing
  - [ ] Polish UI/UX based on feedback
  - [ ] Ensure accessibility compliance (WCAG 2.1 AA)
  - [ ] Update any outdated dependencies
  - [ ] Final code review for quality
- [ ] Production Deployment Preparation
  - [ ] Create deployment checklist
  - [ ] Configure environment variables for production
  - [ ] Test deployment process in staging
  - [ ] Prepare release notes
  - [ ] Schedule deployment window
- [ ] Submit PR (REQUIRED FINAL TASK)
  - [ ] Run final linting: `npm run lint`
  - [ ] Run final tests: `npm test`
  - [ ] Run type checking: `npm run typecheck`
  - [ ] Push branch: `git push -u premium feature/9-9-deployment-polish`
  - [ ] Create PR from feature/9-9-deployment-polish → main
  - [ ] PR Title: "feat: Epic 9 Story 9 - Complete sitemap builder deployment and final polish"
  - [ ] Link PR to this story in description
  - [ ] Include deployment checklist in PR description
  - [ ] Request review from stakeholders

## Dev Notes

### GitFlow Workflow
**CRITICAL: Follow GitFlow strictly for this story**

Branch Name: feature/9-9-deployment-polish
Base Branch: main
PR Target: main

Git Commands:
1. Setup: `git checkout main && git pull premium main`
2. Create feature branch: `git checkout -b feature/9-9-deployment-polish`
3. Commit: Use conventional commits (feat:, fix:, docs:, test:, etc.)
4. Push: `git push -u premium feature/9-9-deployment-polish`
5. PR: Create PR to main branch with title "Epic 9 Story 9: Complete sitemap builder deployment and final polish"

### Testing Standards
**Testing Requirements and Framework Configuration**

Test File Locations:
- Component tests: `lib/premium/components/sitemap/__tests__/`
- Integration tests: `lib/premium/components/sitemap/__integration__/`
- E2E tests: `e2e/premium/sitemap-builder/`
- API tests: `app/api/premium/sitemap/__tests__/`

Testing Frameworks:
- Unit/Component: Jest + React Testing Library
- Integration: Jest with database fixtures
- E2E: Playwright (Chrome, Firefox, Safari, Edge)
- Coverage: Jest coverage reporter with Istanbul

Coverage Requirements:
- **Critical sitemap paths: 70% minimum** (per acceptance criteria)
- Global project requirement: 80% overall
- Components: 80% minimum
- Hooks: 85% minimum
- API endpoints: 90% minimum

Testing Patterns:
- Use testing-library queries (getByRole, getByText, etc.)
- Mock external dependencies with Jest
- Use MSW for API mocking in component tests
- Follow AAA pattern (Arrange, Act, Assert)
- Test user interactions, not implementation details

### Premium Feature Placement Requirements
[Source: docs/epic9-brownfield-prd.md#premium-feature-placement-requirements]

**CRITICAL VERIFICATION**: Ensure all sitemap code remains isolated:
```
✅ CORRECT Premium Locations:
/lib/premium/components/sitemap/       # All sitemap components
/lib/premium/components/globals/       # Global components (hero, header, footer, CTA)
/lib/premium/hooks/                    # Premium hooks
/lib/premium/utils/                    # Premium utilities  
/lib/premium/stores/                   # Zustand store
/app/premium/demo/sitemap-builder/     # Main sitemap UI
/app/api/premium/sitemap/              # API endpoints

❌ FORBIDDEN Locations (will leak to open-source):
/components/                           # Common components only
/lib/ (root)                          # Shared utilities only
/hooks/                               # Shared hooks only
/app/ (root)                          # Public pages only
```

### Testing Infrastructure
[Source: docs/testing-infrastructure.md]

**Test Execution Commands**:
```bash
# Full test suite with coverage
npm run test:coverage

# Performance optimized tests
npm run test:performance  

# Integration tests only
npm run test:integration

# E2E tests
npm run test:e2e

# Coverage analysis
npm run test:coverage:analyze
```

**Coverage Requirements**:
- Global: 80% minimum
- Critical sitemap paths: 70% minimum (AC requirement)
- Components: 80%
- Hooks: 85%

### Performance Benchmarks
[Source: docs/epic9-brownfield-prd.md#performance-requirements]

**Required Metrics**:
- Initial load: <3s for 100-node sitemap
- Drag operations: 60 FPS maintained
- Save operations: <1s completion (after 1s debounce)
- Undo/redo: <100ms operation time

**Testing Approach**:
1. Use Chrome DevTools Performance tab
2. Test with production build (`npm run build`)
3. Profile with 100-node test sitemap
4. Document any performance bottlenecks

### Security Requirements
[Source: docs/epic9-brownfield-prd.md#authentication-authorization-requirements]

**Premium Feature Gating Checklist**:
- [ ] Premium subscription check implemented
- [ ] Session authentication on all API endpoints
- [ ] Rate limiting configured (100 req/min per user)
- [ ] CSRF protection on mutations
- [ ] Input validation via Zod
- [ ] Folders return 404 for security

### Error Tracking Configuration
[Source: docs/epic9-brownfield-prd.md#error-boundary-specifications]

**Sentry Setup** (Recommended):
```javascript
// Install Sentry
npm install @sentry/nextjs

// Configure in sentry.client.config.js
Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
  environment: process.env.NODE_ENV,
  integrations: [
    new Sentry.BrowserTracing(),
  ],
  tracesSampleRate: 0.1, // 10% sampling in production
});
```

### Monitoring and Analytics Configuration
**Monitoring Stack and Dashboard Setup**

Monitoring Platform: Vercel Analytics + Custom Metrics
- Vercel Analytics for web vitals and performance
- Custom events for sitemap-specific metrics
- Integration with Sentry for error correlation

Key Metrics to Track:
- Average sitemap load time by node count
- Save operation success rate (target: >99%)
- API response times (P50, P95, P99)
- Frontend frame rates during drag (target: 60 FPS)
- Error rates by type (target: <1%)
- Feature adoption rate
- Premium conversion after use

Implementation:
```typescript
// lib/premium/utils/analytics.ts
import { track } from '@vercel/analytics';

export const trackSitemapEvent = (event: string, properties?: any) => {
  track(event, {
    feature: 'sitemap-builder',
    ...properties
  });
};

// Usage examples:
trackSitemapEvent('sitemap_loaded', { nodeCount: 100, loadTime: 2500 });
trackSitemapEvent('save_operation', { success: true, duration: 800 });
trackSitemapEvent('drag_performance', { fps: 58, nodeCount: 50 });
```

Dashboard Configuration:
1. Vercel Analytics Dashboard for overall metrics
2. Custom dashboard views for:
   - Sitemap performance metrics
   - User engagement patterns
   - Error rates and types
   - Feature usage statistics

Alert Thresholds:
- Load time > 5 seconds
- Save failure rate > 2%
- Error rate > 5%
- FPS during drag < 30

### Deployment Checklist
[Source: docs/epic9-brownfield-prd.md#appendix-d-deployment-checklist]

**Pre-Deployment**:
- [ ] Database migrations tested
- [ ] Component registry generated
- [ ] Environment variables configured
- [ ] Error tracking enabled
- [ ] Monitoring dashboards ready
- [ ] Rollback procedures documented

**Post-Deployment**:
- [ ] Smoke tests passed
- [ ] Performance metrics normal
- [ ] Error rates acceptable
- [ ] User feedback positive
- [ ] Support team briefed
- [ ] Documentation published

### Feature Flag Implementation
**Feature Flag System for Controlled Rollout**

Implementation Approach:
- Use environment variables for MVP feature flags
- Store flag state in `.env.local` and production environment
- Key: `NEXT_PUBLIC_SITEMAP_BUILDER_ENABLED=true|false`
- Check flag at page load and API endpoint level

Code Implementation:
```typescript
// lib/premium/utils/feature-flags.ts
export const isFeatureEnabled = (feature: string): boolean => {
  switch(feature) {
    case 'sitemap-builder':
      return process.env.NEXT_PUBLIC_SITEMAP_BUILDER_ENABLED === 'true';
    default:
      return false;
  }
};

// Usage in pages/components
if (!isFeatureEnabled('sitemap-builder')) {
  return <FeatureNotAvailable />;
}
```

Rollback Process:
1. Set `NEXT_PUBLIC_SITEMAP_BUILDER_ENABLED=false` in production
2. Redeploy or use runtime config service (if available)
3. Feature becomes immediately unavailable to users
4. No database changes required for rollback

Future Enhancement (Phase 2):
- Integrate with LaunchDarkly or similar service
- User-level feature flags
- A/B testing capabilities
- Gradual percentage rollout

### Rollout Strategy
[Source: docs/epic9-brownfield-prd.md#rollout-strategy]

1. **Alpha**: Internal team testing (current)
2. **Beta**: 5-10 power users  
3. **Staged**: 10% → 25% → 50% → 100%
4. **Feature Flag**: Instant enable/disable capability via environment variable
5. **Premium Gate**: Feature only for premium tier

### Browser Requirements
[Source: docs/epic9-brownfield-prd.md#browser-api-requirements]

**Required Browser APIs**:
- WebGL (React Flow rendering)
- ResizeObserver (responsive layouts)
- Drag and Drop API
- ES6+ JavaScript support

**Supported Browsers**:
- Chrome 90+
- Firefox 88+
- Safari 14+
- Edge 90+
- No IE11 support

### Known Limitations from Previous Stories
[Source: Previous story completion notes]

**From Story 9.5 (Undo/Redo)**:
- Deep copying via JSON.parse/stringify adequate for MVP scale
- Consider Immer for structural sharing if >1000 nodes

**From Story 9.4 (Sitemap Connection)**:
- Save debouncing set to 1 second
- Last-write-wins conflict resolution for MVP
- No real-time collaboration support

## Testing

### Integration Test Requirements
- Test all components work together from stories 9.1-9.8
- Verify database operations (CRUD for pages, folders)
- Test component management within pages
- Verify save/load functionality
- Test undo/redo across all operations
- Verify bulk operations work correctly

### Security Test Requirements
- Test premium subscription gating
- Verify API authentication
- Test rate limiting
- Check CSRF protection
- Validate input sanitization
- Test folder 404 behavior

### Performance Test Requirements
- Load time with 100 nodes
- Frame rate during drag operations
- Save operation timing
- Memory usage over time
- Bundle size optimization

### Manual Testing Checklist
- [ ] Create, edit, delete pages and folders
- [ ] Drag-drop parent changes work
- [ ] Components add/remove properly
- [ ] Undo/redo functions correctly
- [ ] Bulk operations process efficiently
- [ ] Premium gating blocks non-premium users
- [ ] Error tracking captures failures
- [ ] Monitoring shows correct metrics
- [ ] Feature flag enable/disable works
- [ ] Rollback doesn't corrupt data

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-26 | 1.0 | Initial story creation for deployment and final polish | Scrum Master |
| 2025-08-26 | 1.1 | Applied fixes from PO validation: Fixed branch naming to match template, added Testing Standards section, added parent epic reference, clarified coverage requirements, confirmed Sentry/Vercel Analytics tools, added feature flag implementation details | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
_To be filled by development agent_

### Debug Log References
_To be filled during development_

### Completion Notes List
_To be filled upon completion_

### File List
_To be filled with all files created/modified_

## QA Results
_To be filled by QA agent after review_