# Story 9.8: API Security and Premium Gating

## Status
Backlog

## Story
**As a** platform administrator,  
**I want** secure API endpoints with proper premium feature gating,  
**so that** the sitemap builder functionality is protected and only accessible to premium users.

## Acceptance Criteria

1. [ ] All sitemap API endpoints require authenticated session
2. [ ] Premium subscription status is verified on each API call
3. [ ] Non-premium users receive 403 Forbidden responses with upgrade message
4. [ ] API routes are protected through premium folder isolation
5. [ ] Rate limiting is implemented (100 requests per minute per user)
6. [ ] CSRF protection is active on all mutation endpoints
7. [ ] Input validation uses Zod schemas for all endpoints
8. [ ] Error responses include appropriate status codes and messages
9. [ ] Session-based authentication integrates with existing system
10. [ ] Premium status caching reduces database lookups to every 5 minutes

## Tasks / Subtasks

- [ ] Git Setup (REQUIRED FIRST TASK)
  - [ ] Checkout and update main: `git checkout main && git pull premium main`
  - [ ] Create feature branch: `git checkout -b story/EPIC9-008-api-security`
  
- [ ] Create Premium Authentication Middleware (AC: 1, 2, 3)
  - [ ] Create `/lib/premium/middleware/auth.ts` for session verification
  - [ ] Implement premium subscription check function
  - [ ] Add subscription status caching mechanism (5-minute TTL)
  - [ ] Return proper error responses for non-premium users
  
- [ ] Implement API Security Layer (AC: 4, 5, 6)
  - [ ] Create rate limiter middleware in `/lib/premium/middleware/rate-limit.ts`
  - [ ] Add CSRF protection to mutation endpoints
  - [ ] Configure middleware chain for all premium API routes
  - [ ] Ensure premium folder isolation prevents public access
  
- [ ] Add Zod Validation Schemas (AC: 7)
  - [ ] Create `/lib/premium/schemas/sitemap.ts` with validation schemas
  - [ ] Define schemas for save operations
  - [ ] Define schemas for bulk operations
  - [ ] Define schemas for component updates
  - [ ] Add validation middleware to all endpoints
  
- [ ] Update API Endpoints with Security (AC: 1, 2, 4, 8)
  - [ ] Update `/app/api/premium/sitemap/[websiteId]/route.ts` with auth checks
  - [ ] Update `/app/api/premium/sitemap/save/route.ts` with validation and auth
  - [ ] Update `/app/api/premium/sitemap/bulk/route.ts` with security layers
  - [ ] Update `/app/api/premium/sitemap/[nodeId]/components/route.ts`
  - [ ] Add proper error responses with status codes
  
- [ ] Integrate with Existing Session System (AC: 9)
  - [ ] Connect to existing authentication service
  - [ ] Use session-based user context
  - [ ] Ensure compatibility with current auth patterns
  - [ ] Test session expiration handling
  
- [ ] Create Security Error Handling (AC: 8)
  - [ ] Define error response format
  - [ ] Implement consistent error messages
  - [ ] Add logging for security events
  - [ ] Create user-friendly upgrade messages for non-premium users
  
- [ ] Testing
  - [ ] Write unit tests for authentication middleware
  - [ ] Write unit tests for rate limiting
  - [ ] Write integration tests for secured endpoints
  - [ ] Test premium/non-premium access scenarios
  - [ ] Verify CSRF protection works
  - [ ] Test input validation with invalid data
  
- [ ] Documentation
  - [ ] Document API security architecture
  - [ ] Create security checklist for future endpoints
  - [ ] Update API documentation with auth requirements
  - [ ] Document rate limiting and caching strategies
  
- [ ] Submit PR (REQUIRED FINAL TASK)
  - [ ] Push branch: `git push -u premium story/EPIC9-008-api-security`
  - [ ] Create PR from feature branch â†’ main branch
  - [ ] PR Title: "feat(EPIC9-008): implement API security and premium gating"
  - [ ] Link PR to story in description
  - [ ] Ensure all tests pass
  - [ ] Request security review

## Dev Notes

### GitFlow Workflow
Branch Name: story/EPIC9-008-api-security
Base Branch: main
PR Target: main

Git Commands:
1. Setup: `git checkout main && git pull premium main`
2. Create: `git checkout -b story/EPIC9-008-api-security`
3. Commit: Use conventional commits (feat:, fix:, docs:, etc.)
4. Push: `git push -u premium story/EPIC9-008-api-security`
5. PR: Create PR to main branch with title "feat(EPIC9-008): implement API security and premium gating"

### Critical Implementation Details

#### Premium Feature Isolation
**MANDATORY**: All code MUST be placed under premium directories:
- `/lib/premium/middleware/` - Security middleware
- `/lib/premium/schemas/` - Validation schemas
- `/app/api/premium/sitemap/` - API endpoints (safe because entire `/app/premium/` removed during sync)

**Security Note**: The `/app/api/premium/` path is protected through folder isolation. When the GitHub Action syncs to the public repository, the entire `/app/premium/` directory (including `/app/api/premium/`) is removed, ensuring these endpoints don't exist in the open-source version.

#### Authentication Requirements (from PRD Section 3.2)
```typescript
// Premium Feature Gating Pattern
async function requirePremium(request: Request) {
  const session = await getSession(request)
  if (!session?.user) {
    return new Response('Unauthorized', { status: 401 })
  }
  
  const isPremium = await checkPremiumStatus(session.user.id)
  if (!isPremium) {
    return new Response(JSON.stringify({
      error: 'Premium subscription required',
      upgradeUrl: '/upgrade'
    }), { status: 403 })
  }
  
  return null // Continue to endpoint
}
```

#### Rate Limiting Implementation
```typescript
// Rate limiter configuration
const rateLimiter = {
  windowMs: 60 * 1000, // 1 minute
  max: 100, // 100 requests per minute
  message: 'Too many requests, please try again later'
}
```

#### Validation Schema Example
```typescript
// Example from implementation guide
const saveSchema = z.object({
  changes: z.array(z.object({
    type: z.enum(['CREATE_NODE', 'UPDATE_NODE', 'DELETE_NODE', 'MOVE_NODE']),
    id: z.string().optional(),
    data: z.record(z.any()).optional(),
    newParentId: z.string().optional()
  }))
})
```

#### Error Response Format
```typescript
interface ErrorResponse {
  error: string
  code?: string
  details?: any
  upgradeUrl?: string // For premium-required errors
}
```

### Security Checklist
- [ ] Session authentication on all endpoints
- [ ] Premium status verification
- [ ] Rate limiting active
- [ ] CSRF protection on mutations
- [ ] Input validation via Zod
- [ ] Proper error codes (401, 403, 400, 500)
- [ ] Security event logging
- [ ] No sensitive data in responses

### Testing Standards
- Test files location: `__tests__/premium/security/`
- Use Jest for unit tests
- Use Supertest for API endpoint testing
- Mock session and premium status for tests
- Test both success and failure paths
- Verify security boundaries

### Dependencies
- Existing session management system
- User subscription status in database
- Zod for validation (already in project)
- Next.js middleware capabilities

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-26 | 1.0 | Initial story creation for API security | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_