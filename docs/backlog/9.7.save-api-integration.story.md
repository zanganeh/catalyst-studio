# Story 9.7: Save Manager & API Integration

## Status
Backlog

## Story
**As a** sitemap builder user,
**I want** my changes to be automatically saved to the database with retry logic,
**so that** I don't lose work due to network issues and can trust that my changes persist.

## Acceptance Criteria
1. SaveManager collects and batches all sitemap changes (create, update, delete, move nodes)
2. Changes are debounced for 1 second before saving to reduce API calls
3. Save requests use transactional processing to ensure data integrity
4. Failed saves automatically retry with exponential backoff (2s, 4s, 6s)
5. After 3 failed retries, user sees error with manual retry option
6. Visual save status indicator shows: idle, saving, saved, error states
7. Optimistic UI updates happen immediately while save processes in background
8. API endpoints validate websiteId ownership before processing changes
9. All database operations use Epic 8's existing services (SiteStructureService, ContentItemService)
10. Save operations complete within 1 second for typical changes (< 10 operations)
11. Bulk operations (> 10 changes) are processed efficiently in single transaction
12. Network failures don't cause data loss (changes queued for retry)

## Tasks / Subtasks
- [ ] Git Setup (REQUIRED FIRST TASK)
  - [ ] Checkout and update main: `git checkout main && git pull premium main`
  - [ ] Create story branch from main: `git checkout -b story/EPIC9-007-save-api-integration`
- [ ] Create SaveManager Class (AC: 1, 2, 3)
  - [ ] Create `/lib/premium/components/sitemap/save-manager.ts`
  - [ ] Implement change queuing system with Change type interface
  - [ ] Add debounced save logic (1 second timeout)
  - [ ] Implement batch processing of multiple changes
- [ ] Implement Retry Logic (AC: 4, 5, 12)
  - [ ] Add exponential backoff retry mechanism (2s, 4s, 6s)
  - [ ] Track retry attempt count
  - [ ] Implement manual retry trigger after 3 failures
  - [ ] Preserve changes during retry attempts
- [ ] Create API Endpoints (AC: 8, 9)
  - [ ] Create GET endpoint at `/app/api/premium/sitemap/[websiteId]/route.ts`
  - [ ] Create POST save endpoint at `/app/api/premium/sitemap/save/route.ts`
  - [ ] Add websiteId ownership validation middleware
  - [ ] Use Zod for input validation on all endpoints
- [ ] Implement GET Sitemap Endpoint (AC: 9)
  - [ ] Use Epic 8's SiteStructureService.getTree()
  - [ ] Transform tree structure to React Flow nodes/edges format
  - [ ] Include component data from ContentItemService
  - [ ] Return proper error responses for unauthorized access
- [ ] Implement POST Save Endpoint (AC: 3, 9, 10, 11)
  - [ ] Process change operations in Prisma transaction
  - [ ] Handle CREATE_NODE operations via SiteStructureService
  - [ ] Handle UPDATE_NODE operations via ContentItemService
  - [ ] Handle DELETE_NODE with cascade via SiteStructureService
  - [ ] Handle MOVE_NODE parent changes via SiteStructureService
  - [ ] Return success/error response with timestamp
- [ ] Add Save Status UI (AC: 6, 7)
  - [ ] Create save status indicator component
  - [ ] Show states: idle, saving (spinner), saved (checkmark), error (X)
  - [ ] Position indicator in toolbar or corner of canvas
  - [ ] Add CSS transitions for smooth status changes
- [ ] Integrate SaveManager with Zustand Store (AC: 1, 7)
  - [ ] Connect SaveManager to store's node/edge change events
  - [ ] Implement optimistic UI updates (immediate visual, background save)
  - [ ] Handle rollback on save failure
  - [ ] Update save status in store for UI indicator
- [ ] Add Error Handling (AC: 5, 12)
  - [ ] Create error notification component
  - [ ] Show user-friendly error messages
  - [ ] Provide manual retry button in error state
  - [ ] Log errors for debugging
- [ ] Testing (AC: All)
  - [ ] Test debounced saving with rapid changes
  - [ ] Test retry logic with simulated network failures
  - [ ] Test transaction rollback on partial failures
  - [ ] Test authorization checks
  - [ ] Test save status indicator states
  - [ ] Load test with 100+ node changes
- [ ] Submit PR (REQUIRED FINAL TASK)
  - [ ] Push branch: `git push -u premium story/EPIC9-007-save-api-integration`
  - [ ] Create PR from story branch â†’ main branch
  - [ ] PR Title: "Epic 9 Story 9.7: Save Manager & API Integration"
  - [ ] Link PR to story in description
  - [ ] Ensure all tests pass and no linting errors

## Dev Notes

### GitFlow Workflow
Branch Name: story/EPIC9-007-save-api-integration
Base Branch: main
PR Target: main

Git Commands:
1. Setup: `git checkout main && git pull premium main`
2. Create: `git checkout -b story/EPIC9-007-save-api-integration`
3. Commit: Use conventional commits (feat:, fix:, docs:, etc.)
4. Push: `git push -u premium story/EPIC9-007-save-api-integration`
5. PR: Create PR to main branch with title "Epic 9 Story 9.7: Save Manager & API Integration"

### Previous Story Context (from 9.5 Undo/Redo)
- UndoManager exists at `/lib/premium/components/sitemap/undo-manager.ts`
- Zustand store manages sitemap state at `/app/premium/demo/sitemap-builder/hooks/use-sitemap-store.ts`
- Important: SaveManager should NOT trigger saves during undo/redo operations
- Check `isUndoing` flag in store before queuing changes

### File Locations
All premium features must be placed under premium directories:
- SaveManager: `/lib/premium/components/sitemap/save-manager.ts`
- API Routes: `/app/api/premium/sitemap/` (safe under premium path)
- Transform utilities already exist at: `/app/premium/demo/sitemap-builder/utils/transform.ts`
- Zustand store: `/app/premium/demo/sitemap-builder/hooks/use-sitemap-store.ts`

### API Implementation Details
[Source: epic9-implementation-guide.md]

#### SaveManager Class Structure
```typescript
export class SaveManager {
  private pendingChanges: Change[] = []
  private saveTimeout: NodeJS.Timeout
  private retryCount = 0
  private maxRetries = 3
  
  addChange(change: Change) {
    this.pendingChanges.push(change)
    this.debounceSave()
  }
  
  private debounceSave() {
    clearTimeout(this.saveTimeout)
    this.saveTimeout = setTimeout(() => this.save(), 1000)
  }
  
  private async save() {
    // Implementation with retry logic
  }
}
```

#### Change Operation Types
```typescript
type Change = 
  | { type: 'CREATE_NODE'; parentId: string; data: NodeData }
  | { type: 'UPDATE_NODE'; nodeId: string; data: Partial<NodeData> }
  | { type: 'DELETE_NODE'; nodeId: string }
  | { type: 'MOVE_NODE'; nodeId: string; newParentId: string }
```

#### API Response Formats
GET Response:
```json
{
  "nodes": [...],
  "edges": [...]
}
```

POST Save Response:
```json
{
  "success": true,
  "savedAt": "2024-01-20T10:00:00Z",
  "processedChanges": 5
}
```

### Epic 8 Services to Use
[Source: epic9-brownfield-architecture.md#12.1]
- **SiteStructureService**: Handle all tree operations (getTree, createNode, deleteNode, moveNode)
- **ContentItemService**: Manage page content and components
- **ContentTypeService**: Manage page/folder type definitions
- No new services needed - Epic 8 services handle everything

### Database Transaction Requirements
[Source: epic9-implementation-guide.md#2.3]
- All save operations must use Prisma transactions
- Process operations in correct order: DELETE before CREATE
- Rollback entire batch if any operation fails
- Use `prisma.$transaction()` for atomicity

### Performance Requirements
- Save operations must complete within 1 second for < 10 changes
- Debounce timeout: 1000ms
- Retry delays: 2s, 4s, 6s (exponential backoff)
- Support up to 100 nodes without significant degradation

### Testing Standards
- Test files location: `__tests__/` directory adjacent to implementation files
- Use Vitest for unit tests
- Mock Prisma client and Epic 8 services in tests
- Test coverage target: Core save/retry logic must have 100% coverage
- Integration tests should simulate network failures

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-01-26 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
(To be filled by Dev Agent)

### Debug Log References
(To be filled by Dev Agent)

### Completion Notes List
(To be filled by Dev Agent)

### File List
(To be filled by Dev Agent)

## QA Results
(To be filled by QA Agent)