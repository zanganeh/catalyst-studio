# Story 9.6: Add Bulk Operations Support

## Status
Backlog

## Story
**As a** sitemap builder user,
**I want** to select multiple nodes and perform bulk operations on them,
**so that** I can efficiently manage large sitemaps without repetitive individual actions.

## Acceptance Criteria
1. Multi-select works via Shift+Click on nodes in the canvas
2. Multi-select works via drag-to-select area selection (lasso/box selection)
3. Selected nodes have clear visual indication (highlight or border)
4. Bulk delete operation available with confirmation dialog
5. Bulk status change operations available (draft/published/archived)
6. Best-effort processing - operations continue even if some items fail
7. Clear feedback shows which operations succeeded and which failed
8. Selection clears after successful bulk operation
9. Keyboard shortcut Ctrl+A/Cmd+A selects all nodes
10. Escape key clears current selection
11. Selected count displays in UI when multiple nodes selected
12. Undo operation reverts entire bulk operation as single action

## Tasks / Subtasks
- [ ] Git Setup (REQUIRED FIRST TASK)
  - [ ] Checkout and update main: `git checkout main && git pull origin main`
  - [ ] Create story branch from main: `git checkout -b story/EPIC9-006-bulk-operations`
- [ ] Implement Multi-Select in Zustand Store (AC: 1, 2, 8, 9, 10)
  - [ ] Add `selectedNodes` array to store state (already exists)
  - [ ] Create `toggleNodeSelection(nodeId, isShiftKey)` action
  - [ ] Create `selectNodesInArea(area)` action for box selection
  - [ ] Create `selectAllNodes()` action for Ctrl+A
  - [ ] Create `clearSelection()` action (already exists)
  - [ ] Update selection logic to handle Shift+Click multi-select
  - [ ] Test multi-select state management
- [ ] Add Visual Selection Feedback (AC: 3, 11)
  - [ ] Update node component in `/lib/premium/components/sitemap/` to show selection state
  - [ ] Add selected styling (border, background, or outline)
  - [ ] Create selection count display component
  - [ ] Position selection count in toolbar or status bar
  - [ ] Test visual feedback with various node counts
- [ ] Implement Area Selection (Lasso) (AC: 2)
  - [ ] Add mouse event handlers:
    - [ ] Detect mousedown on canvas background (not on nodes)
    - [ ] Track mousemove with drag state
    - [ ] Handle mouseup to complete selection
    - [ ] Handle mouse leave canvas edge case
  - [ ] Draw selection rectangle:
    - [ ] Create SelectionBox component with absolute positioning
    - [ ] Calculate rectangle dimensions from start/current mouse positions
    - [ ] Apply visual styling (dashed border, semi-transparent fill)
    - [ ] Clean up rectangle on selection complete
  - [ ] Calculate node intersection:
    - [ ] Get all node positions from React Flow instance
    - [ ] Implement rectangle-rectangle intersection algorithm
    - [ ] Handle partially overlapping nodes (include if center is within)
  - [ ] Update store with selection:
    - [ ] Call store.selectNodesInArea() with node IDs
    - [ ] Clear previous selection if not holding Shift
    - [ ] Add to selection if Shift is held
  - [ ] Test edge cases:
    - [ ] Selection from right-to-left
    - [ ] Selection from bottom-to-top
    - [ ] Very small selection areas
    - [ ] Selection during zoom/pan
- [ ] Create Bulk Operations API Endpoint (AC: 4, 5, 6, 7)
  - [ ] Create `/app/api/premium/sitemap/bulk/route.ts`
  - [ ] Implement POST handler:
    - [ ] Parse and validate request body with Zod
    - [ ] Support operation types (DELETE, UPDATE_STATUS)
    - [ ] Validate batch size (max 100 items for performance)
  - [ ] Use best-effort processing:
    - [ ] Process each item in try-catch block
    - [ ] Continue on individual failures
    - [ ] Track success/failure for each item
  - [ ] Return detailed results: `{ succeeded: [], failed: [] }`
  - [ ] Add basic logging:
    - [ ] Log operation start with item count
    - [ ] Log individual failures with reasons
    - [ ] Log final summary
  - [ ] Test with various failure scenarios:
    - [ ] Invalid node IDs in batch
    - [ ] Database connection failures mid-operation
    - [ ] Non-existent nodes
- [ ] Add Bulk Operations UI Components (AC: 4, 5, 7)
  - [ ] Create BulkOperationsToolbar component in `/lib/premium/components/sitemap/`
  - [ ] Show toolbar only when multiple nodes selected
  - [ ] Add "Delete Selected" button with confirmation dialog
  - [ ] Add "Change Status" dropdown for bulk status updates
  - [ ] Display operation results (success/failure counts)
  - [ ] Test UI with various selection sizes
- [ ] Integrate Bulk Delete Operation (AC: 4, 6, 7, 8)
  - [ ] Connect delete button to bulk API endpoint
  - [ ] Show confirmation dialog with selected count
  - [ ] Call `/api/premium/sitemap/bulk` with DELETE operation
  - [ ] Update store to remove succeeded nodes
  - [ ] Show error for failed deletions
  - [ ] Clear selection after operation
  - [ ] Test with mixed success/failure scenarios
- [ ] Integrate Bulk Status Change (AC: 5, 6, 7, 8)
  - [ ] Add status dropdown (draft/published/archived)
  - [ ] Call `/api/premium/sitemap/bulk` with UPDATE_STATUS operation
  - [ ] Update store for succeeded status changes
  - [ ] Show summary of results
  - [ ] Clear selection after operation
  - [ ] Test status changes with permissions
- [ ] Add Keyboard Shortcuts (AC: 9, 10)
  - [ ] Create `useKeyboardShortcuts` hook in `/lib/premium/hooks/`
  - [ ] Implement Ctrl+A/Cmd+A for select all
  - [ ] Implement Escape for clear selection
  - [ ] Integrate with existing keyboard handlers
  - [ ] Test on Windows/Mac/Linux
- [ ] Integrate with Undo System (AC: 12)
  - [ ] Capture state before bulk operations
  - [ ] Store entire bulk operation as single undo action
  - [ ] Ensure undo reverts all changes from bulk operation
  - [ ] Test undo/redo with bulk operations
- [ ] Testing & Error Handling
  - [ ] Test multi-select with 10, 50, 100 nodes
  - [ ] Test bulk operations with partial failures
  - [ ] Test selection persistence during operations
  - [ ] Test keyboard shortcuts across browsers
  - [ ] Add error boundaries for bulk operation failures
  - [ ] Verify no memory leaks with large selections
- [ ] Submit PR (REQUIRED FINAL TASK)
  - [ ] Run linting: `npm run lint`
  - [ ] Run type checking: `npm run typecheck`
  - [ ] Run tests: `npm test`
  - [ ] Verify test coverage: `npm run test:coverage`
  - [ ] Push branch: `git push -u origin story/EPIC9-006-bulk-operations`
  - [ ] Create PR from story branch â†’ main branch
  - [ ] PR Title: "feat(EPIC9-006): Add bulk operations support for sitemap builder"
  - [ ] Link PR to this story in description
  - [ ] Include screenshots of multi-select and bulk operations

## Dev Notes

### GitFlow Workflow
Branch Name: story/EPIC9-006-bulk-operations
Base Branch: main
PR Target: main

Git Commands:
1. Setup: `git checkout main && git pull origin main`
2. Create: `git checkout -b story/EPIC9-006-bulk-operations`
3. Commit: Use conventional commits (feat:, fix:, docs:, etc.)
4. Push: `git push -u origin story/EPIC9-006-bulk-operations`
5. PR: Create PR to main branch with title "feat(EPIC9-006): Add bulk operations support for sitemap builder"

### Testing Standards
**Testing Framework**: Jest is configured for this project

**Test Commands**:
- `npm test` - Run all tests
- `npm run test:unit` - Run unit tests only
- `npm run test:coverage` - Run tests with coverage report
- `npm run test:watch` - Run tests in watch mode

**Test File Locations**:
- Unit tests: Create in `__tests__` directory adjacent to component
- Integration tests: Place in `integration` directory
- E2E tests: Use Playwright (`npm run test:e2e`)

**Test Coverage Requirements**:
- Minimum 80% code coverage for new components
- All critical paths must have unit tests
- Bulk operations API must have integration tests

**Test Scenarios for This Story**:
1. **Unit Tests** (required):
   - Zustand store multi-select actions
   - Area selection calculation logic
   - Bulk operation response parsing
   
2. **Integration Tests** (required):
   - Bulk API endpoint with various payloads
   - Permission checking for bulk operations
   - Best-effort processing logic

3. **Manual Testing** (required before PR):
   - Multi-select with 10, 50, 100 nodes
   - Bulk operations with partial failures
   - Keyboard shortcuts across OS/browsers
   - Performance validation (< 100ms selection, < 3s bulk ops)
   - Memory usage with large selections

### Previous Story Context
From Story 9.5 (Undo/Redo):
- UndoManager is fully integrated with Zustand store at `/lib/premium/components/sitemap/undo-manager.ts`
- Store already has `captureState()` method that pushes snapshots to undoManager
- All mutations (addNode, updateNode, deleteNodes, moveNode) already capture state
- SaveManager prevents saves during undo/redo operations

From Story 9.4 (Sitemap Connection):
- Zustand store exists at `/lib/premium/stores/sitemap-store.ts`
- Store has `selectedNodes: string[]` array already defined
- Store has `clearSelection()` method already implemented
- Basic node operations (add, update, delete, move) are working

### Technical Implementation Details

#### Store State Structure
The Zustand store at `/lib/premium/stores/sitemap-store.ts` already has:
- `selectedNodes` array for tracking multiple selected nodes
- `clearSelection()` method for clearing selections
- Basic node operations (add, update, delete, move) already working

#### API Endpoint Requirements
- Create bulk operations endpoint at `/app/api/premium/sitemap/bulk/route.ts`
- Endpoint URL will be `/api/premium/sitemap/bulk`
- Must be placed under `/app/api/premium/` directory for premium feature isolation

#### Bulk Operations Request Format
The API should accept POST requests with:
- `operation` field: Either "DELETE", "UPDATE_STATUS", or "MOVE"
- `ids` field: Array of node IDs to process
- `data` field: Optional data specific to the operation type (like new status for UPDATE_STATUS)

#### Bulk Operations Response Format
The API should return:
- `succeeded` array: IDs of nodes that were successfully processed
- `failed` array: Objects with node ID and error message for each failure

#### MVP Implementation Notes
For the MVP, we're keeping it simple:
- No authentication or authorization checks needed
- No rate limiting required
- No CSRF protection required
- No permission checks on individual items
- Basic input validation using Zod for request structure
- Batch size limit of 100 items for performance reasons only
- Simple logging for debugging purposes

#### Area Selection Implementation Guide

**Drag-to-Select (Lasso) Feature Requirements:**
- Detect mouse down on canvas background (not on nodes) to start selection
- Track mouse movement to draw selection rectangle
- Visual selection box with dashed border and semi-transparent fill
- Calculate which nodes fall within the selection rectangle
- Use node center point to determine if node is selected
- Handle edge cases: selection from any direction, mouse leaving canvas
- Clear selection box when mouse is released
- Update store with selected node IDs using `selectNodesInArea()` action

**Visual Selection Box Styling:**
- Dashed border (2px, color: #4A90E2)
- Semi-transparent blue fill (rgba(74, 144, 226, 0.1))
- Positioned absolutely over the canvas
- High z-index to appear above nodes
- Pointer events disabled to not interfere with selection

#### Best-Effort Processing Approach [Source: epic9-brownfield-prd.md#FR-007]
- Process items individually, not in transaction
- Continue processing even if some fail
- Track success/failure per item
- Return detailed results for each operation
- Allow partial success scenarios

#### Visual Selection Requirements [Source: epic9-brownfield-prd.md#NFR-011]
- Clear visual feedback for all operations
- Selected nodes need distinct styling
- Selection count should be visible
- Consider accessibility (WCAG 2.1 AA compliance)

#### Performance Requirements

**Performance Targets**:
- Selection operations should complete in under 100ms for up to 100 nodes
- Bulk API operations should complete within 3 seconds for 100 nodes
- UI should maintain 60 FPS during drag selection

**Performance Testing Approach**:
- Use browser DevTools Performance tab to measure selection response times
- Monitor frame rate during drag operations using DevTools FPS meter
- Test with varying node counts: 10, 50, and 100 nodes
- Use browser memory profiler to check for memory leaks with large selections
- Log operation durations in development mode for analysis
- Alert developers if performance targets are not met

#### Performance Considerations [Source: epic9-brownfield-prd.md#NFR-002]
- System should handle ~100 nodes acceptably
- Bulk operations on 100 nodes should complete within reasonable time
- Implement performance monitoring to catch regressions early

#### File Placement Rules [Source: CLAUDE.md & epic9-implementation-guide.md]
- All components must be under `/lib/premium/components/sitemap/`
- API routes must be under `/app/api/premium/`
- Hooks must be under `/lib/premium/hooks/`
- NEVER place code in root `/components/` or `/lib/` directories

### Testing Standards
- No specific testing framework mentioned in architecture docs
- Focus on manual testing for MVP
- Test scenarios should cover:
  - Multi-select with various node counts (10, 50, 100)
  - Partial failure scenarios
  - Keyboard shortcuts on different OS
  - Memory usage with large selections

### Dependencies
- React Flow (v11.10.1) - already integrated
- Zustand store - already set up
- Existing UndoManager - for history integration
- Existing SaveManager - coordinates with save operations

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-26 | 1.0 | Initial story creation | Scrum Master (Bob) |
| 2025-08-26 | 1.1 | Fixed Git workflow, added testing standards, security considerations, improved task granularity per PO validation | Scrum Master (Bob) |
| 2025-08-26 | 1.2 | Applied PO validation fixes: corrected git remote to origin, added Jest testing details with commands, added concrete security implementation code, added React Flow area selection implementation guide, added performance measurement utilities | Scrum Master (Bob) |
| 2025-08-26 | 1.3 | Simplified for MVP: removed all auth/authorization/rate limiting/CSRF/permissions, removed code examples per user request, kept descriptive implementation guidance only | Scrum Master (Bob) |
| 2025-08-26 | 1.4 | Moved to Backlog - determined to be too much scope for current sprint | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
[To be filled by Dev Agent]

### Debug Log References
[To be filled by Dev Agent]

### Completion Notes List
[To be filled by Dev Agent]

### File List
[To be filled by Dev Agent]

## QA Results
[To be filled by QA Agent]